{% extends 'base_with_navbar.html' %}
{% load static %}

{% block title %}Calendar - Workspace{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'calendar/ui/css/calendar.css' %}" />
<link rel="stylesheet" href="{% static 'calendar/ui/css/polls.css' %}" />
{% endblock %}

{% block navbar %}
{% include 'ui/partials/navbar.html' with navbar_full_width=True %}
{% endblock %}

{% block drawer_class %}drawer-open{% endblock %}
{% block drawer_id %}calendar-drawer{% endblock %}
{% block drawer_attrs %}x-data="calendarApp({{ calendars_json }})" @calendar-member-selected.window="addMember($event)" @keydown.window="handleKeydown($event)"{% endblock %}

{% block main_class %}p-0 flex flex-col h-full overflow-hidden{% endblock %}

{% block drawer_sidebar %}
<div class="drawer-side z-40 h-full">
  <label for="calendar-drawer" aria-label="close sidebar" class="drawer-overlay"></label>

  <aside class="bg-base-200 h-full border-r border-base-300 flex flex-col transition-all duration-300"
         :class="collapsed ? 'w-16' : 'w-72'">

    <!-- Header -->
    <div class="border-b border-base-300 py-4 px-3">
      <div class="flex items-center" :class="collapsed ? 'justify-center' : 'justify-between'">
        <h2 class="text-xl font-semibold flex items-center gap-2" :class="collapsed ? '' : 'pl-2'">
          <i data-lucide="calendar" class="w-6 h-6 text-accent"></i>
          <span x-show="!collapsed" x-transition>Calendar</span>
        </h2>
        <div x-show="!collapsed" x-transition class="flex items-center gap-0.5">
          <button type="button" class="btn btn-ghost btn-sm hover:text-accent" @click="calendarToday()">Today</button>
          <div class="dropdown dropdown-end">
            <button type="button" tabindex="0" class="btn btn-ghost btn-sm btn-square hover:text-accent" title="Settings">
              <i data-lucide="settings" class="w-4 h-4"></i>
            </button>
            <div tabindex="0" class="dropdown-content z-50 bg-base-100 rounded-box shadow-lg ring-1 ring-base-300 p-4 w-64 mt-1">
              <h4 class="font-semibold text-sm mb-3 flex items-center gap-2">
                <i data-lucide="settings" class="w-4 h-4 text-accent"></i>
                Preferences
              </h4>
              <div class="space-y-3">
                <!-- Default view -->
                <div>
                  <label class="text-sm text-base-content/60 block mb-1">Default view</label>
                  <select class="select select-bordered select-sm w-full"
                    :value="prefs.defaultView"
                    @change="updatePref('defaultView', $event.target.value)">
                    <option value="dayGridMonth">Month</option>
                    <option value="timeGridWeek">Week</option>
                    <option value="timeGridDay">Day</option>
                    <option value="listWeek">Agenda</option>
                  </select>
                </div>
                <hr class="border-base-300">
                <!-- First day of week -->
                <div>
                  <label class="text-sm text-base-content/60 block mb-1">First day of week</label>
                  <select class="select select-bordered select-sm w-full"
                    :value="prefs.firstDay"
                    @change="updatePref('firstDay', parseInt($event.target.value))">
                    <option value="1">Monday</option>
                    <option value="0">Sunday</option>
                    <option value="6">Saturday</option>
                  </select>
                </div>
                <hr class="border-base-300">
                <!-- Time format -->
                <div>
                  <label class="text-sm text-base-content/60 block mb-1">Time format</label>
                  <select class="select select-bordered select-sm w-full"
                    :value="prefs.timeFormat"
                    @change="updatePref('timeFormat', $event.target.value)">
                    <option value="24h">24h (14:00)</option>
                    <option value="12h">12h (2:00 PM)</option>
                  </select>
                </div>
                <hr class="border-base-300">
                <!-- Week numbers -->
                <label class="flex items-center justify-between gap-2 cursor-pointer">
                  <span class="text-sm">Show week numbers</span>
                  <input type="checkbox" class="toggle toggle-sm toggle-accent"
                    :checked="prefs.weekNumbers"
                    @change="updatePref('weekNumbers', $event.target.checked)">
                </label>
                <!-- Default all day -->
                <label class="flex items-center justify-between gap-2 cursor-pointer">
                  <span class="text-sm">Default to all day</span>
                  <input type="checkbox" class="toggle toggle-sm toggle-accent"
                    :checked="prefs.defaultAllDay"
                    @change="updatePref('defaultAllDay', $event.target.checked)">
                </label>
                <!-- Show declined events -->
                <label class="flex items-center justify-between gap-2 cursor-pointer">
                  <span class="text-sm">Show declined events</span>
                  <input type="checkbox" class="toggle toggle-sm toggle-accent"
                    :checked="prefs.showDeclined"
                    @change="updatePref('showDeclined', $event.target.checked)">
                </label>
                <hr class="border-base-300">
                <!-- Max events per day -->
                <div>
                  <label class="text-sm text-base-content/60 block mb-1">Max events per day</label>
                  <div class="flex items-center gap-2">
                    <input type="range" min="2" max="8" step="1"
                      class="range range-sm range-accent flex-1"
                      :value="prefs.dayMaxEvents"
                      @input="updatePref('dayMaxEvents', parseInt($event.target.value))">
                    <span class="text-sm font-mono w-5 text-center" x-text="prefs.dayMaxEvents"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- View controls (hidden when collapsed) -->
    <div class="border-b border-base-300 overflow-hidden transition-all duration-200"
         :class="collapsed ? 'max-h-0 py-0 opacity-0 border-b-0' : 'max-h-40 opacity-100 py-3 px-3'">
      <!-- Navigation: prev / period title / next -->
      <div class="flex items-center justify-between mb-2">
        <button type="button" class="btn btn-ghost btn-xs btn-square" @click="calendarPrev()" title="Previous">
          <i data-lucide="chevron-left" class="w-4 h-4"></i>
        </button>
        <span class="text-sm font-semibold text-base-content truncate" x-text="currentTitle"></span>
        <button type="button" class="btn btn-ghost btn-xs btn-square" @click="calendarNext()" title="Next">
          <i data-lucide="chevron-right" class="w-4 h-4"></i>
        </button>
      </div>
      <!-- View mode -->
      <div class="flex gap-1 mb-2">
        <button type="button" class="btn btn-xs flex-1"
                :class="currentView === 'dayGridMonth' ? 'btn-primary' : 'btn-ghost'"
                @click="changeView('dayGridMonth')">Month</button>
        <button type="button" class="btn btn-xs flex-1"
                :class="currentView === 'timeGridWeek' ? 'btn-primary' : 'btn-ghost'"
                @click="changeView('timeGridWeek')">Week</button>
        <button type="button" class="btn btn-xs flex-1"
                :class="currentView === 'timeGridDay' ? 'btn-primary' : 'btn-ghost'"
                @click="changeView('timeGridDay')">Day</button>
        <button type="button" class="btn btn-xs flex-1"
                :class="currentView === 'listWeek' ? 'btn-primary' : 'btn-ghost'"
                @click="changeView('listWeek')">Agenda</button>
      </div>
    </div>

    <!-- Calendar lists (scrollable) -->
    <div class="flex-1 overflow-y-auto py-4 px-3">

      <!-- My Calendars -->
      <div class="flex items-center justify-between overflow-hidden transition-all duration-200"
           :class="collapsed ? 'max-h-0 mb-0 opacity-0' : 'max-h-6 mb-3 opacity-100'">
        <h3 class="text-sm font-semibold text-base-content/60 uppercase tracking-wider">
          <span class="flex items-center gap-2">
            <i data-lucide="user" class="w-3 h-3"></i>
            My calendars
          </span>
        </h3>
        <button type="button" class="btn btn-ghost btn-xs btn-square" @click="createCalendar()" title="New calendar">
          <i data-lucide="plus" class="w-3 h-3"></i>
        </button>
      </div>

      <ul class="space-y-1 mb-4">
        <template x-for="cal in ownedCalendars" :key="cal.uuid">
          <li class="flex items-center gap-2 p-1.5 rounded-lg text-sm hover:bg-base-content/5 group cursor-pointer"
              :class="collapsed ? 'justify-center' : ''">
            <span class="flex-shrink-0 w-5 h-5 flex items-center justify-center"
                  :class="'text-' + cal.color"
                  :title="collapsed ? cal.name : ''">
              <i data-lucide="calendar" class="w-4 h-4"></i>
            </span>
            <span x-show="!collapsed" x-transition class="flex-1 truncate" x-text="cal.name"></span>
            <div x-show="!collapsed" class="flex items-center gap-0.5">
              <div class="opacity-0 group-hover:opacity-100 flex gap-0.5">
                <button type="button" class="btn btn-ghost btn-xs btn-square" @click.stop="editCalendar(cal)" title="Edit">
                  <i data-lucide="pencil" class="w-3 h-3"></i>
                </button>
                <button type="button" class="btn btn-ghost btn-xs btn-square" @click.stop="deleteCalendar(cal)" title="Delete">
                  <i data-lucide="trash-2" class="w-3 h-3"></i>
                </button>
              </div>
              <input type="checkbox" class="checkbox checkbox-xs"
                     :class="'checkbox-' + cal.color"
                     :checked="visibleCalendars[cal.uuid]"
                     @change="toggleCalendarVisibility(cal.uuid)">
            </div>
          </li>
        </template>
        <li x-show="ownedCalendars.length === 0 && !collapsed"
            class="text-xs text-base-content/40 px-1.5 py-1">
          No calendars yet
        </li>
      </ul>

      <!-- Other Calendars (subscribed) -->
      <template x-if="subscribedCalendars.length > 0">
        <div>
          <hr class="mb-3 border-base-300 transition-all duration-200"
              :class="collapsed ? 'opacity-0' : 'opacity-100'">
          <h3 class="text-sm font-semibold text-base-content/60 uppercase tracking-wider overflow-hidden transition-all duration-200"
              :class="collapsed ? 'max-h-0 mb-0 opacity-0' : 'max-h-6 mb-3 opacity-100'">
            <span class="flex items-center gap-2">
              <i data-lucide="users" class="w-3 h-3"></i>
              Other calendars
            </span>
          </h3>
          <ul class="space-y-1">
            <template x-for="cal in subscribedCalendars" :key="cal.uuid">
              <li class="flex items-center gap-2 p-1.5 rounded-lg text-sm hover:bg-base-content/5"
                  :class="collapsed ? 'justify-center' : ''">
                <span class="flex-shrink-0 w-5 h-5 flex items-center justify-center"
                      :class="'text-' + cal.color"
                      :title="collapsed ? cal.name : ''">
                  <i data-lucide="calendar" class="w-4 h-4"></i>
                </span>
                <span x-show="!collapsed" x-transition class="flex-1 truncate">
                  <span x-text="cal.name"></span>
                  <span class="text-base-content/40" x-text="'(' + cal.owner.username + ')'"></span>
                </span>
                <input x-show="!collapsed" type="checkbox" class="checkbox checkbox-xs flex-shrink-0"
                       :class="'checkbox-' + cal.color"
                       :checked="visibleCalendars[cal.uuid]"
                       @change="toggleCalendarVisibility(cal.uuid)">
              </li>
            </template>
          </ul>
        </div>
      </template>
    </div>

    <!-- Polls button -->
    <div class="px-3 pb-2">
      <ul class="menu p-0">
        {% if poll_count %}
          {% include "ui/partials/drawer_item.html" with icon="bar-chart-3" label="Polls" color="accent" onclick="openPollList()" tooltip="Polls" badge=poll_count %}
        {% else %}
          {% include "ui/partials/drawer_item.html" with icon="bar-chart-3" label="Polls" color="accent" onclick="openPollList()" tooltip="Polls" %}
        {% endif %}
      </ul>
    </div>

    <!-- Help button -->
    <div class="px-3 pb-2">
      <ul class="menu p-0">
        {% include "ui/partials/drawer_item.html" with icon="circle-help" label="Help" color="accent" onclick="document.getElementById('calendar-help-dialog').showModal(); lucide?.createIcons()" tooltip="Help (?)" %}
      </ul>
    </div>

    <!-- Collapse toggle -->
    <div class="border-t border-base-300 py-4 px-3">
      <ul class="menu p-0" x-show="!isMobile()">
        {% include "ui/partials/drawer_item.html" with icon_binding="collapsed ? 'panel-left-open' : 'panel-left-close'" label="Collapse" color="accent" onclick="toggleCollapse()" title_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" aria_label_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" %}
      </ul>
    </div>
  </aside>
</div>
{% endblock %}

{% block content %}
<div class="flex h-full min-h-0">
  <!-- Calendar -->
  <div class="flex-1 flex flex-col min-w-0">
    <div x-ref="calendarEl" class="flex-1 min-h-0"></div>
  </div>

  <!-- Event detail panel (right sidebar) -->
  <div
    x-show="showPanel" x-cloak
    x-transition:enter="transition-[width] ease-out duration-200"
    x-transition:enter-start="!w-0"
    x-transition:enter-end="!w-80"
    x-transition:leave="transition-[width] ease-in duration-150"
    x-transition:leave-start="!w-80"
    x-transition:leave-end="!w-0"
    class="w-80 border-l border-base-300 bg-base-100 flex flex-col overflow-hidden"
  >
    <div class="w-80 flex-1 overflow-y-auto">
      <!-- Skeleton loading state -->
      <div x-show="loadingEvent" class="animate-pulse">
        <!-- Color accent bar placeholder -->
        <div class="h-1.5 bg-base-300"></div>
        <div class="p-4 pb-3">
          <!-- Title placeholder -->
          <div class="h-6 bg-base-300 rounded w-3/4 mb-2"></div>
          <!-- Calendar indicator placeholder -->
          <div class="flex items-center gap-1.5 mt-1.5">
            <div class="w-2.5 h-2.5 rounded-full bg-base-300"></div>
            <div class="h-3 bg-base-300 rounded w-1/3"></div>
          </div>
        </div>
        <div class="px-4 pb-4 space-y-4">
          <!-- Date/time card placeholder -->
          <div class="bg-base-200/50 rounded-lg p-3 space-y-2">
            <div class="h-4 bg-base-300 rounded w-4/5"></div>
            <div class="h-3 bg-base-300 rounded w-2/5"></div>
          </div>
          <!-- People section placeholder -->
          <div class="border-t border-base-200 pt-3 space-y-3">
            <div class="flex items-center gap-2.5">
              <div class="w-7 h-7 rounded-full bg-base-300 flex-shrink-0"></div>
              <div class="flex-1 space-y-1">
                <div class="h-4 bg-base-300 rounded w-1/2"></div>
                <div class="h-3 bg-base-300 rounded w-1/4"></div>
              </div>
            </div>
            <div class="flex items-center gap-2.5">
              <div class="w-7 h-7 rounded-full bg-base-300 flex-shrink-0"></div>
              <div class="h-4 bg-base-300 rounded w-2/5"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Event detail content -->
      <div x-show="!loadingEvent">
        <!-- Color accent bar + header -->
        <div class="relative">
          <div class="h-1.5"
               :style="'background-color: oklch(var(--' + ({primary:'p',secondary:'s',accent:'a',info:'in',success:'su',warning:'wa',error:'er'}[eventCalendarColor()]) + '))'"></div>
          <div class="flex items-start justify-between p-4 pb-3">
            <div class="flex-1 min-w-0">
              <h3 class="font-bold text-lg leading-tight" x-text="form.title"></h3>
              <!-- Calendar indicator -->
              <div class="flex items-center gap-1.5 mt-1.5" x-show="eventCalendarObj()">
                <span class="w-2.5 h-2.5 rounded-full flex-shrink-0"
                      :style="'background-color: oklch(var(--' + ({primary:'p',secondary:'s',accent:'a',info:'in',success:'su',warning:'wa',error:'er'}[eventCalendarColor()]) + '))'"></span>
                <span class="text-xs text-base-content/50 truncate" x-text="eventCalendarObj()?.name"></span>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-circle btn-ghost flex-shrink-0 -mt-1 -mr-1" @click="closePanel()">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </div>
        </div>

        <!-- Panel content -->
        <div class="px-4 pb-4 space-y-4">
          <!-- Date & time card -->
          <div class="bg-base-200/50 rounded-lg p-3 space-y-1">
            <div class="flex items-center gap-2 text-sm font-medium">
              <i data-lucide="calendar-days" class="w-4 h-4 opacity-50 flex-shrink-0"></i>
              <span x-text="panelDateDisplay()"></span>
            </div>
            <div class="flex items-center gap-2 text-xs text-base-content/60">
              <i data-lucide="clock" class="w-3.5 h-3.5 opacity-40 flex-shrink-0"></i>
              <span x-text="panelTimeLabel()"></span>
            </div>
          </div>

          <!-- Recurrence indicator -->
          <template x-if="_panelRaw?.is_recurring">
            <div class="flex items-center gap-2 text-sm">
              <i data-lucide="repeat" class="w-4 h-4 opacity-50 flex-shrink-0"></i>
              <span class="text-base-content/70" x-text="recurrenceLabel()"></span>
            </div>
          </template>

          <!-- Location -->
          <template x-if="form.location">
            <div class="flex items-center gap-2.5 text-sm">
              <i data-lucide="map-pin" class="w-4 h-4 opacity-50 flex-shrink-0"></i>
              <span x-text="form.location"></span>
            </div>
          </template>

          <!-- Description -->
          <template x-if="form.description">
            <div class="flex items-start gap-2.5 text-sm">
              <i data-lucide="align-left" class="w-4 h-4 opacity-50 mt-0.5 flex-shrink-0"></i>
              <p class="text-base-content/70 whitespace-pre-wrap" x-text="form.description"></p>
            </div>
          </template>

          <!-- Poll link -->
          <template x-if="_panelRaw?.poll_id">
            <div class="flex items-center gap-2.5 text-sm">
              <i data-lucide="bar-chart-3" class="w-4 h-4 opacity-50 flex-shrink-0"></i>
              <button type="button" class="link link-primary" @click="openPollDetail(_panelRaw.poll_id)">View poll</button>
            </div>
          </template>

          <!-- People section -->
          <div class="border-t border-base-200 pt-3 space-y-3">
            <!-- Organizer -->
            <div class="flex items-center gap-2.5 text-sm">
              <div class="flex-shrink-0" x-html="eventOwner ? userAvatarWithCardHtml(eventOwner.id, eventOwner.username, 'w-7 h-7 text-xs') : ''"></div>
              <div class="flex-1 min-w-0">
                <span class="font-medium block truncate" x-text="eventOwner?.username"></span>
                <span class="text-xs text-base-content/40">Organizer</span>
              </div>
            </div>

            <!-- Members -->
            <template x-if="eventMembers.length > 0">
              <div class="space-y-2">
                <div class="text-xs font-medium text-base-content/40 uppercase tracking-wider flex items-center gap-1.5">
                  Guests
                  <span class="badge badge-xs badge-ghost" x-text="eventMembers.length"></span>
                </div>
                <template x-for="member in eventMembers" :key="member.uuid">
                  <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-2.5">
                      <div class="flex-shrink-0" x-html="userAvatarWithCardHtml(member.user.id, member.user.username, 'w-7 h-7 text-xs')"></div>
                      <span class="truncate" x-text="member.user.username"></span>
                    </div>
                    <span class="badge badge-xs"
                          :class="{'badge-success': member.status==='accepted','badge-warning': member.status==='pending','badge-error': member.status==='declined'}"
                          x-text="member.status"></span>
                  </div>
                </template>
              </div>
            </template>
          </div>

          <!-- Invitation response -->
          <template x-if="myInviteStatus !== null">
            <div class="flex gap-2 pt-2 border-t border-base-200">
              <button type="button" class="btn btn-sm flex-1" :class="myInviteStatus==='accepted' ? 'btn-success' : 'btn-ghost'" @click="respondToInvitation('accepted')">
                <i data-lucide="check" class="w-4 h-4"></i> Accept
              </button>
              <button type="button" class="btn btn-sm flex-1" :class="myInviteStatus==='declined' ? 'btn-error' : 'btn-ghost'" @click="respondToInvitation('declined')">
                <i data-lucide="x" class="w-4 h-4"></i> Decline
              </button>
            </div>
          </template>

          <!-- Owner actions -->
          <template x-if="isOwner()">
            <div class="flex gap-2 pt-2 border-t border-base-200">
              <button type="button" class="btn btn-sm btn-primary flex-1" @click="openEditModal()">
                <i data-lucide="pencil" class="w-4 h-4"></i> Edit
              </button>
              <button type="button" class="btn btn-sm btn-error btn-outline" @click="deleteEvent()" :disabled="deleting">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Calendar Create/Edit Modal -->
<dialog class="modal" :class="showCalendarModal && 'modal-open'" @click.self="showCalendarModal = false" @keydown.escape.window="showCalendarModal = false">
  <div class="modal-box w-11/12 max-w-sm">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-bold text-lg flex items-center gap-2">
        <span class="w-8 h-8 rounded-full flex items-center justify-center"
              :class="calendarModalMode === 'create' ? 'bg-accent/10 text-accent' : 'bg-primary/10 text-primary'">
          <i :data-lucide="calendarModalMode === 'create' ? 'calendar-plus' : 'pencil'" class="w-4 h-4"></i>
        </span>
        <span x-text="calendarModalMode === 'create' ? 'New calendar' : 'Edit calendar'"></span>
      </h3>
      <button type="button" class="btn btn-sm btn-circle btn-ghost" @click="showCalendarModal = false">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>

    <form @submit.prevent="saveCalendar()" class="space-y-4">
      <label class="form-control w-full">
        <div class="label"><span class="label-text">Name</span></div>
        <input id="calendar-form-name" type="text" class="input input-bordered input-sm w-full"
               x-model="calendarForm.name" placeholder="Calendar name" required />
      </label>

      <div>
        <div class="label"><span class="label-text">Color</span></div>
        <div class="flex flex-wrap gap-2">
          <template x-for="c in calendarColors" :key="c">
            <button type="button"
                    class="w-8 h-8 rounded-full flex items-center justify-center transition-all border-2"
                    :class="calendarForm.color === c
                      ? 'border-base-content scale-110 ring-2 ring-base-content/20'
                      : 'border-transparent hover:scale-105'"
                    :style="'background-color: oklch(var(--' + ({primary:'p',secondary:'s',accent:'a',info:'in',success:'su',warning:'wa',error:'er'}[c]) + '))'"
                    @click="calendarForm.color = c">
              <i data-lucide="check" class="w-4 h-4" x-show="calendarForm.color === c"
                 :style="'color: oklch(var(--' + ({primary:'pc',secondary:'sc',accent:'ac',info:'inc',success:'suc',warning:'wac',error:'erc'}[c]) + '))'"></i>
            </button>
          </template>
        </div>
      </div>

      <div class="modal-action">
        <button type="button" class="btn btn-sm btn-ghost" @click="showCalendarModal = false">Cancel</button>
        <button type="submit" class="btn btn-sm btn-primary" :disabled="!calendarForm.name.trim()">
          <span x-text="calendarModalMode === 'create' ? 'Create' : 'Save'"></span>
        </button>
      </div>
    </form>
  </div>
</dialog>

<!-- Event Create/Edit Modal -->
<dialog class="modal" :class="showModal && 'modal-open'" @click.self="closeModal()" @keydown.escape.window="closeModal()">
  <div class="modal-box w-11/12 max-w-lg">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-bold text-lg" x-text="modalMode === 'create' ? 'New event' : 'Edit event'"></h3>
      <button type="button" class="btn btn-sm btn-circle btn-ghost" @click="closeModal()">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>

    <form @submit.prevent="saveEvent()" class="space-y-3">
      <label class="form-control w-full">
        <div class="label"><span class="label-text">Title</span></div>
        <input type="text" class="input input-bordered input-sm w-full" x-model="form.title" placeholder="Event title" required />
      </label>

      <label class="form-control w-full">
        <div class="label"><span class="label-text">Calendar</span></div>
        <select class="select select-bordered select-sm w-full" x-model="form.calendar_id">
          <template x-for="cal in ownedCalendars" :key="cal.uuid">
            <option :value="cal.uuid" x-text="cal.name"></option>
          </template>
        </select>
      </label>

      <label class="flex items-center gap-2 cursor-pointer">
        <input type="checkbox" class="toggle toggle-sm toggle-primary" :checked="form.all_day" @change="toggleAllDay()" />
        <span class="label-text">All day</span>
      </label>

      <div class="grid grid-cols-2 gap-2">
        <label class="form-control">
          <div class="label"><span class="label-text">Start</span></div>
          <input :type="form.all_day ? 'date' : 'datetime-local'" class="input input-bordered input-sm w-full"
                 x-model="form.start" required />
        </label>
        <label class="form-control">
          <div class="label"><span class="label-text">End</span></div>
          <input :type="form.all_day ? 'date' : 'datetime-local'" class="input input-bordered input-sm w-full"
                 x-model="form.end" :min="form.start" />
        </label>
      </div>
      <!-- Duration shortcuts -->
      <div class="flex flex-wrap gap-1" x-show="form.start">
        <template x-if="!form.all_day">
          <div class="flex flex-wrap gap-1">
            <template x-for="d in [{l:'30m',m:30},{l:'1h',m:60},{l:'1h30',m:90},{l:'2h',m:120},{l:'3h',m:180}]" :key="d.m">
              <button type="button" class="badge badge-sm cursor-pointer hover:badge-primary transition-colors"
                      :class="activeDuration() === d.m ? 'badge-primary' : 'badge-outline'"
                      @click="applyDuration(d.m)" x-text="d.l"></button>
            </template>
          </div>
        </template>
        <template x-if="form.all_day">
          <div class="flex flex-wrap gap-1">
            <template x-for="d in [{l:'1 day',m:1},{l:'2 days',m:2},{l:'3 days',m:3},{l:'1 week',m:7}]" :key="d.m">
              <button type="button" class="badge badge-sm cursor-pointer hover:badge-primary transition-colors"
                      :class="activeDuration() === d.m * 1440 ? 'badge-primary' : 'badge-outline'"
                      @click="applyDuration(d.m * 1440)" x-text="d.l"></button>
            </template>
          </div>
        </template>
      </div>

      <!-- Recurrence -->
      <div class="border border-base-300 rounded-lg p-3 space-y-3">
        <label class="flex items-center justify-between cursor-pointer">
          <span class="label-text flex items-center gap-2 text-sm font-medium">
            <i data-lucide="repeat" class="w-4 h-4 opacity-60"></i> Repeat
          </span>
          <input type="checkbox" class="toggle toggle-sm toggle-primary"
                 :checked="form.recurrence_frequency !== null"
                 @change="toggleRecurrence()" />
        </label>
        <div x-show="form.recurrence_frequency !== null" x-transition>
          <div class="pt-1 space-y-3">
            <div class="flex items-center gap-2">
              <span class="text-sm text-base-content/70 w-10 flex-shrink-0">Every</span>
              <input type="number" min="1" max="365"
                     class="input input-bordered input-sm w-16 text-center"
                     x-model.number="form.recurrence_interval" />
              <select class="select select-bordered select-sm flex-1" x-model="form.recurrence_frequency">
                <option value="daily" x-text="form.recurrence_interval > 1 ? 'days' : 'day'"></option>
                <option value="weekly" x-text="form.recurrence_interval > 1 ? 'weeks' : 'week'"></option>
                <option value="monthly" x-text="form.recurrence_interval > 1 ? 'months' : 'month'"></option>
                <option value="yearly" x-text="form.recurrence_interval > 1 ? 'years' : 'year'"></option>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-sm text-base-content/70 w-10 flex-shrink-0">Until</span>
              <input type="date" class="input input-bordered input-sm flex-1"
                     x-model="form.recurrence_end" placeholder="No end date" />
            </div>
          </div>
        </div>
      </div>

      <label class="form-control w-full">
        <div class="label"><span class="label-text">Location</span></div>
        <input type="text" class="input input-bordered input-sm w-full" x-model="form.location" placeholder="Add a location" />
      </label>

      <label class="form-control w-full">
        <div class="label"><span class="label-text">Description</span></div>
        <textarea class="textarea textarea-bordered textarea-sm w-full" rows="2" x-model="form.description" placeholder="Add a description"></textarea>
      </label>

      <div>
        <div class="label"><span class="label-text">Invite guests</span></div>
        {% include "ui/partials/user_selector.html" with on_select_event="calendar-member-selected" placeholder="Search users to invite..." %}
        <div class="flex flex-wrap gap-1 mt-2">
          <template x-for="member in selectedMembers" :key="member.id">
            <span class="badge badge-outline gap-1 pr-0.5">
              <div class="w-4 h-4 flex-shrink-0" x-html="userAvatarHtml(member.id, member.username, 'w-4 h-4 text-[0.5rem]', {presence: false})"></div>
              <span x-text="member.username"></span>
              <button type="button" class="btn btn-ghost btn-circle btn-xs" @click="removeMember(member.id)">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </button>
            </span>
          </template>
        </div>
      </div>

      <div class="modal-action">
        <button type="button" class="btn btn-sm btn-ghost" @click="closeModal()">Cancel</button>
        <button type="submit" class="btn btn-sm btn-primary" :disabled="saving || !form.title.trim()">
          <span x-show="saving" class="loading loading-spinner loading-xs"></span>
          <span x-text="modalMode === 'create' ? 'Create' : 'Save'"></span>
        </button>
      </div>
    </form>
  </div>
</dialog>

<!-- Scope Dialog (for recurring event edit/delete) -->
<dialog class="modal" :class="showScopeDialog && 'modal-open'">
  <div class="modal-box w-11/12 max-w-xs">
    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
      <i data-lucide="repeat" class="w-5 h-5 text-accent"></i>
      <span x-text="scopeAction === 'delete' ? 'Delete recurring event' : 'Edit recurring event'"></span>
    </h3>
    <div class="space-y-2">
      <button type="button" class="btn btn-ghost btn-sm w-full justify-start gap-2" @click="resolveScopeDialog('this')">
        <i data-lucide="calendar" class="w-4 h-4"></i> This event only
      </button>
      <button type="button" class="btn btn-ghost btn-sm w-full justify-start gap-2" @click="resolveScopeDialog('future')">
        <i data-lucide="calendar-range" class="w-4 h-4"></i> This and future events
      </button>
      <button type="button" class="btn btn-ghost btn-sm w-full justify-start gap-2" @click="resolveScopeDialog('all')">
        <i data-lucide="calendar-check" class="w-4 h-4"></i> All events in series
      </button>
    </div>
    <div class="modal-action">
      <button type="button" class="btn btn-sm btn-ghost" @click="resolveScopeDialog(null)">Cancel</button>
    </div>
  </div>
</dialog>

<!-- Poll List Modal -->
<dialog class="modal" :class="showPollListModal && 'modal-open'" @click.self="showPollListModal = false" @keydown.escape.window="showPollListModal && (showPollListModal = false)">
  <div class="modal-box w-11/12 max-w-3xl h-[70vh] flex flex-col">
    <div class="flex items-center justify-between mb-4 flex-shrink-0">
      <h3 class="font-bold text-lg flex items-center gap-2">
        <span class="w-8 h-8 rounded-full flex items-center justify-center bg-accent/10 text-accent">
          <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
        </span>
        Polls
      </h3>
      <button type="button" class="btn btn-sm btn-circle btn-ghost" @click="showPollListModal = false">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>

    <!-- Toolbar: filters + actions -->
    <div class="flex items-center justify-between gap-3 mb-3 flex-shrink-0">
      <div class="flex items-center gap-1">
        <div class="join">
          <button type="button" class="join-item btn btn-sm"
                  :class="pollFilter === 'mine' ? 'btn-active' : 'btn-ghost'"
                  @click="setPollFilter('mine')">
            <i data-lucide="user" class="w-3.5 h-3.5"></i> My polls
          </button>
          <button type="button" class="join-item btn btn-sm"
                  :class="pollFilter === 'shared' ? 'btn-active' : 'btn-ghost'"
                  @click="setPollFilter('shared')">
            <i data-lucide="inbox" class="w-3.5 h-3.5"></i> Shared with me
          </button>
        </div>
        <label class="flex items-center gap-1.5 cursor-pointer ml-2">
          <input type="checkbox" class="checkbox checkbox-xs" :checked="pollShowClosed" @change="togglePollShowClosed()">
          <span class="text-xs text-base-content/60">Closed</span>
        </label>
      </div>
      <button type="button" class="btn btn-sm btn-primary" @click="openPollCreate()">
        <i data-lucide="plus" class="w-4 h-4"></i> New poll
      </button>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto">
      <!-- Loading -->
      <div x-show="pollsLoading" class="flex justify-center py-8">
        <span class="loading loading-spinner loading-md"></span>
      </div>

      <!-- Empty state -->
      <div x-show="!pollsLoading && polls.length === 0" class="text-center py-8 text-base-content/50">
        <i data-lucide="bar-chart-3" class="w-10 h-10 mx-auto mb-2 opacity-30"></i>
        <template x-if="pollFilter === 'mine'">
          <div>
            <p>No open polls</p>
            <p class="text-sm mt-1">Create a poll to find the best time for your event</p>
          </div>
        </template>
        <template x-if="pollFilter === 'shared'">
          <div>
            <p>No polls shared with you</p>
            <p class="text-sm mt-1">Polls you vote on via a share link will appear here</p>
          </div>
        </template>
      </div>

      <!-- Poll table -->
      <div x-show="!pollsLoading && polls.length > 0" class="overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Title</th>
              <th x-show="pollFilter === 'shared'">Creator</th>
              <th>Status</th>
              <th>Participants</th>
              <th>Created</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <template x-for="poll in polls" :key="poll.uuid">
              <tr class="hover cursor-pointer" @click="openPollDetail(poll.uuid)">
                <td class="font-medium" x-text="poll.title"></td>
                <td x-show="pollFilter === 'shared'" class="text-sm text-base-content/60" x-text="poll.created_by?.username"></td>
                <td>
                  <span class="badge badge-sm"
                        :class="poll.status === 'open' ? 'badge-success' : 'badge-ghost'"
                        x-text="poll.status"></span>
                </td>
                <td>
                  <span class="flex items-center gap-1 text-base-content/60">
                    <i data-lucide="users" class="w-3 h-3"></i>
                    <span x-text="poll.participant_count"></span>
                  </span>
                </td>
                <td class="text-base-content/60 text-xs" x-text="new Date(poll.created_at).toLocaleDateString()"></td>
                <td>
                  <template x-if="pollFilter === 'mine'">
                    <button type="button" class="btn btn-ghost btn-xs btn-square" @click.stop="deletePoll(poll.uuid)" title="Delete">
                      <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                  </template>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</dialog>

<!-- Poll Create Modal -->
<dialog class="modal" :class="showPollCreateModal && 'modal-open'" @click.self="showPollCreateModal = false" @keydown.escape.window="showPollCreateModal && (showPollCreateModal = false)">
  <div class="modal-box w-11/12 max-w-3xl h-[70vh] flex flex-col">
    <div class="flex items-center justify-between mb-4 flex-shrink-0">
      <h3 class="font-bold text-lg flex items-center gap-2">
        <span class="w-8 h-8 rounded-full flex items-center justify-center bg-accent/10 text-accent">
          <i data-lucide="plus" class="w-4 h-4"></i>
        </span>
        New Poll
      </h3>
      <button type="button" class="btn btn-sm btn-circle btn-ghost" @click="showPollCreateModal = false">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>

    <form @submit.prevent="submitPoll()" class="flex-1 flex flex-col min-h-0">
      <!-- Scrollable content -->
      <div class="flex-1 overflow-y-auto space-y-4 pr-1">
        <!-- Error -->
        <template x-if="pollFormError">
          <div class="alert alert-error alert-sm">
            <i data-lucide="alert-circle" class="w-4 h-4"></i>
            <span x-text="pollFormError"></span>
          </div>
        </template>

        <label class="form-control w-full">
          <div class="label"><span class="label-text">Title</span></div>
          <input type="text" class="input input-bordered input-sm w-full"
                 x-model="pollForm.title" placeholder="e.g. Team meeting next week" required />
        </label>

        <label class="form-control w-full">
          <div class="label"><span class="label-text">Description</span></div>
          <textarea class="textarea textarea-bordered textarea-sm w-full" rows="2"
                    x-model="pollForm.description" placeholder="Optional description"></textarea>
        </label>

        <div>
          <div class="flex items-center justify-between mb-2">
            <span class="label-text font-medium">Time slots</span>
            <button type="button" class="btn btn-ghost btn-xs" @click="addPollSlot()">
              <i data-lucide="plus" class="w-3 h-3"></i> Add slot
            </button>
          </div>
          <div class="space-y-2">
            <template x-for="(slot, i) in pollForm.slots" :key="i">
              <div class="flex items-center gap-2">
                <label class="form-control flex-1">
                  <input type="datetime-local" class="input input-bordered input-sm w-full"
                         x-model="pollForm.slots[i].start" required />
                </label>
                <template x-if="pollForm.slots[i].showEnd">
                  <div class="flex items-center gap-2 flex-1">
                    <span class="text-base-content/40 text-sm">to</span>
                    <label class="form-control flex-1">
                      <input type="datetime-local" class="input input-bordered input-sm w-full"
                             x-model="pollForm.slots[i].end" />
                    </label>
                    <button type="button" class="btn btn-ghost btn-xs btn-square" @click="pollForm.slots[i].showEnd = false; pollForm.slots[i].end = ''" title="Remove end time">
                      <i data-lucide="clock" class="w-3 h-3 opacity-50"></i>
                    </button>
                  </div>
                </template>
                <template x-if="!pollForm.slots[i].showEnd">
                  <button type="button" class="btn btn-ghost btn-xs" @click="pollForm.slots[i].showEnd = true; $nextTick(() => lucide?.createIcons())" title="Add end time">
                    <i data-lucide="plus" class="w-3 h-3"></i> End
                  </button>
                </template>
                <button type="button" class="btn btn-ghost btn-xs btn-square"
                        :class="pollForm.slots.length <= 2 ? 'opacity-30 cursor-not-allowed' : ''"
                        @click="removePollSlot(i)" :disabled="pollForm.slots.length <= 2" title="Remove slot">
                  <i data-lucide="x" class="w-3 h-3"></i>
                </button>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Fixed bottom buttons -->
      <div class="modal-action flex-shrink-0">
        <button type="button" class="btn btn-sm btn-ghost" @click="showPollCreateModal = false">Cancel</button>
        <button type="submit" class="btn btn-sm btn-primary" :disabled="pollFormSubmitting || !pollForm.title.trim()">
          <span x-show="pollFormSubmitting" class="loading loading-spinner loading-xs"></span>
          Create poll
        </button>
      </div>
    </form>
  </div>
</dialog>

<!-- Poll Detail Modal -->
<dialog class="modal" :class="showPollDetailModal && 'modal-open'" @click.self="closePollDetail()" @keydown.escape.window="showPollDetailModal && closePollDetail()">
  <div class="modal-box w-11/12 max-w-3xl h-[70vh] flex flex-col">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4 flex-shrink-0">
      <div class="flex items-center gap-3 min-w-0">
        <button type="button" class="btn btn-sm btn-ghost btn-square flex-shrink-0" @click="closePollDetail(); openPollList()">
          <i data-lucide="arrow-left" class="w-4 h-4"></i>
        </button>
        <div class="min-w-0" x-show="currentPoll">
          <h3 class="font-bold text-lg truncate" x-text="currentPoll?.title"></h3>
          <div class="flex items-center gap-2 mt-0.5">
            <span class="badge badge-sm"
                  :class="currentPoll?.status === 'open' ? 'badge-success' : 'badge-ghost'"
                  x-text="currentPoll?.status"></span>
            <span class="text-xs text-base-content/50" x-text="'by ' + (currentPoll?.created_by?.username || '')"></span>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-1 flex-shrink-0">
        <button type="button" class="btn btn-sm btn-ghost" @click="copyPollShareLink()" title="Copy share link" x-show="currentPoll">
          <i data-lucide="share-2" class="w-4 h-4"></i>
          <span class="hidden sm:inline">Share</span>
        </button>
        <template x-if="isPollCreator()">
          <button type="button" class="btn btn-sm btn-ghost text-error" @click="deletePoll(currentPoll.uuid)" title="Delete poll">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </template>
        <button type="button" class="btn btn-sm btn-circle btn-ghost" @click="closePollDetail()">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div x-show="currentPollLoading" class="flex justify-center py-12">
      <span class="loading loading-spinner loading-lg"></span>
    </div>

    <!-- Content -->
    <div :style="(!currentPollLoading && currentPoll) ? 'display:flex' : 'display:none'" class="flex-1 flex-col overflow-y-auto">
      <!-- Description -->
      <template x-if="currentPoll?.description">
        <p class="text-sm text-base-content/70 mb-4" x-text="currentPoll.description"></p>
      </template>

      <!-- Closed banner -->
      <template x-if="currentPoll?.status === 'closed'">
        <div class="alert alert-success mb-4">
          <i data-lucide="check-circle" class="w-5 h-5"></i>
          <div>
            <span class="font-medium">Poll finalized!</span>
            <template x-if="currentPoll?.event_id">
              <span class="ml-1">
                An event has been created.
                <button type="button" class="link link-primary" @click="closePollDetail(); openEventById(currentPoll.event_id)">View event</button>
              </span>
            </template>
          </div>
        </div>
      </template>

      <!-- Finalize toolbar (creator only, open poll) — above grid -->
      <template x-if="isPollCreator() && currentPoll?.status === 'open'">
        <div class="flex items-center gap-2 mb-4 p-3 bg-base-200/50 rounded-lg">
          <i data-lucide="trophy" class="w-4 h-4 text-success flex-shrink-0"></i>
          <span class="text-sm font-medium flex-shrink-0">Finalize:</span>
          <select class="select select-bordered select-sm flex-1" x-model="pollFinalizeSlotId">
            <option value="">Choose winning slot...</option>
            <template x-for="slot in (currentPoll?.slots || [])" :key="slot.uuid">
              <option :value="slot.uuid" x-text="formatPollSlotDate(slot) + ' ' + formatPollSlotTime(slot)"></option>
            </template>
          </select>
          <button type="button" class="btn btn-sm btn-success" @click="finalizePoll()" :disabled="!pollFinalizeSlotId || pollSubmitting">
            <span x-show="pollSubmitting" class="loading loading-spinner loading-xs"></span>
            <i data-lucide="check" class="w-4 h-4" x-show="!pollSubmitting"></i> Finalize
          </button>
        </div>
      </template>

      <!-- Doodle voting grid -->
      <div class="overflow-x-auto">
        <table class="poll-grid w-full text-sm">
          <thead>
            <tr>
              <th class="text-left min-w-[120px]">Participant</th>
              <template x-for="slot in (currentPoll?.slots || [])" :key="slot.uuid">
                <th class="text-center min-w-[100px]">
                  <div class="text-xs font-semibold" x-text="formatPollSlotDate(slot)"></div>
                  <div class="text-xs text-base-content/50 font-normal" x-text="formatPollSlotTime(slot)"></div>
                </th>
              </template>
            </tr>
          </thead>
          <tbody>
            <!-- Existing participants -->
            <template x-for="p in pollParticipants()" :key="p.key">
              <tr>
                <td class="font-medium">
                  <span x-text="p.name"></span>
                  <span x-show="!p.isUser" class="badge badge-xs badge-ghost ml-1">guest</span>
                </td>
                <template x-for="slot in (currentPoll?.slots || [])" :key="slot.uuid">
                  <td class="text-center">
                    <i :data-lucide="pollVoteIcon(p.votes[slot.uuid])"
                       :class="pollVoteClass(p.votes[slot.uuid])"
                       class="w-5 h-5 inline-block"></i>
                  </td>
                </template>
              </tr>
            </template>

            <!-- My vote row (editable) — only when poll is open -->
            <template x-if="currentPoll?.status === 'open'">
              <tr class="bg-base-200/50">
                <td class="font-medium text-primary">Your vote</td>
                <template x-for="slot in (currentPoll?.slots || [])" :key="slot.uuid">
                  <td class="text-center">
                    <button type="button"
                            class="btn btn-ghost btn-sm btn-square"
                            @click="pollCycleVote(slot.uuid)"
                            title="Click to cycle: yes / maybe / no">
                      <i :data-lucide="pollVoteIcon(pollMyVotes[slot.uuid])"
                         :class="pollVoteClass(pollMyVotes[slot.uuid])"
                         class="w-5 h-5"></i>
                    </button>
                  </td>
                </template>
              </tr>
            </template>
          </tbody>
          <tfoot>
            <tr>
              <td class="text-xs text-base-content/50 font-medium">Totals</td>
              <template x-for="slot in (currentPoll?.slots || [])" :key="slot.uuid">
                <td class="text-center">
                  <span class="text-success text-xs font-semibold" x-text="slot.yes_count"></span>
                  <span class="text-base-content/30 text-xs mx-0.5">/</span>
                  <span class="text-warning text-xs" x-text="slot.maybe_count"></span>
                </td>
              </template>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Legend -->
      <div class="flex items-center gap-4 mt-3 text-xs text-base-content/50">
        <span class="flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3 text-success"></i> Yes</span>
        <span class="flex items-center gap-1"><i data-lucide="help-circle" class="w-3 h-3 text-warning"></i> Maybe</span>
        <span class="flex items-center gap-1"><i data-lucide="x-circle" class="w-3 h-3 text-error opacity-40"></i> No</span>
        <span class="flex items-center gap-1"><i data-lucide="circle" class="w-3 h-3 text-base-content/20"></i> No vote</span>
      </div>

    </div>

    <!-- Fixed bottom actions -->
    <div class="modal-action flex-shrink-0">
      <button type="button" class="btn btn-sm btn-ghost" @click="closePollDetail()">Close</button>
      <template x-if="currentPoll?.status === 'open'">
        <button type="button" class="btn btn-sm btn-primary" @click="submitPollVotes()" :disabled="pollSubmitting">
          <span x-show="pollSubmitting" class="loading loading-spinner loading-xs"></span>
          <i data-lucide="save" class="w-4 h-4" x-show="!pollSubmitting"></i>
          Save my votes
        </button>
      </template>
    </div>
  </div>
</dialog>

{% include "calendar/ui/partials/event_context_menu.html" %}
{% include "calendar/ui/partials/help_dialog.html" %}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="{% static 'calendar/ui/js/calendar.js' %}"></script>
<script>
  document.body.dataset.userId = '{{ request.user.id }}';
</script>
{% endblock %}
