{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Poll</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.23/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="{% static 'calendar/ui/css/polls.css' %}" />
</head>
<body class="min-h-screen bg-base-200">
  <div class="max-w-4xl mx-auto p-6" x-data="sharedPoll('{{ share_token }}')">

    <template x-if="loading">
      <div class="flex justify-center py-12">
        <span class="loading loading-spinner loading-lg"></span>
      </div>
    </template>

    <template x-if="!loading && poll">
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
          <h1 class="card-title text-2xl" x-text="poll.title"></h1>
          <p class="opacity-70" x-show="poll.description" x-text="poll.description"></p>

          <!-- Guest identity -->
          <template x-if="poll.status === 'open'">
            <div class="flex gap-4 mt-4 mb-2">
              <div class="form-control flex-1">
                <label class="label"><span class="label-text">Your name *</span></label>
                <input type="text" class="input input-bordered input-sm" x-model="guestName"
                       placeholder="Your name" maxlength="100" />
              </div>
              <div class="form-control flex-1">
                <label class="label"><span class="label-text">Email (optional)</span></label>
                <input type="email" class="input input-bordered input-sm" x-model="guestEmail"
                       placeholder="your@email.com" />
              </div>
            </div>
          </template>

          <!-- Doodle grid -->
          <div class="overflow-x-auto mt-4">
            <table class="table poll-grid">
              <thead>
                <tr>
                  <th class="min-w-[120px]">Participant</th>
                  <template x-for="slot in poll.slots" :key="slot.uuid">
                    <th class="text-center min-w-[100px]">
                      <div class="text-xs font-medium" x-text="formatSlotDate(slot)"></div>
                      <div class="text-xs opacity-60" x-text="formatSlotTime(slot)"></div>
                    </th>
                  </template>
                </tr>
              </thead>
              <tbody>
                <template x-for="p in participants" :key="p.key">
                  <tr>
                    <td class="font-medium text-sm" x-text="p.name"></td>
                    <template x-for="slot in poll.slots" :key="slot.uuid">
                      <td class="text-center">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center mx-auto"
                             :class="voteClass(p.votes[slot.uuid])">
                          <i :data-lucide="voteIcon(p.votes[slot.uuid])" class="w-4 h-4"></i>
                        </div>
                      </td>
                    </template>
                  </tr>
                </template>

                <!-- Guest vote row -->
                <template x-if="poll.status === 'open'">
                  <tr class="bg-base-200/50">
                    <td class="font-medium text-sm text-primary" x-text="guestName || 'You'"></td>
                    <template x-for="slot in poll.slots" :key="slot.uuid">
                      <td class="text-center">
                        <button class="w-8 h-8 rounded-lg flex items-center justify-center mx-auto cursor-pointer transition-colors"
                                :class="voteClass(myVotes[slot.uuid])"
                                @click="cycleVote(slot.uuid)">
                          <i :data-lucide="voteIcon(myVotes[slot.uuid])" class="w-4 h-4"></i>
                        </button>
                      </td>
                    </template>
                  </tr>
                </template>
              </tbody>
              <tfoot>
                <tr>
                  <td class="text-sm font-medium opacity-70">Yes votes</td>
                  <template x-for="slot in poll.slots" :key="slot.uuid">
                    <td class="text-center">
                      <span class="badge badge-success badge-sm" x-text="slotYesCount(slot.uuid)"></span>
                    </td>
                  </template>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- Submit -->
          <template x-if="poll.status === 'open'">
            <div class="mt-4 flex justify-end">
              <button class="btn btn-primary btn-sm" @click="submitVotes()"
                      :disabled="!guestName.trim() || submitting || Object.keys(myVotes).length === 0">
                <span x-show="submitting" class="loading loading-spinner loading-sm"></span>
                Save my votes
              </button>
            </div>
          </template>

          <!-- Closed banner -->
          <template x-if="poll.status === 'closed'">
            <div class="alert alert-info mt-4">
              <i data-lucide="info" class="w-5 h-5"></i>
              This poll has been finalized.
            </div>
          </template>
        </div>
      </div>
    </template>
  </div>

  <script>
  window.sharedPoll = function(token) {
    return {
      poll: null,
      loading: true,
      submitting: false,
      guestName: '',
      guestEmail: '',
      myVotes: {},

      async init() {
        try {
          const resp = await fetch('/api/v1/calendar/polls/shared/' + token);
          if (resp.ok) this.poll = await resp.json();
        } catch (e) {
          console.error('Failed to load poll', e);
        }
        this.loading = false;
        this.$nextTick(() => lucide.createIcons());
      },

      cycleVote(slotId) {
        if (this.poll.status === 'closed') return;
        const order = ['yes', 'maybe', 'no'];
        const current = this.myVotes[slotId];
        const idx = current ? order.indexOf(current) : -1;
        this.myVotes[slotId] = order[(idx + 1) % order.length];
        this.$nextTick(() => lucide.createIcons());
      },

      voteClass(choice) {
        if (choice === 'yes') return 'bg-success/20 text-success';
        if (choice === 'maybe') return 'bg-warning/20 text-warning';
        if (choice === 'no') return 'bg-error/20 text-error';
        return 'bg-base-200';
      },

      voteIcon(choice) {
        if (choice === 'yes') return 'check';
        if (choice === 'maybe') return 'help-circle';
        if (choice === 'no') return 'x';
        return 'circle';
      },

      get participants() {
        if (!this.poll) return [];
        const map = new Map();
        for (const vote of (this.poll.votes || [])) {
          const key = vote.user ? 'user:' + vote.user.id : 'guest:' + vote.guest_name;
          if (!map.has(key)) {
            map.set(key, {
              key,
              name: vote.user
                ? (vote.user.first_name + ' ' + vote.user.last_name).trim() || vote.user.username
                : vote.guest_name,
              votes: {},
            });
          }
          map.get(key).votes[vote.slot_id] = vote.choice;
        }
        return Array.from(map.values());
      },

      slotYesCount(slotId) {
        const slot = this.poll?.slots?.find(s => s.uuid === slotId);
        return slot?.yes_count || 0;
      },

      formatSlotDate(slot) {
        const d = new Date(slot.start);
        return d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
      },

      formatSlotTime(slot) {
        const start = new Date(slot.start);
        const parts = [start.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' })];
        if (slot.end) {
          const end = new Date(slot.end);
          parts.push(end.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' }));
        }
        return parts.join(' - ');
      },

      async submitVotes() {
        this.submitting = true;
        try {
          const votes = Object.entries(this.myVotes).map(([slot_id, choice]) => ({
            slot_id,
            choice,
          }));
          const resp = await fetch('/api/v1/calendar/polls/shared/' + token + '/vote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              guest_name: this.guestName,
              guest_email: this.guestEmail,
              votes,
            }),
          });
          if (resp.ok) {
            this.poll = await resp.json();
            this.myVotes = {};
          }
        } catch (e) {
          console.error('Failed to submit votes', e);
        }
        this.submitting = false;
        this.$nextTick(() => lucide.createIcons());
      },
    };
  };
  </script>
</body>
</html>
