{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Poll</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.23/dist/full.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="{% static 'calendar/ui/css/polls.css' %}" />
</head>
<body class="min-h-screen bg-base-200 flex flex-col">
  <div class="flex-1 max-w-4xl mx-auto w-full p-4 sm:p-6" x-data="sharedPoll('{{ share_token }}')">

    <template x-if="loading">
      <div class="flex justify-center py-12">
        <span class="loading loading-spinner loading-lg text-primary"></span>
      </div>
    </template>

    <template x-if="!loading && poll">
      <div>
        <!-- Header card -->
        <div class="card bg-base-100 shadow-lg overflow-hidden">
          <div class="bg-gradient-to-r from-primary to-secondary px-6 py-5">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center backdrop-blur-sm">
                <i data-lucide="bar-chart-3" class="w-5 h-5 text-white"></i>
              </div>
              <div>
                <h1 class="text-xl sm:text-2xl font-bold text-white" x-text="poll.title"></h1>
                <p class="text-white/70 text-sm" x-show="poll.description" x-text="poll.description"></p>
              </div>
            </div>
          </div>

          <div class="card-body pt-5">
            <!-- Info badges -->
            <div class="flex flex-wrap items-center gap-2 mb-2">
              <div class="badge badge-ghost gap-1.5">
                <i data-lucide="calendar-days" class="w-3 h-3"></i>
                <span x-text="poll.slots.length + ' slot' + (poll.slots.length > 1 ? 's' : '')"></span>
              </div>
              <div class="badge badge-ghost gap-1.5">
                <i data-lucide="users" class="w-3 h-3"></i>
                <span x-text="participants.length + ' participant' + (participants.length !== 1 ? 's' : '')"></span>
              </div>
              <template x-if="poll.status === 'open'">
                <div class="badge badge-success gap-1.5">
                  <i data-lucide="circle-dot" class="w-3 h-3"></i>
                  Open
                </div>
              </template>
              <template x-if="poll.status === 'closed'">
                <div class="badge badge-neutral gap-1.5">
                  <i data-lucide="lock" class="w-3 h-3"></i>
                  Finalized
                </div>
              </template>
            </div>

            <!-- Guest identity -->
            <template x-if="poll.status === 'open'">
              <div class="bg-base-200/50 rounded-xl p-4 mb-2">
                <div class="flex items-center gap-2 mb-3">
                  <i data-lucide="user-round" class="w-4 h-4 text-primary"></i>
                  <span class="text-sm font-medium">Your identity</span>
                </div>
                <div class="flex gap-4">
                  <div class="form-control flex-1">
                    <label class="label py-0.5"><span class="label-text text-xs">Name *</span></label>
                    <input type="text" class="input input-bordered input-sm" x-model="guestName"
                           placeholder="Your name" maxlength="100" />
                  </div>
                  <div class="form-control flex-1">
                    <label class="label py-0.5"><span class="label-text text-xs">Email (optional)</span></label>
                    <input type="email" class="input input-bordered input-sm" x-model="guestEmail"
                           placeholder="your@email.com" />
                  </div>
                </div>
              </div>
            </template>

            <!-- Already voted banner -->
            <template x-if="votesRestored && poll.status === 'open'">
              <div class="alert mb-2 bg-base-200 border-base-300">
                <i data-lucide="info" class="w-5 h-5 text-info"></i>
                <span>Your previous votes have been restored. You can update them below.</span>
              </div>
            </template>

            <!-- Vote submitted confirmation -->
            <template x-if="voteSubmitted && poll.status === 'open'">
              <div class="alert mb-2 bg-base-200 border-base-300">
                <i data-lucide="check-circle-2" class="w-5 h-5 text-success"></i>
                <div>
                  <span>Your votes have been saved!</span>
                  <p class="text-sm opacity-60 mt-0.5" x-show="guestEmail.trim()">You'll receive an email once a final slot is chosen.</p>
                  <p class="text-sm opacity-60 mt-0.5" x-show="!guestEmail.trim()">Bookmark this page to come back and see the final result.</p>
                </div>
              </div>
            </template>

            <!-- Doodle grid -->
            <div class="overflow-x-auto mt-2">
              <table class="table poll-grid">
                <thead>
                  <tr>
                    <th class="min-w-[120px]">
                      <div class="flex items-center gap-1.5 text-base-content/60">
                        <i data-lucide="user" class="w-3.5 h-3.5"></i>
                        Participant
                      </div>
                    </th>
                    <template x-for="slot in poll.slots" :key="slot.uuid">
                      <th class="text-center min-w-[100px]">
                        <div class="flex flex-col items-center gap-0.5">
                          <div class="text-xs font-semibold text-primary" x-text="formatSlotDate(slot)"></div>
                          <div class="text-xs opacity-50 flex items-center gap-1">
                            <i data-lucide="clock" class="w-3 h-3"></i>
                            <span x-text="formatSlotTime(slot)"></span>
                          </div>
                        </div>
                      </th>
                    </template>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="p in participants" :key="p.key">
                    <tr class="hover">
                      <td class="font-medium text-sm">
                        <div class="flex items-center gap-2">
                          <div class="w-6 h-6 rounded-full bg-base-300 flex items-center justify-center text-xs font-bold uppercase"
                               x-text="p.name.charAt(0)"></div>
                          <span x-text="p.name"></span>
                        </div>
                      </td>
                      <template x-for="slot in poll.slots" :key="slot.uuid">
                        <td class="text-center">
                          <div class="w-8 h-8 rounded-lg flex items-center justify-center mx-auto transition-colors"
                               :class="voteClass(p.votes[slot.uuid])">
                            <i :data-lucide="voteIcon(p.votes[slot.uuid])" class="w-4 h-4"></i>
                          </div>
                        </td>
                      </template>
                    </tr>
                  </template>

                  <!-- Guest vote row -->
                  <template x-if="poll.status === 'open'">
                    <tr class="bg-primary/5 border-t-2 border-primary/20">
                      <td class="font-medium text-sm">
                        <div class="flex items-center gap-2 text-primary">
                          <div class="w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center">
                            <i data-lucide="pencil" class="w-3 h-3"></i>
                          </div>
                          <span x-text="guestName || 'You'"></span>
                        </div>
                      </td>
                      <template x-for="slot in poll.slots" :key="slot.uuid">
                        <td class="text-center">
                          <button class="w-8 h-8 rounded-lg flex items-center justify-center mx-auto cursor-pointer transition-all hover:scale-110 active:scale-95"
                                  :class="voteClass(myVotes[slot.uuid])"
                                  @click="cycleVote(slot.uuid)">
                            <i :data-lucide="voteIcon(myVotes[slot.uuid])" class="w-4 h-4"></i>
                          </button>
                        </td>
                      </template>
                    </tr>
                  </template>
                </tbody>
                <tfoot>
                  <tr>
                    <td class="text-sm font-medium opacity-70">
                      <div class="flex items-center gap-1.5">
                        <i data-lucide="thumbs-up" class="w-3.5 h-3.5 text-success"></i>
                        Yes votes
                      </div>
                    </td>
                    <template x-for="slot in poll.slots" :key="slot.uuid">
                      <td class="text-center">
                        <span class="text-sm font-semibold text-success" x-text="slotYesCount(slot.uuid)"></span>
                      </td>
                    </template>
                  </tr>
                </tfoot>
              </table>
            </div>

            <!-- Legend -->
            <div class="flex flex-wrap gap-4 mt-3 text-xs text-base-content/50">
              <div class="flex items-center gap-1.5">
                <div class="w-5 h-5 rounded bg-success/20 flex items-center justify-center"><i data-lucide="check" class="w-3 h-3 text-success"></i></div>
                Yes
              </div>
              <div class="flex items-center gap-1.5">
                <div class="w-5 h-5 rounded bg-warning/20 flex items-center justify-center"><i data-lucide="help-circle" class="w-3 h-3 text-warning"></i></div>
                Maybe
              </div>
              <div class="flex items-center gap-1.5">
                <div class="w-5 h-5 rounded bg-error/20 flex items-center justify-center"><i data-lucide="x" class="w-3 h-3 text-error"></i></div>
                No
              </div>
            </div>

            <!-- Submit -->
            <template x-if="poll.status === 'open'">
              <div class="mt-4 flex justify-end">
                <button class="btn btn-primary btn-sm gap-2" @click="submitVotes()"
                        :disabled="!guestName.trim() || submitting || Object.keys(myVotes).length === 0">
                  <span x-show="submitting" class="loading loading-spinner loading-sm"></span>
                  <i x-show="!submitting" data-lucide="send" class="w-4 h-4"></i>
                  Save my votes
                </button>
              </div>
            </template>

            <!-- Closed banner -->
            <template x-if="poll.status === 'closed'">
              <div class="alert mt-4 bg-base-200 border-base-300">
                <i data-lucide="check-circle-2" class="w-5 h-5 text-success"></i>
                <span>This poll has been finalized.</span>
              </div>
            </template>
          </div>
        </div>

        <!-- Footer -->
        <footer class="mt-6 mb-4 text-center">
          <div class="flex items-center justify-center gap-2 text-base-content/40 text-sm">
            <div class="w-6 h-6 rounded-md bg-gradient-to-br from-primary to-secondary flex items-center justify-center">
              <i data-lucide="users" class="w-3.5 h-3.5 text-white"></i>
            </div>
            <span>Poll created with</span>
            <a href="/" class="font-semibold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent hover:underline">
              Workspace
            </a>
          </div>
        </footer>
      </div>
    </template>
  </div>

  <script>
  window.sharedPoll = function(token) {
    return {
      poll: null,
      loading: true,
      submitting: false,
      guestName: '',
      guestEmail: '',
      myVotes: {},
      voterToken: '',
      votesRestored: false,
      voteSubmitted: false,

      async init() {
        this.voterToken = localStorage.getItem('poll_voter_' + token) || '';
        try {
          const url = '/api/v1/calendar/polls/shared/' + token
            + (this.voterToken ? '?voter_token=' + encodeURIComponent(this.voterToken) : '');
          const resp = await fetch(url);
          if (resp.ok) {
            const data = await resp.json();
            this.poll = data;
            // Restore previous votes if any
            if (data.my_votes && Object.keys(data.my_votes).length > 0) {
              this.myVotes = data.my_votes;
              this.votesRestored = true;
            }
            if (data.my_guest_name) this.guestName = data.my_guest_name;
            if (data.my_guest_email) this.guestEmail = data.my_guest_email;
          }
        } catch (e) {
          console.error('Failed to load poll', e);
        }
        this.loading = false;
        this.$nextTick(() => lucide.createIcons());
      },

      cycleVote(slotId) {
        if (this.poll.status === 'closed') return;
        const order = ['yes', 'maybe', 'no'];
        const current = this.myVotes[slotId];
        const idx = current ? order.indexOf(current) : -1;
        this.myVotes[slotId] = order[(idx + 1) % order.length];
        this.$nextTick(() => lucide.createIcons());
      },

      voteClass(choice) {
        if (choice === 'yes') return 'bg-success/20 text-success';
        if (choice === 'maybe') return 'bg-warning/20 text-warning';
        if (choice === 'no') return 'bg-error/20 text-error';
        return 'bg-base-200 text-base-content/20';
      },

      voteIcon(choice) {
        if (choice === 'yes') return 'check';
        if (choice === 'maybe') return 'help-circle';
        if (choice === 'no') return 'x';
        return 'circle';
      },

      get participants() {
        if (!this.poll) return [];
        const map = new Map();
        for (const vote of (this.poll.votes || [])) {
          const key = vote.user ? 'user:' + vote.user.id : 'guest:' + vote.guest_name;
          if (!map.has(key)) {
            map.set(key, {
              key,
              name: vote.user
                ? (vote.user.first_name + ' ' + vote.user.last_name).trim() || vote.user.username
                : vote.guest_name,
              votes: {},
            });
          }
          map.get(key).votes[vote.slot_id] = vote.choice;
        }
        return Array.from(map.values());
      },

      slotYesCount(slotId) {
        const slot = this.poll?.slots?.find(s => s.uuid === slotId);
        return slot?.yes_count || 0;
      },

      formatSlotDate(slot) {
        const d = new Date(slot.start);
        return d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
      },

      formatSlotTime(slot) {
        const start = new Date(slot.start);
        const parts = [start.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' })];
        if (slot.end) {
          const end = new Date(slot.end);
          parts.push(end.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' }));
        }
        return parts.join(' - ');
      },

      async submitVotes() {
        this.submitting = true;
        try {
          const votes = Object.entries(this.myVotes).map(([slot_id, choice]) => ({
            slot_id,
            choice,
          }));
          const resp = await fetch('/api/v1/calendar/polls/shared/' + token + '/vote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              guest_name: this.guestName,
              guest_email: this.guestEmail,
              voter_token: this.voterToken,
              votes,
            }),
          });
          if (resp.ok) {
            const data = await resp.json();
            this.poll = data;
            // Store voter token for future visits
            if (data.voter_token) {
              this.voterToken = data.voter_token;
              localStorage.setItem('poll_voter_' + token, data.voter_token);
            }
            this.votesRestored = false;
            this.voteSubmitted = true;
          }
        } catch (e) {
          console.error('Failed to submit votes', e);
        }
        this.submitting = false;
        this.$nextTick(() => lucide.createIcons());
      },
    };
  };
  </script>
</body>
</html>
