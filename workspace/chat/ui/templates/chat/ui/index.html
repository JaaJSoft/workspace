{% extends 'base_with_navbar.html' %}
{% load static %}

{% block title %}Chat - Workspace{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'chat/ui/css/chat.css' %}">
{% endblock %}

{% block navbar %}
{% include 'ui/partials/navbar.html' with navbar_full_width=True %}
{% endblock %}

{% block drawer_class %}drawer-open{% endblock %}
{% block drawer_id %}chat-drawer{% endblock %}

{% block main_class %}p-0 flex flex-col h-full overflow-hidden{% endblock %}

{% block drawer_attrs %}
x-data="chatApp({{ user.id }})"
x-init="init()"
@chat-message.window="handleSSEMessage($event.detail)"
@chat-message_edited.window="handleSSEMessageEdited($event.detail)"
@chat-message_deleted.window="handleSSEMessageDeleted($event.detail)"
@chat-reaction.window="handleSSEReaction($event.detail)"
@chat-unread.window="handleSSEUnread($event.detail)"
@keydown.window="if ($event.altKey && $event.key === 'n') { $event.preventDefault(); showNewConversationDialog(); }"
{% endblock %}

{% block drawer_sidebar %}
<div class="drawer-side z-40 h-full"
     :style="activeConversation && isMobile() ? 'display:none!important' : ''">
  <label for="chat-drawer" aria-label="close sidebar" class="drawer-overlay"></label>

  <!-- Sidebar -->
  <aside class="bg-base-200 h-full border-r border-base-300 flex flex-col transition-all duration-300"
         :class="collapsed ? 'w-16' : 'w-80'">
    <!-- Sidebar header -->
    <div class="border-b border-base-300 py-4 px-3">
      <div class="flex items-center" :class="collapsed ? 'justify-center' : 'justify-between'">
        <h2 class="text-xl font-semibold flex items-center gap-2" :class="collapsed ? '' : 'pl-2'">
          <i data-lucide="message-circle" class="w-6 h-6 text-info"></i>
          <span x-show="!collapsed" x-transition>Chat</span>
        </h2>
        <button
          x-show="!collapsed" x-transition
          class="btn btn-ghost btn-sm btn-square mr-1 hover:text-info"
          @click="showNewConversationDialog()"
          title="New conversation (Alt+N)"
        >
          <i data-lucide="plus" class="w-4 h-4"></i>
        </button>
      </div>
    </div>

    <!-- Conversation list -->
    <div class="flex-1 overflow-y-auto py-4 px-3">
      {% include "chat/ui/partials/conversation_list.html" %}
    </div>

    <!-- New chat button (visible when collapsed) -->
    <div class="px-3 pb-2" x-show="collapsed" x-cloak>
      <ul class="menu p-0">
        {% include "ui/partials/drawer_item.html" with icon="plus" label="New" color="info" onclick="showNewConversationDialog()" tooltip="New chat" %}
      </ul>
    </div>

    <!-- Collapse toggle -->
    <div class="border-t border-base-300 py-4 px-3">
      <ul class="menu p-0" x-show="!isMobile()">
        {% include "ui/partials/drawer_item.html" with icon_binding="collapsed ? 'panel-left-open' : 'panel-left-close'" label="Collapse" onclick="toggleCollapse()" title_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" aria_label_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" %}
      </ul>
    </div>
  </aside>
</div>
{% endblock %}

{% block content %}
<div class="h-full flex flex-col min-w-0 bg-base-100"
     :style="!activeConversation && isMobile() ? 'display:none!important' : ''">

  <!-- Empty state -->
  <template x-if="!activeConversation">
    {% include "chat/ui/partials/empty_state.html" %}
  </template>

  <template x-if="activeConversation">
    <div class="flex flex-col h-full">
      <!-- Conversation header -->
      <div class="px-4 py-2.5 border-b border-base-300 flex items-center gap-3 bg-base-100">
        <!-- Back button (mobile) -->
        <button
          class="btn btn-ghost btn-sm btn-circle lg:hidden"
          @click="activeConversation = null; history.pushState({}, '', '/chat')"
        >
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
        </button>

        <div x-html="conversationAvatar(activeConversation)"></div>

        <div class="flex-1 min-w-0">
          <h3 class="font-semibold text-sm truncate" x-text="conversationName(activeConversation)"></h3>
          <p class="text-xs text-base-content/60" x-text="membersList(activeConversation)"></p>
        </div>
      </div>

      <!-- Messages -->
      <div
        class="flex-1 overflow-y-auto p-4"
        x-ref="messagesContainer"
        @scroll="handleScroll()"
      >
        <!-- Load more -->
        <div x-show="hasMoreMessages" class="flex justify-center py-2">
          <button
            class="btn btn-ghost btn-xs"
            @click="loadMoreMessages()"
            :disabled="loadingMoreMessages"
          >
            <span x-show="!loadingMoreMessages">Load older messages</span>
            <span x-show="loadingMoreMessages" class="loading loading-spinner loading-xs"></span>
          </button>
        </div>

        <!-- Loading messages -->
        <div x-show="loadingMessages" class="flex justify-center py-8">
          <span class="loading loading-spinner loading-md text-info"></span>
        </div>

        <!-- Server-rendered messages container -->
        <div id="messages-container"></div>
      </div>

      <!-- Input area -->
      <div class="p-3 bg-base-100 border-t border-base-300">
        <!-- Edit mode banner -->
        <div x-show="editingMessageUuid" x-cloak class="flex items-center gap-2 mb-2 px-3 py-1.5 bg-info/10 rounded-lg text-sm">
          <i data-lucide="pencil" class="w-4 h-4 text-info"></i>
          <span class="text-info flex-1">Editing — <kbd class="kbd kbd-xs">Esc</kbd> to cancel</span>
          <button class="btn btn-ghost btn-xs btn-circle" @click="cancelEdit()">
            <i data-lucide="x" class="w-3 h-3"></i>
          </button>
        </div>

        <!-- Input container -->
        <div class="border border-base-300 rounded-xl transition-colors focus-within:border-info/50">
          <!-- Toolbar + Send -->
          <div class="flex items-center gap-0.5 px-2 py-1">
            <!-- Formatting buttons (left) -->
            <button class="btn btn-ghost btn-xs btn-square" title="Bold (Ctrl+B)" @click="wrapSelection('**')">
              <i data-lucide="bold" class="w-3.5 h-3.5"></i>
            </button>
            <button class="btn btn-ghost btn-xs btn-square" title="Italic (Ctrl+I)" @click="wrapSelection('*')">
              <i data-lucide="italic" class="w-3.5 h-3.5"></i>
            </button>
            <button class="btn btn-ghost btn-xs btn-square" title="Strikethrough (Ctrl+Shift+X)" @click="wrapSelection('~~')">
              <i data-lucide="strikethrough" class="w-3.5 h-3.5"></i>
            </button>
            <button class="btn btn-ghost btn-xs btn-square" title="Code (Ctrl+E)" @click="wrapSelection('`')">
              <i data-lucide="code" class="w-3.5 h-3.5"></i>
            </button>
            <button class="btn btn-ghost btn-xs btn-square" title="Insert link" @click="insertLink()">
              <i data-lucide="link" class="w-3.5 h-3.5"></i>
            </button>

            <div class="w-px self-stretch my-1 bg-base-300"></div>

            <!-- Help popover -->
            <div class="dropdown dropdown-top">
              <button class="btn btn-ghost btn-xs btn-square opacity-40 hover:opacity-100" tabindex="0" title="Keyboard shortcuts">
                <i data-lucide="circle-help" class="w-3.5 h-3.5"></i>
              </button>
              <div tabindex="0" class="dropdown-content mb-2 p-3 bg-base-100 border border-base-300 rounded-lg shadow-lg w-56 z-50">
                <p class="text-xs font-semibold mb-1.5">Keyboard shortcuts</p>
                <div class="grid grid-cols-[1fr_auto] gap-x-3 gap-y-1 text-xs text-base-content/70">
                  <span>Send</span>            <kbd class="kbd kbd-xs">Enter</kbd>
                  <span>New line</span>         <kbd class="kbd kbd-xs">Shift+Enter</kbd>
                  <span>Bold</span>             <kbd class="kbd kbd-xs">Ctrl+B</kbd>
                  <span>Italic</span>           <kbd class="kbd kbd-xs">Ctrl+I</kbd>
                  <span>Code</span>             <kbd class="kbd kbd-xs">Ctrl+E</kbd>
                  <span>Strikethrough</span>    <kbd class="kbd kbd-xs">Ctrl+Shift+X</kbd>
                  <span>Edit last msg</span>    <kbd class="kbd kbd-xs">Arrow Up</kbd>
                  <span>Cancel edit</span>      <kbd class="kbd kbd-xs">Esc</kbd>
                  <span>New chat</span>          <kbd class="kbd kbd-xs">Alt+N</kbd>
                </div>
                <p class="text-xs text-base-content/40 mt-2">Markdown supported</p>
              </div>
            </div>

            <div class="flex-1"></div>

            <!-- Emoji picker -->
            <div class="dropdown dropdown-top dropdown-end">
              <button class="btn btn-ghost btn-xs btn-square" tabindex="0" title="Emoji">
                <i data-lucide="smile" class="w-3.5 h-3.5"></i>
              </button>
              <div
                tabindex="0"
                class="dropdown-content mb-2 p-2 bg-base-100 border border-base-300 rounded-lg shadow-lg flex gap-1"
              >
                <template x-for="emoji in quickEmojis" :key="emoji">
                  <button
                    class="btn btn-ghost btn-sm"
                    @click="insertEmoji(emoji)"
                    x-text="emoji"
                  ></button>
                </template>
              </div>
            </div>

            <!-- Attach placeholder -->
            <button class="btn btn-ghost btn-xs btn-square" title="Attach file — Coming soon" disabled>
              <i data-lucide="paperclip" class="w-3.5 h-3.5"></i>
            </button>

            <div class="w-px self-stretch my-1 bg-base-300"></div>

            <!-- Send button -->
            <button
              class="btn btn-info btn-sm btn-circle"
              @click="sendOrEdit()"
              :disabled="!messageBody.trim()"
            >
              <i data-lucide="send" class="w-3.5 h-3.5"></i>
            </button>
          </div>

          <!-- Textarea -->
          <textarea
            x-ref="messageInput"
            x-model="messageBody"
            @keydown="handleInputKeydown($event)"
            @input="autoResize($el)"
            class="textarea textarea-ghost w-full min-h-[2.5rem] max-h-[8rem] resize-none leading-snug px-3 py-1.5 focus:outline-none"
            placeholder="Type a message..."
            rows="1"
          ></textarea>
        </div>
      </div>
    </div>
  </template>
</div>

<!-- New conversation dialog -->
{% include "chat/ui/partials/new_conversation_dialog.html" %}

<!-- Embedded conversation data for fast Alpine init -->
<script id="conversations-data" type="application/json">{{ conversations_json|safe }}</script>
{% if initial_conversation_uuid %}<script id="initial-conversation" type="application/json">"{{ initial_conversation_uuid }}"</script>{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'chat/ui/js/chat.js' %}"></script>
{% endblock %}
