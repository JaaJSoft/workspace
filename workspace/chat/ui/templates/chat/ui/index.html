{% extends 'base_with_navbar.html' %}
{% load static %}

{% block title %}Chat - Workspace{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'chat/ui/css/chat.css' %}">
{% endblock %}

{% block navbar %}
{% include 'ui/partials/navbar.html' with navbar_full_width=True %}
{% endblock %}

{% block drawer_class %}drawer-open{% endblock %}
{% block drawer_id %}chat-drawer{% endblock %}

{% block main_class %}p-0 flex flex-col h-full overflow-hidden{% endblock %}

{% block drawer_attrs %}
x-data="chatApp({{ user.id }})"
x-init="init()"
@chat-message.window="handleSSEMessage($event.detail)"
@chat-message_edited.window="handleSSEMessageEdited($event.detail)"
@chat-message_deleted.window="handleSSEMessageDeleted($event.detail)"
@chat-reaction.window="handleSSEReaction($event.detail)"
@chat-unread.window="handleSSEUnread($event.detail)"
{% endblock %}

{% block drawer_sidebar %}
<div class="drawer-side z-40 h-full"
     :style="activeConversation && isMobile() ? 'display:none!important' : ''">
  <label for="chat-drawer" aria-label="close sidebar" class="drawer-overlay"></label>

  <!-- Sidebar -->
  <aside class="bg-base-200 h-full border-r border-base-300 flex flex-col transition-all duration-300"
         :class="collapsed ? 'w-16' : 'w-80'">
    <!-- Sidebar header -->
    <div class="border-b border-base-300 py-4 px-3">
      <div class="flex items-center" :class="collapsed ? 'justify-center' : 'justify-between'">
        <h2 class="text-xl font-semibold flex items-center gap-2" :class="collapsed ? '' : 'pl-2'">
          <i data-lucide="message-circle" class="w-6 h-6 text-info"></i>
          <span x-show="!collapsed" x-transition>Chat</span>
        </h2>
        <button
          x-show="!collapsed" x-transition
          class="btn btn-ghost btn-sm btn-square mr-1 hover:text-info"
          @click="showNewConversationDialog()"
          title="New conversation"
        >
          <i data-lucide="plus" class="w-4 h-4"></i>
        </button>
      </div>
    </div>

    <!-- Conversation list -->
    <div class="flex-1 overflow-y-auto py-4 px-3">
      {% include "chat/ui/partials/conversation_list.html" %}
    </div>

    <!-- New chat button (visible when collapsed) -->
    <div class="px-3 pb-2" x-show="collapsed" x-cloak>
      <ul class="menu p-0">
        {% include "ui/partials/drawer_item.html" with icon="plus" label="New" color="info" onclick="showNewConversationDialog()" tooltip="New chat" %}
      </ul>
    </div>

    <!-- Collapse toggle -->
    <div class="border-t border-base-300 py-4 px-3">
      <ul class="menu p-0" x-show="!isMobile()">
        {% include "ui/partials/drawer_item.html" with icon_binding="collapsed ? 'panel-left-open' : 'panel-left-close'" label="Collapse" onclick="toggleCollapse()" title_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" aria_label_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" %}
      </ul>
    </div>
  </aside>
</div>
{% endblock %}

{% block content %}
<div class="h-full flex flex-col min-w-0 bg-base-100"
     :style="!activeConversation && isMobile() ? 'display:none!important' : ''">

  <!-- Empty state -->
  <template x-if="!activeConversation">
    {% include "chat/ui/partials/empty_state.html" %}
  </template>

  <template x-if="activeConversation">
    <div class="flex flex-col h-full">
      <!-- Conversation header -->
      <div class="px-4 py-2.5 border-b border-base-300 flex items-center gap-3 bg-base-100">
        <!-- Back button (mobile) -->
        <button
          class="btn btn-ghost btn-sm btn-circle lg:hidden"
          @click="activeConversation = null; history.pushState({}, '', '/chat')"
        >
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
        </button>

        <div x-html="conversationAvatar(activeConversation)"></div>

        <div class="flex-1 min-w-0">
          <h3 class="font-semibold text-sm truncate" x-text="conversationName(activeConversation)"></h3>
          <p class="text-xs text-base-content/60" x-text="membersList(activeConversation)"></p>
        </div>
      </div>

      <!-- Messages -->
      <div
        class="flex-1 overflow-y-auto p-4"
        x-ref="messagesContainer"
        @scroll="handleScroll()"
      >
        <!-- Load more -->
        <div x-show="hasMoreMessages" class="flex justify-center py-2">
          <button
            class="btn btn-ghost btn-xs"
            @click="loadMoreMessages()"
            :disabled="loadingMoreMessages"
          >
            <span x-show="!loadingMoreMessages">Load older messages</span>
            <span x-show="loadingMoreMessages" class="loading loading-spinner loading-xs"></span>
          </button>
        </div>

        <!-- Loading messages -->
        <div x-show="loadingMessages" class="flex justify-center py-8">
          <span class="loading loading-spinner loading-md text-info"></span>
        </div>

        <!-- Server-rendered messages container -->
        <div id="messages-container"></div>
      </div>

      <!-- Input area -->
      <div class="border-t border-base-300 p-3 bg-base-100">
        <!-- Edit mode banner -->
        <div x-show="editingMessageUuid" x-cloak class="flex items-center gap-2 mb-2 px-2 py-1 bg-info/10 rounded text-sm">
          <i data-lucide="pencil" class="w-4 h-4 text-info"></i>
          <span class="text-info flex-1">Editing message</span>
          <button class="btn btn-ghost btn-xs btn-circle" @click="cancelEdit()">
            <i data-lucide="x" class="w-3 h-3"></i>
          </button>
        </div>

        <div class="flex items-end gap-2">
          <!-- Emoji picker -->
          <div class="dropdown dropdown-top">
            <button class="btn btn-ghost btn-sm btn-circle" tabindex="0">
              <i data-lucide="smile" class="w-5 h-5"></i>
            </button>
            <div
              tabindex="0"
              class="dropdown-content mb-2 p-2 bg-base-100 border border-base-300 rounded-lg shadow-lg flex gap-1"
            >
              <template x-for="emoji in quickEmojis" :key="emoji">
                <button
                  class="btn btn-ghost btn-sm"
                  @click="insertEmoji(emoji)"
                  x-text="emoji"
                ></button>
              </template>
            </div>
          </div>

          <!-- Textarea -->
          <textarea
            x-ref="messageInput"
            x-model="messageBody"
            @keydown.enter.exact.prevent="sendOrEdit()"
            @input="autoResize($el)"
            class="textarea textarea-bordered flex-1 min-h-[2.5rem] max-h-[8rem] resize-none leading-snug py-2"
            placeholder="Type a message..."
            rows="1"
          ></textarea>

          <!-- Send button -->
          <button
            class="btn btn-info btn-sm btn-circle"
            @click="sendOrEdit()"
            :disabled="!messageBody.trim()"
          >
            <i data-lucide="send" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </div>
  </template>
</div>

<!-- New conversation dialog -->
{% include "chat/ui/partials/new_conversation_dialog.html" %}

<!-- Embedded conversation data for fast Alpine init -->
<script id="conversations-data" type="application/json">{{ conversations_json|safe }}</script>
{% if initial_conversation_uuid %}<script id="initial-conversation" type="application/json">"{{ initial_conversation_uuid }}"</script>{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'chat/ui/js/chat.js' %}"></script>
{% endblock %}
