{% extends 'base_with_navbar.html' %}
{% load static %}

{% block title %}Chat â€” Workspace{% endblock %}

{% block drawer_class %}lg:drawer-open{% endblock %}
{% block main_class %}p-0{% endblock %}
{% block main_layout_class %}flex-1 min-h-0 flex{% endblock %}

{% block content %}
<div
  class="flex w-full h-full"
  x-data="chatApp({{ user.id }})"
  x-init="init()"
  @chat-message.window="handleSSEMessage($event.detail)"
  @chat-message_edited.window="handleSSEMessageEdited($event.detail)"
  @chat-message_deleted.window="handleSSEMessageDeleted($event.detail)"
  @chat-reaction.window="handleSSEReaction($event.detail)"
  @chat-unread.window="handleSSEUnread($event.detail)"
>
  <!-- Sidebar -->
  <div
    class="w-80 flex-shrink-0 border-r border-base-300 flex flex-col h-full bg-base-100"
    :class="{ 'hidden lg:flex': activeConversation }"
  >
    <!-- Sidebar header -->
    <div class="p-3 border-b border-base-300 flex items-center justify-between">
      <h2 class="font-semibold text-lg">Chat</h2>
      <button
        class="btn btn-ghost btn-sm btn-circle hover:bg-info/10 hover:text-info"
        @click="showNewConversationDialog()"
        title="New conversation"
      >
        <i data-lucide="plus" class="w-5 h-5"></i>
      </button>
    </div>

    <!-- Conversation list -->
    <div class="flex-1 overflow-y-auto">
      <template x-if="conversations.length === 0 && !loadingConversations">
        <div class="p-6 text-center">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-info/10 flex items-center justify-center">
            <i data-lucide="message-circle" class="w-8 h-8 text-info"></i>
          </div>
          <h3 class="font-semibold text-base-content/80 mb-1">No conversations yet</h3>
          <p class="text-sm text-base-content/60 mb-4">Start a new chat to begin messaging</p>
          <button
            class="btn btn-info btn-sm"
            @click="showNewConversationDialog()"
          >
            <i data-lucide="plus" class="w-4 h-4"></i>
            New chat
          </button>
        </div>
      </template>

      <template x-if="loadingConversations">
        <div class="flex justify-center p-8">
          <span class="loading loading-spinner loading-md text-info"></span>
        </div>
      </template>

      <ul class="menu menu-sm p-1">
        <template x-for="conv in conversations" :key="conv.uuid">
          <li>
            <button
              type="button"
              class="flex items-center gap-3 rounded-lg py-3 px-3 w-full transition-colors"
              :class="activeConversation?.uuid === conv.uuid ? 'bg-info/10 text-info' : 'hover:bg-base-200'"
              @click="selectConversation(conv)"
            >
              <!-- Avatar -->
              <div class="flex-shrink-0" x-html="conversationAvatar(conv)"></div>

              <!-- Content -->
              <div class="flex-1 min-w-0 text-left">
                <div class="flex items-center justify-between gap-1">
                  <span class="font-medium text-sm truncate" x-text="conversationName(conv)"></span>
                  <span
                    class="text-xs text-base-content/50 flex-shrink-0"
                    x-text="conv.last_message ? timeAgo(conv.last_message.created_at) : ''"
                  ></span>
                </div>
                <div class="flex items-center justify-between gap-1 mt-0.5">
                  <span
                    class="text-xs text-base-content/60 truncate"
                    x-text="conv.last_message ? (conv.last_message.author.username + ': ' + truncate(conv.last_message.body, 40)) : 'No messages yet'"
                  ></span>
                  <span
                    x-show="conv.unread_count > 0"
                    class="badge badge-info badge-xs flex-shrink-0"
                    x-text="conv.unread_count"
                    x-cloak
                  ></span>
                </div>
              </div>
            </button>
          </li>
        </template>
      </ul>
    </div>
  </div>

  <!-- Messages area -->
  <div
    class="flex-1 flex flex-col h-full min-w-0"
    :class="{ 'hidden lg:flex': !activeConversation }"
  >
    <template x-if="!activeConversation">
      {% include "chat/ui/partials/empty_state.html" %}
    </template>

    <template x-if="activeConversation">
      <div class="flex flex-col h-full">
        <!-- Conversation header -->
        <div class="px-4 py-2.5 border-b border-base-300 flex items-center gap-3 bg-base-100">
          <!-- Back button (mobile) -->
          <button
            class="btn btn-ghost btn-sm btn-circle lg:hidden"
            @click="activeConversation = null"
          >
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
          </button>

          <div x-html="conversationAvatar(activeConversation)"></div>

          <div class="flex-1 min-w-0">
            <h3 class="font-semibold text-sm truncate" x-text="conversationName(activeConversation)"></h3>
            <p class="text-xs text-base-content/60" x-text="membersList(activeConversation)"></p>
          </div>
        </div>

        <!-- Messages -->
        <div
          class="flex-1 overflow-y-auto p-4 space-y-1"
          x-ref="messagesContainer"
          @scroll="handleScroll()"
        >
          <!-- Load more -->
          <div x-show="hasMoreMessages" class="flex justify-center py-2">
            <button
              class="btn btn-ghost btn-xs"
              @click="loadMoreMessages()"
              :disabled="loadingMoreMessages"
            >
              <span x-show="!loadingMoreMessages">Load older messages</span>
              <span x-show="loadingMoreMessages" class="loading loading-spinner loading-xs"></span>
            </button>
          </div>

          <!-- Loading messages -->
          <div x-show="loadingMessages" class="flex justify-center py-8">
            <span class="loading loading-spinner loading-md text-info"></span>
          </div>

          <!-- Message bubbles -->
          <template x-for="(msg, index) in messages" :key="msg.uuid">
            <div>
              <!-- New messages separator -->
              <template x-if="msg._isNewSeparator">
                <div class="divider text-xs text-info my-2">New messages</div>
              </template>

              <!-- Deleted message -->
              <template x-if="msg.deleted_at">
                <div class="chat" :class="msg.author.id === currentUserId ? 'chat-end' : 'chat-start'">
                  <div class="chat-bubble bg-base-200 text-base-content/40 text-sm italic">
                    Message deleted
                  </div>
                </div>
              </template>

              <!-- Normal message -->
              <template x-if="!msg.deleted_at">
                <div class="chat" :class="msg.author.id === currentUserId ? 'chat-end' : 'chat-start'">
                  <!-- Avatar -->
                  <div class="chat-image">
                    <div class="avatar placeholder">
                      <div class="w-8 h-8 rounded-full bg-neutral text-neutral-content">
                        <span class="text-xs" x-text="msg.author.username[0].toUpperCase()"></span>
                      </div>
                    </div>
                  </div>

                  <!-- Header -->
                  <div class="chat-header text-xs mb-0.5">
                    <span class="font-medium" x-text="msg.author.username"></span>
                    <time class="text-base-content/50 ml-1" x-text="formatTime(msg.created_at)"></time>
                    <span x-show="msg.edited_at" class="text-base-content/40 ml-1 italic" x-cloak>(edited)</span>
                  </div>

                  <!-- Body -->
                  <div
                    class="chat-bubble relative group"
                    :class="msg.author.id === currentUserId ? 'chat-bubble-info' : ''"
                  >
                    <div class="text-sm" x-html="msg.body_html"></div>

                    <!-- Actions on hover (own messages) -->
                    <div
                      x-show="msg.author.id === currentUserId"
                      class="absolute -top-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-0.5"
                      :class="msg.author.id === currentUserId ? '-left-16' : '-right-16'"
                      x-cloak
                    >
                      <button
                        class="btn btn-ghost btn-xs btn-circle"
                        @click="startEdit(msg)"
                        title="Edit"
                      >
                        <i data-lucide="pencil" class="w-3 h-3"></i>
                      </button>
                      <button
                        class="btn btn-ghost btn-xs btn-circle text-error"
                        @click="deleteMessage(msg)"
                        title="Delete"
                      >
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                      </button>
                    </div>
                  </div>

                  <!-- Reactions -->
                  <div class="chat-footer mt-1 flex flex-wrap gap-1 items-center">
                    <template x-for="group in groupReactions(msg)" :key="group.emoji">
                      <button
                        class="badge badge-sm cursor-pointer transition-colors"
                        :class="group.hasCurrentUser ? 'badge-info' : 'badge-ghost hover:badge-info/50'"
                        @click="toggleReaction(msg.uuid, group.emoji)"
                        :title="group.users.join(', ')"
                      >
                        <span x-text="group.emoji"></span>
                        <span class="ml-0.5" x-text="group.count" x-show="group.count > 1"></span>
                      </button>
                    </template>

                    <!-- Add reaction button -->
                    <div class="dropdown dropdown-top" x-data="{ open: false }">
                      <button
                        class="btn btn-ghost btn-xs btn-circle opacity-0 group-hover:opacity-100 transition-opacity"
                        @click="open = !open"
                      >
                        <i data-lucide="smile-plus" class="w-3 h-3"></i>
                      </button>
                      <div
                        x-show="open"
                        x-cloak
                        @click.outside="open = false"
                        class="dropdown-content mb-1 p-1 bg-base-100 border border-base-300 rounded-lg shadow-lg flex gap-0.5"
                      >
                        <template x-for="emoji in quickEmojis" :key="emoji">
                          <button
                            class="btn btn-ghost btn-xs"
                            @click="toggleReaction(msg.uuid, emoji); open = false"
                            x-text="emoji"
                          ></button>
                        </template>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>

        <!-- Input area -->
        <div class="border-t border-base-300 p-3 bg-base-100">
          <!-- Edit mode banner -->
          <div x-show="editingMessage" x-cloak class="flex items-center gap-2 mb-2 px-2 py-1 bg-info/10 rounded text-sm">
            <i data-lucide="pencil" class="w-4 h-4 text-info"></i>
            <span class="text-info flex-1">Editing message</span>
            <button class="btn btn-ghost btn-xs btn-circle" @click="cancelEdit()">
              <i data-lucide="x" class="w-3 h-3"></i>
            </button>
          </div>

          <div class="flex items-end gap-2">
            <!-- Emoji picker -->
            <div class="dropdown dropdown-top">
              <button class="btn btn-ghost btn-sm btn-circle" tabindex="0">
                <i data-lucide="smile" class="w-5 h-5"></i>
              </button>
              <div
                tabindex="0"
                class="dropdown-content mb-2 p-2 bg-base-100 border border-base-300 rounded-lg shadow-lg flex gap-1"
              >
                <template x-for="emoji in quickEmojis" :key="emoji">
                  <button
                    class="btn btn-ghost btn-sm"
                    @click="insertEmoji(emoji)"
                    x-text="emoji"
                  ></button>
                </template>
              </div>
            </div>

            <!-- Textarea -->
            <textarea
              x-ref="messageInput"
              x-model="messageBody"
              @keydown.enter.exact.prevent="sendOrEdit()"
              @input="autoResize($el)"
              class="textarea textarea-bordered flex-1 min-h-[2.5rem] max-h-[8rem] resize-none leading-snug py-2"
              placeholder="Type a message..."
              rows="1"
            ></textarea>

            <!-- Send button -->
            <button
              class="btn btn-info btn-sm btn-circle"
              @click="sendOrEdit()"
              :disabled="!messageBody.trim()"
            >
              <i data-lucide="send" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
      </div>
    </template>
  </div>

  <!-- New conversation dialog -->
  {% include "chat/ui/partials/new_conversation_dialog.html" %}
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'chat/ui/js/chat.js' %}"></script>
{% endblock %}
