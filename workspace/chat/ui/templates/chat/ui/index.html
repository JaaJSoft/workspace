{% extends 'base_with_navbar.html' %}
{% load static %}

{% block title %}Chat - Workspace{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'chat/ui/css/chat.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css" integrity="sha384-6LFfkTKLRlzFtgx8xsWyBdKGpcMMQTkv+dB7rAbugeJAu1Ym2q1Aji1cjHBG12Xh" crossorigin="anonymous" />
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
{% endblock %}

{% block navbar %}
{% include 'ui/partials/navbar.html' with navbar_full_width=True %}
{% endblock %}

{% block drawer_class %}drawer-open{% endblock %}
{% block drawer_id %}chat-drawer{% endblock %}

{% block main_class %}p-0 flex flex-col h-full overflow-hidden{% endblock %}

{% block drawer_attrs %}
x-data="chatApp({{ user.id }})"
x-init="init()"
@chat-message.window="handleSSEMessage($event.detail)"
@chat-message_edited.window="handleSSEMessageEdited($event.detail)"
@chat-message_deleted.window="handleSSEMessageDeleted($event.detail)"
@chat-reaction.window="handleSSEReaction($event.detail)"
@chat-unread.window="handleSSEUnread($event.detail)"
@chat-message_pinned.window="handleSSEMessagePinned($event.detail)"
@chat-read.window="handleSSERead($event.detail)"
@keydown.window="
  if ($event.altKey && $event.key === 'n') { $event.preventDefault(); showNewConversationDialog(); }
  if (($event.ctrlKey || $event.metaKey) && $event.key === 'f' && activeConversation) { $event.preventDefault(); toggleSearchPanel(); }
  if ($event.altKey && $event.key === 'i' && activeConversation) { $event.preventDefault(); toggleInfoPanel(); }
"
{% endblock %}

{% block drawer_sidebar %}
<div class="drawer-side z-40 h-full"
     :style="activeConversation && isMobile() ? 'display:none!important' : ''">
  <label for="chat-drawer" aria-label="close sidebar" class="drawer-overlay"></label>

  <!-- Sidebar -->
  <aside class="bg-base-200 h-full border-r border-base-300 flex flex-col transition-all duration-300"
         :class="collapsed ? 'w-16' : 'w-80'">
    <!-- Sidebar header -->
    <div class="border-b border-base-300 py-4 px-3">
      <div class="flex items-center" :class="collapsed ? 'justify-center' : 'justify-between'">
        <h2 class="text-xl font-semibold flex items-center gap-2" :class="collapsed ? '' : 'pl-2'">
          <i data-lucide="message-circle" class="w-6 h-6 text-info"></i>
          <span x-show="!collapsed" x-transition>Chat</span>
        </h2>
        <div x-show="!collapsed" x-transition class="flex items-center gap-0.5">
          {% if ai_enabled %}
          <button
            class="btn btn-ghost btn-sm btn-square hover:text-secondary"
            @click="showBotPicker = true"
            title="New AI Chat"
          >
            <i data-lucide="sparkles" class="w-4 h-4"></i>
          </button>
          {% endif %}
          <button
            class="btn btn-ghost btn-sm btn-square mr-1 hover:text-info"
            @click="showNewConversationDialog()"
            title="New conversation (Alt+N)"
          >
            <i data-lucide="plus" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Conversation list -->
    <div class="flex-1 overflow-y-auto py-4 px-3">
      {% include "chat/ui/partials/conversation_list.html" %}
    </div>

    <!-- New chat button (visible when collapsed) -->
    <div class="px-3 pb-2" x-show="collapsed" x-cloak>
      <ul class="menu p-0">
        {% include "ui/partials/drawer_item.html" with icon="plus" label="New" color="info" onclick="showNewConversationDialog()" tooltip="New chat" %}
      </ul>
    </div>

    <!-- Help button -->
    <div class="px-3 pb-2">
      <ul class="menu p-0">
        {% include "ui/partials/drawer_item.html" with icon="circle-help" label="Help" color="info" onclick="document.getElementById('chat-help-dialog').showModal()" tooltip="Help" %}
      </ul>
    </div>

    <!-- Collapse toggle -->
    <div class="border-t border-base-300 py-4 px-3">
      <ul class="menu p-0" x-show="!isMobile()">
        {% include "ui/partials/drawer_item.html" with icon_binding="collapsed ? 'panel-left-open' : 'panel-left-close'" label="Collapse" color="info" onclick="toggleCollapse()" title_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" aria_label_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" %}
      </ul>
    </div>
  </aside>
</div>
{% endblock %}

{% block content %}
<div class="h-full flex flex-col min-w-0 bg-base-100"
     :style="!activeConversation && isMobile() ? 'display:none!important' : ''">

  <!-- Empty state -->
  <template x-if="!activeConversation">
    {% include "chat/ui/partials/empty_state.html" %}
  </template>

  <template x-if="activeConversation">
    <div class="flex flex-col h-full">
      <!-- Conversation header -->
      <div class="px-4 py-2.5 border-b border-base-300 flex items-center gap-3 bg-base-100">
        <!-- Back button (mobile) -->
        <button
          class="btn btn-ghost btn-sm btn-circle lg:hidden"
          @click="activeConversation = null; history.pushState({}, '', '/chat')"
        >
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
        </button>

        <div x-html="conversationAvatar(activeConversation)"></div>

        <div class="flex-1 min-w-0">
          <h3 class="font-semibold text-sm truncate" x-text="conversationName(activeConversation)"></h3>
          <p class="text-xs text-base-content/60 truncate">
            <span x-text="membersList(activeConversation)"></span>
            <template x-if="activeConversation.description">
              <span>
                -
                <button
                  class="inline-flex align-middle opacity-50 hover:opacity-100"
                  @click="editDescription()"
                  :title="'Edit description'"
                >
                  <i data-lucide="align-left" class="w-2.5 h-2.5"></i>
                </button>
                <span x-text="activeConversation.description"></span>
              </span>
            </template>
            <template x-if="!activeConversation.description">
              <button
                class="inline-flex align-middle opacity-50 hover:opacity-100 ml-1"
                @click="editDescription()"
                title="Add description"
              >
                <i data-lucide="align-left" class="w-2.5 h-2.5"></i>
              </button>
            </template>
          </p>
        </div>

        <!-- Header actions -->
        <div class="flex items-center gap-0.5">
          <button
            class="btn btn-ghost btn-sm btn-circle"
            :class="showSearchPanel ? 'bg-base-200' : ''"
            @click="toggleSearchPanel()"
            title="Search in conversation (Ctrl+F)"
          >
            <i data-lucide="search" class="w-4 h-4"></i>
          </button>
          <button class="btn btn-ghost btn-sm btn-circle" title="Mute notifications — Coming soon" disabled>
            <i data-lucide="bell-off" class="w-4 h-4"></i>
          </button>
          <button
            class="btn btn-ghost btn-sm btn-circle"
            :class="showInfoPanel ? 'bg-base-200' : ''"
            @click="toggleInfoPanel()"
            title="Conversation info (Alt+I)"
          >
            <i data-lucide="info" class="w-4 h-4"></i>
          </button>
        </div>
      </div>

      <!-- Content area: messages + optional info panel -->
      <div class="flex-1 flex min-h-0 min-w-0">
        <!-- Messages column -->
        <div class="flex-1 flex flex-col min-w-0 relative">
          <!-- Pinned messages banner -->
          <div x-show="pinnedMessages.length > 0" x-cloak
               class="px-4 py-2 bg-warning/10 border-b border-warning/20 flex items-center gap-2 cursor-pointer hover:bg-warning/15 transition-colors"
               @click="showInfoPanel = true; closeSearchPanel(); $nextTick(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); if (activeConversation) loadConversationStats(activeConversation.uuid); document.getElementById('pinned-messages-section')?.scrollIntoView({ behavior: 'smooth' }); })">
            <i data-lucide="pin" class="w-4 h-4 text-warning flex-shrink-0"></i>
            <span class="text-sm truncate flex-1" x-text="pinnedMessages[0]?.message_body || 'Pinned message'"></span>
            <span x-show="pinnedMessages.length > 1" class="badge badge-warning badge-sm" x-text="pinnedMessages.length + ' pins'"></span>
            <i data-lucide="chevron-right" class="w-4 h-4 text-base-content/40 flex-shrink-0"></i>
          </div>

          <!-- Messages -->
          <div
            class="flex-1 overflow-y-auto overflow-x-hidden p-4"
            x-ref="messagesContainer"
            @scroll="handleScroll()"
            @dragenter.prevent="handleDragEnter($event)"
            @dragover.prevent="handleDragOver($event)"
            @dragleave.prevent="handleDragLeave($event)"
            @drop.prevent="handleDrop($event)"
          >
            <!-- Load more -->
            <div x-show="hasMoreMessages" class="flex justify-center py-2">
              <button
                class="btn btn-ghost btn-xs"
                @click="loadMoreMessages()"
                :disabled="loadingMoreMessages"
              >
                <span x-show="!loadingMoreMessages">Load older messages</span>
                <span x-show="loadingMoreMessages" class="loading loading-spinner loading-xs"></span>
              </button>
            </div>

            <!-- Loading messages -->
            <div x-show="loadingMessages" class="flex justify-center py-8">
              <span class="loading loading-spinner loading-md text-info"></span>
            </div>

            <!-- Server-rendered messages container -->
            <div id="messages-container"></div>

            <!-- Bot typing indicator -->
            <div x-show="botTyping" x-cloak
                 x-effect="if (botTyping) $nextTick(() => lucide.createIcons())"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 class="flex gap-2 mb-3">
              <!-- Bot avatar -->
              <div class="flex-shrink-0 w-8 mt-auto" x-html="botTypingAvatar()"></div>
              <!-- Content column -->
              <div class="flex flex-col items-start gap-0.5 min-w-0">
                <div class="flex items-center gap-1.5 px-1 text-xs">
                  <span class="font-semibold text-base-content" x-text="botTypingName()"></span>
                  <span class="badge badge-xs badge-secondary gap-0.5">AI</span>
                </div>
                <div class="msg-bubble rounded-2xl px-6 py-3 bg-base-200 relative overflow-hidden min-w-[5rem]">
                  <div class="bot-typing-shimmer"></div>
                  <div class="flex items-center justify-center gap-2.5 relative">
                    <span class="bot-typing-dot"></span>
                    <span class="bot-typing-dot"></span>
                    <span class="bot-typing-dot"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Drag-drop overlay -->
          <div x-show="isDraggingOver" x-cloak
               class="absolute inset-0 z-50 flex items-center justify-center bg-base-100/80 border-2 border-dashed border-info rounded-xl pointer-events-none">
            <div class="text-center">
              <i data-lucide="upload" class="w-8 h-8 text-info mx-auto mb-2"></i>
              <p class="text-sm font-medium text-info">Drop files to attach</p>
            </div>
          </div>

          <!-- Input area -->
          <div class="p-3 bg-base-100 border-t border-base-300"
               @dragenter.prevent="handleDragEnter($event)"
               @dragover.prevent="handleDragOver($event)"
               @dragleave.prevent="handleDragLeave($event)"
               @drop.prevent="handleDrop($event)">

            <!-- Reply preview banner -->
            <div x-show="replyingTo" x-cloak x-transition
                 class="flex items-center gap-2 mb-2 px-3 py-1.5 bg-info/10 rounded-lg text-sm">
              <i data-lucide="reply" class="w-4 h-4 text-info flex-shrink-0"></i>
              <div class="flex-1 min-w-0">
                <span class="text-info font-semibold text-xs" x-text="'Replying to ' + (replyingTo?.author || '')"></span>
                <p class="text-xs text-base-content/60 truncate" x-text="replyingTo?.body || ''"></p>
              </div>
              <button class="btn btn-ghost btn-xs btn-circle flex-shrink-0" @click="cancelReply()" title="Cancel reply (Esc)">
                <i data-lucide="x" class="w-3 h-3"></i>
              </button>
            </div>

            <!-- Edit mode banner -->
            <div x-show="editingMessageUuid" x-cloak class="flex items-center gap-2 mb-2 px-3 py-1.5 bg-info/10 rounded-lg text-sm">
              <i data-lucide="pencil" class="w-4 h-4 text-info"></i>
              <span class="text-info flex-1">Editing — <kbd class="kbd kbd-xs">Esc</kbd> to cancel</span>
              <button class="btn btn-ghost btn-xs btn-circle" @click="cancelEdit()">
                <i data-lucide="x" class="w-3 h-3"></i>
              </button>
            </div>

            <!-- Pending files preview -->
            <div x-show="pendingFiles.length > 0" x-cloak class="mb-2 flex flex-wrap gap-2 px-1">
              <template x-for="(file, idx) in pendingFiles" :key="idx">
                <div class="relative group/file">
                  <template x-if="isImageFile(file)">
                    <div class="w-16 h-16 rounded-lg overflow-hidden border border-base-300 bg-base-200">
                      <img :src="file._preview" class="w-full h-full object-cover" />
                    </div>
                  </template>
                  <template x-if="!isImageFile(file)">
                    <div class="flex items-center gap-1.5 px-2 py-1.5 rounded-lg border border-base-300 bg-base-200 text-xs max-w-[10rem]">
                      <i data-lucide="file" class="w-3.5 h-3.5 flex-shrink-0"></i>
                      <span class="truncate" x-text="file.name"></span>
                      <span class="text-base-content/50 flex-shrink-0" x-text="formatFileSize(file.size)"></span>
                    </div>
                  </template>
                  <button
                    @click="removeFile(idx)"
                    class="absolute -top-1.5 -right-1.5 btn btn-circle btn-xs bg-base-300 border-base-300 hover:bg-error hover:text-error-content opacity-0 group-hover/file:opacity-100 transition-opacity"
                  >
                    <i data-lucide="x" class="w-3 h-3"></i>
                  </button>
                </div>
              </template>
            </div>

        <!-- Input container -->
        <div class="border border-base-300 rounded-xl transition-colors focus-within:border-info/50">
          <!-- Toolbar + Send -->
          <div class="flex items-center gap-0.5 px-2 py-1">
            <!-- Formatting buttons (left) -->
            <button class="btn btn-ghost btn-xs btn-square" title="Bold (Ctrl+B)" @click="wrapSelection('**')">
              <i data-lucide="bold" class="w-3.5 h-3.5"></i>
            </button>
            <button class="btn btn-ghost btn-xs btn-square" title="Italic (Ctrl+I)" @click="wrapSelection('*')">
              <i data-lucide="italic" class="w-3.5 h-3.5"></i>
            </button>
            <button class="btn btn-ghost btn-xs btn-square" title="Strikethrough (Ctrl+Shift+X)" @click="wrapSelection('~~')">
              <i data-lucide="strikethrough" class="w-3.5 h-3.5"></i>
            </button>
            <button class="btn btn-ghost btn-xs btn-square" title="Code (Ctrl+E)" @click="wrapSelection('`')">
              <i data-lucide="code" class="w-3.5 h-3.5"></i>
            </button>
            <button class="btn btn-ghost btn-xs btn-square" title="Insert link" @click="insertLink()">
              <i data-lucide="link" class="w-3.5 h-3.5"></i>
            </button>

            <div class="w-px self-stretch my-1 bg-base-300"></div>

            <!-- Help popover -->
            <div class="dropdown dropdown-top">
              <button class="btn btn-ghost btn-xs btn-square opacity-40 hover:opacity-100" tabindex="0" title="Keyboard shortcuts">
                <i data-lucide="circle-help" class="w-3.5 h-3.5"></i>
              </button>
              <div tabindex="0" class="dropdown-content mb-2 p-3 bg-base-100 border border-base-300 rounded-lg shadow-lg w-56 z-50">
                <p class="text-xs font-semibold mb-1.5">Keyboard shortcuts</p>
                <div class="grid grid-cols-[1fr_auto] gap-x-3 gap-y-1 text-xs text-base-content/70">
                  <span>Send</span>            <kbd class="kbd kbd-xs">Enter</kbd>
                  <span>New line</span>         <kbd class="kbd kbd-xs">Shift+Enter</kbd>
                  <span>Bold</span>             <kbd class="kbd kbd-xs">Ctrl+B</kbd>
                  <span>Italic</span>           <kbd class="kbd kbd-xs">Ctrl+I</kbd>
                  <span>Code</span>             <kbd class="kbd kbd-xs">Ctrl+E</kbd>
                  <span>Strikethrough</span>    <kbd class="kbd kbd-xs">Ctrl+Shift+X</kbd>
                  <span>Edit last msg</span>    <kbd class="kbd kbd-xs">Arrow Up</kbd>
                  <span>Cancel edit</span>      <kbd class="kbd kbd-xs">Esc</kbd>
                  <span>Search messages</span>   <kbd class="kbd kbd-xs">Ctrl+F</kbd>
                  <span>Conversation info</span> <kbd class="kbd kbd-xs">Alt+I</kbd>
                  <span>New chat</span>          <kbd class="kbd kbd-xs">Alt+N</kbd>
                </div>
                <p class="text-xs text-base-content/40 mt-2">Markdown supported</p>
              </div>
            </div>

            <div class="flex-1"></div>

            <!-- Emoji picker -->
            <button class="btn btn-ghost btn-xs btn-square" title="Emoji" @click="openEmojiPicker('input', $event)">
              <i data-lucide="smile" class="w-3.5 h-3.5"></i>
            </button>

            <!-- Attach file -->
            <button class="btn btn-ghost btn-xs btn-square" title="Attach file" @click="openFileDialog()">
              <i data-lucide="paperclip" class="w-3.5 h-3.5"></i>
            </button>
            <input type="file" multiple x-ref="fileInput" class="hidden" @change="handleFileSelect($event)" />

            <div class="w-px self-stretch my-1 bg-base-300"></div>

            <!-- Send button -->
            <button
              class="btn btn-info btn-sm btn-circle"
              @click="sendOrEdit()"
              :disabled="!messageBody.trim() && pendingFiles.length === 0"
            >
              <i data-lucide="send" class="w-3.5 h-3.5"></i>
            </button>
          </div>

          <!-- Textarea -->
          <textarea
            x-ref="messageInput"
            x-model="messageBody"
            @keydown="handleInputKeydown($event)"
            @input="autoResize($el)"
            @paste="handlePaste($event)"
            class="textarea textarea-ghost w-full min-h-[2.5rem] max-h-[8rem] resize-none leading-snug px-3 py-1.5 focus:outline-none"
            placeholder="Type a message..."
            rows="1"
          ></textarea>
          </div>
        </div>
        </div><!-- /messages column -->

        <!-- Info panel -->
        <div
          x-show="showInfoPanel" x-cloak
          x-transition:enter="transition-[width] ease-out duration-200"
          x-transition:enter-start="!w-0"
          x-transition:enter-end="!w-72"
          x-transition:leave="transition-[width] ease-in duration-150"
          x-transition:leave-start="!w-72"
          x-transition:leave-end="!w-0"
          class="w-72 border-l border-base-300 bg-base-100 flex flex-col overflow-hidden"
        >
          <div class="w-72 flex-1 overflow-y-auto">
            {% include "chat/ui/partials/info_panel.html" %}
          </div>
        </div>

        <!-- Search panel -->
        <div
          x-show="showSearchPanel" x-cloak
          x-transition:enter="transition-[width] ease-out duration-200"
          x-transition:enter-start="!w-0"
          x-transition:enter-end="!w-72"
          x-transition:leave="transition-[width] ease-in duration-150"
          x-transition:leave-start="!w-72"
          x-transition:leave-end="!w-0"
          class="w-72 border-l border-base-300 bg-base-100 flex flex-col overflow-hidden"
        >
          <div class="w-72 flex-1 overflow-y-auto">
            {% include "chat/ui/partials/search_panel.html" %}
          </div>
        </div>
      </div><!-- /content area -->
    </div>
  </template>
</div>

<!-- Singleton emoji picker -->
<div x-show="emojiPickerVisible" x-cloak
     class="fixed z-[100]"
     :style="`left:${emojiPickerX}px; top:${emojiPickerY}px`"
     @click.outside="closeEmojiPicker()">
  <emoji-picker x-ref="emojiPicker"></emoji-picker>
</div>

<!-- Context menu -->
<div id="conv-context-menu">
{% include "chat/ui/partials/conversation_context_menu.html" %}
</div>

<!-- New conversation dialog -->
{% include "chat/ui/partials/new_conversation_dialog.html" %}
{% include "chat/ui/partials/add_member_dialog.html" %}
{% include "chat/ui/partials/help_dialog.html" %}

<!-- Bot picker dialog -->
{% if ai_enabled %}
<dialog :class="{'modal-open': showBotPicker}" class="modal"
        x-effect="if (showBotPicker) $nextTick(() => lucide.createIcons())">
  <div class="modal-box max-w-sm p-0 flex flex-col">
    <div class="flex items-center justify-between px-5 pt-5 pb-2">
      <h3 class="font-bold text-lg flex items-center gap-2">
        <i data-lucide="sparkles" class="w-5 h-5 text-secondary"></i>
        Start AI Chat
      </h3>
      <button class="btn btn-ghost btn-sm btn-circle" @click="showBotPicker = false">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>
    <div class="px-5 pb-5 space-y-2">
      <template x-for="bot in availableBots" :key="bot.user_id">
        <button class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-base-200 transition-colors text-left"
                @click="startBotConversation(bot)">
          <div class="avatar placeholder">
            <div class="bg-secondary text-secondary-content w-10 rounded-full">
              <i data-lucide="bot" class="w-5 h-5"></i>
            </div>
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-medium text-sm" x-text="bot.display_name"></div>
            <div class="text-xs text-base-content/50 truncate" x-text="bot.description"></div>
          </div>
        </button>
      </template>
      <div x-show="availableBots.length === 0" class="text-center text-sm text-base-content/50 py-4">
        No AI bots available.
      </div>
    </div>
    <div class="flex justify-end px-5 pb-5 pt-1">
      <button class="btn btn-ghost btn-sm" @click="showBotPicker = false">Cancel</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop"><button @click="showBotPicker = false">close</button></form>
</dialog>
{% endif %}

<!-- Embedded conversation data for fast Alpine init -->
<script id="conversations-data" type="application/json">{{ conversations_json|safe }}</script>
{% if initial_conversation_uuid %}<script id="initial-conversation" type="application/json">"{{ initial_conversation_uuid }}"</script>{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js" integrity="sha384-jrOgQzBlDeUNdmQn3rUt/PZD+pdcRBdWd/HWRqRo+n2OR2QtGyjSaJC0GiCeH+ir" crossorigin="anonymous"></script>
<script src="{% static 'chat/ui/js/chat.js' %}"></script>
{% endblock %}
