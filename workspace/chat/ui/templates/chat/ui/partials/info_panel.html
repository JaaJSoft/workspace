<!-- Info panel header -->
<div class="px-4 py-3 border-b border-base-300 flex items-center justify-between">
  <h4 class="font-semibold text-sm">Conversation info</h4>
  <button class="btn btn-ghost btn-xs btn-circle" @click="showInfoPanel = false">
    <i data-lucide="x" class="w-3.5 h-3.5"></i>
  </button>
</div>

<div class="p-4 space-y-5">
  <!-- Avatar + Name -->
  <div class="flex flex-col items-center text-center gap-2">
    <!-- Clickable group avatar (upload on click) -->
    <div class="relative group/avatar mb-2" :class="activeConversation.kind === 'group' ? 'cursor-pointer' : ''">
      <div x-html="conversationAvatar(activeConversation)" class="scale-150"></div>
      <!-- Camera overlay for group conversations -->
      <template x-if="activeConversation.kind === 'group'">
        <div
          class="absolute inset-0 scale-150 rounded-full bg-black/40 flex items-center justify-center opacity-0 group-hover/avatar:opacity-100 transition-opacity"
          @click="$refs.groupAvatarInput.click()"
          title="Change group avatar"
        >
          <i data-lucide="camera" class="w-4 h-4 text-white"></i>
        </div>
      </template>
      <input
        type="file"
        accept="image/jpeg,image/png,image/webp,image/gif"
        class="hidden"
        x-ref="groupAvatarInput"
        @change="uploadGroupAvatar($el)"
      />
    </div>
    <!-- Remove avatar button -->
    <button
      x-show="activeConversation.kind === 'group' && activeConversation.avatar_url"
      class="btn btn-ghost btn-xs gap-1 text-error hover:bg-error/10"
      @click="removeGroupAvatar()"
    >
      <i data-lucide="trash-2" class="w-3 h-3"></i>
      Remove avatar
    </button>
    <div class="flex items-center gap-1.5">
      <h3 class="font-bold text-base" x-text="conversationName(activeConversation)"></h3>
      <button
        x-show="activeConversation.kind === 'group'"
        class="btn btn-ghost btn-xs btn-circle opacity-50 hover:opacity-100"
        @click="renameConversation()"
        title="Rename group"
      >
        <i data-lucide="pencil" class="w-3 h-3"></i>
      </button>
    </div>
    <span
      class="badge badge-sm"
      :class="activeConversation.kind === 'dm' ? 'badge-ghost' : 'badge-info badge-outline'"
      x-text="activeConversation.kind === 'dm' ? 'Direct message' : 'Group'"
    ></span>
  </div>

  <!-- Details -->
  <div class="space-y-2 text-sm">
    <div class="flex items-center gap-2 text-base-content/60">
      <i data-lucide="calendar" class="w-3.5 h-3.5 flex-shrink-0"></i>
      <span>Created <span x-text="formatDate(activeConversation.created_at)"></span></span>
    </div>
    <div class="flex items-center gap-2 text-base-content/60" x-show="activeConversation.kind === 'group' && activeConversation.title">
      <i data-lucide="tag" class="w-3.5 h-3.5 flex-shrink-0"></i>
      <span x-text="activeConversation.title" class="truncate"></span>
    </div>
  </div>

  <!-- Actions -->
  <div class="flex flex-wrap gap-1.5">
    <button
      class="btn btn-ghost btn-xs gap-1"
      @click="copyConversationLink()"
      :title="_linkCopied ? 'Copied!' : 'Copy link'"
    >
      <i :data-lucide="_linkCopied ? 'check' : 'link'" class="w-3 h-3"></i>
      <span x-text="_linkCopied ? 'Copied!' : 'Copy link'"></span>
    </button>
    <button
      class="btn btn-ghost btn-xs gap-1 text-error hover:bg-error/10"
      @click="leaveConversation()"
    >
      <i data-lucide="log-out" class="w-3 h-3"></i>
      Leave
    </button>
  </div>

  <!-- Divider -->
  <div class="divider my-0 text-xs text-base-content/40">
    Members
    <span class="badge badge-ghost badge-xs" x-text="activeConversation.members?.length || 0"></span>
  </div>

  <!-- Members list -->
  <ul class="space-y-1">
    <!-- Add members row -->
    <li
      x-show="activeConversation.kind === 'group'"
      class="flex items-center gap-2.5 px-2 py-1.5 rounded-lg hover:bg-base-200 transition-colors cursor-pointer"
      @click="addMembersToConversation()"
    >
      <div class="w-8 h-8 rounded-full border-2 border-dashed border-base-content/20 flex items-center justify-center flex-shrink-0">
        <i data-lucide="plus" class="w-3.5 h-3.5 text-base-content/40"></i>
      </div>
      <span class="text-sm font-medium text-base-content/50">Add members</span>
    </li>
    <template x-for="member in activeConversation.members || []" :key="member.uuid">
      <li class="group flex items-center gap-2.5 px-2 py-1.5 rounded-lg hover:bg-base-200 transition-colors">
        <div class="flex-shrink-0" x-html="_avatarHtml(member.user, 'w-8 h-8 text-xs', member.user.id === currentUserId ? 'bg-info text-info-content' : 'bg-neutral text-neutral-content')"></div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-1.5">
            <span class="text-sm font-medium truncate" x-text="member.user.username"></span>
            <span
              x-show="member.user.id === currentUserId"
              class="badge badge-ghost badge-sm"
            >you</span>
            <span
              x-show="member.user.id === activeConversation.created_by_id"
              class="badge badge-info badge-sm badge-outline"
            >creator</span>
          </div>
          <p
            class="text-xs text-base-content/50 truncate"
            x-show="memberDisplayName(member) !== member.user.username"
            x-text="memberDisplayName(member)"
          ></p>
        </div>
        <!-- Remove button (visible to creator, not on self) -->
        <button
          x-show="activeConversation.kind === 'group' && activeConversation.created_by_id === currentUserId && member.user.id !== currentUserId"
          class="btn btn-ghost btn-xs btn-circle opacity-0 group-hover:opacity-100 text-error transition-opacity"
          @click="removeMember(member.user.id)"
          title="Remove from group"
        >
          <i data-lucide="x" class="w-3 h-3"></i>
        </button>
      </li>
    </template>
  </ul>

  <!-- Stats -->
  <div class="divider my-0 text-xs text-base-content/40">Statistics</div>

  <!-- Loading skeleton -->
  <template x-if="loadingStats">
    <div class="space-y-2 animate-pulse">
      <div class="h-4 bg-base-300 rounded w-3/4"></div>
      <div class="h-4 bg-base-300 rounded w-1/2"></div>
      <div class="h-4 bg-base-300 rounded w-2/3"></div>
    </div>
  </template>

  <!-- Stats content -->
  <template x-if="!loadingStats && conversationStats">
    <div class="space-y-3 text-sm">
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-base-200 rounded-lg px-3 py-2 text-center">
          <div class="text-lg font-bold" x-text="conversationStats.message_count"></div>
          <div class="text-xs text-base-content/50">Messages</div>
        </div>
        <div class="bg-base-200 rounded-lg px-3 py-2 text-center">
          <div class="text-lg font-bold" x-text="conversationStats.reaction_count"></div>
          <div class="text-xs text-base-content/50">Reactions</div>
        </div>
      </div>

      <div class="space-y-1.5" x-show="conversationStats.first_message_at">
        <div class="flex items-center gap-2 text-base-content/60">
          <i data-lucide="message-square" class="w-3.5 h-3.5 flex-shrink-0"></i>
          <span>First message: <span x-text="formatDateTime(conversationStats.first_message_at)"></span></span>
        </div>
        <div class="flex items-center gap-2 text-base-content/60">
          <i data-lucide="clock" class="w-3.5 h-3.5 flex-shrink-0"></i>
          <span>Last message: <span x-text="formatDateTime(conversationStats.last_message_at)"></span></span>
        </div>
      </div>

      <!-- Top contributors -->
      <template x-if="conversationStats.messages_per_member.length > 0">
        <div class="space-y-1.5">
          <div class="text-xs font-semibold text-base-content/50 uppercase tracking-wider">Top contributors</div>
          <template x-for="entry in conversationStats.messages_per_member" :key="entry.username">
            <div class="flex items-center gap-2">
              <span class="text-xs w-20 truncate" x-text="entry.username"></span>
              <div class="flex-1 bg-base-300 rounded-full h-2 overflow-hidden">
                <div
                  class="bg-primary h-full rounded-full transition-all"
                  :style="`width: ${Math.round(entry.count / conversationStats.message_count * 100)}%`"
                ></div>
              </div>
              <span class="text-xs text-base-content/50 w-8 text-right" x-text="entry.count"></span>
            </div>
          </template>
        </div>
      </template>
    </div>
  </template>

  <!-- No stats yet -->
  <template x-if="!loadingStats && !conversationStats">
    <div class="text-sm text-base-content/40 text-center py-2">No stats available</div>
  </template>
</div>

<!-- Avatar cropper modal -->
<dialog x-ref="cropperDialog" class="modal">
  <div class="modal-box max-w-lg">
    <h3 class="font-bold text-lg mb-4">Crop your photo</h3>
    <div class="w-full" style="max-height: 400px;">
      <img x-ref="cropperImage" style="display: block; max-width: 100%;" />
    </div>
    <div class="modal-action">
      <button type="button" @click="cancelAvatarCrop()" class="btn btn-ghost btn-sm">Cancel</button>
      <button type="button" @click="confirmAvatarCrop()" class="btn btn-primary btn-sm gap-2" :disabled="_cropUploading">
        <span x-show="_cropUploading" class="loading loading-spinner loading-sm"></span>
        <span x-text="_cropUploading ? 'Uploading...' : 'Confirm'"></span>
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button @click="cancelAvatarCrop()">close</button>
  </form>
</dialog>
