{% load chat_tags ui_filters %}
{% with author=group.author is_own=group.is_own messages=group.messages first_msg=group.messages.0 %}
<div class="msg-group {% if is_own %}msg-group-end{% else %}msg-group-start{% endif %} flex gap-2 mb-3 {% if is_own %}flex-row-reverse{% endif %}">

  {# Avatar column #}
  <div class="flex-shrink-0 w-8 mt-auto">
    {% include "ui/partials/user_avatar.html" with user=author size="sm" show_card=True %}
  </div>

  {# Message column #}
  <div class="flex flex-col {% if is_own %}items-end{% else %}items-start{% endif %} gap-0.5 min-w-0 max-w-[75%]">
    {# Header: username #}
    {% if not is_own %}
      <div class="flex items-baseline gap-1.5 px-1 text-xs">
        <span class="font-semibold text-base-content">{{ author.username }}</span>
      </div>
    {% endif %}

    {# Bubbles #}
    {% for msg in messages %}
      {% if msg.deleted_at %}
        <div class="msg-bubble rounded-2xl px-3 py-1.5 text-sm italic
                    bg-base-200 text-base-content/40"
             id="msg-{{ msg.uuid }}">
          Message deleted
        </div>
      {% else %}
        <div class="relative group/msg hover:z-20">
          {# Bubble #}
          <div class="msg-bubble rounded-2xl px-3 py-1.5 text-sm
                      {% if is_own %}bg-info/15 text-base-content{% else %}bg-base-200 text-base-content{% endif %}"
               id="msg-{{ msg.uuid }}"
               data-body="{{ msg.body }}">
            {% if msg.reply_to %}
              <a href="#msg-{{ msg.reply_to.uuid }}"
                 @click.prevent="scrollToMessage('{{ msg.reply_to.uuid }}')"
                 class="flex gap-2 mb-1.5 rounded-lg px-2 py-1 cursor-pointer transition-colors no-underline
                        {% if is_own %}bg-info/15 hover:bg-info/25{% else %}bg-base-300/50 hover:bg-base-300{% endif %}">
                <div class="w-0.5 flex-shrink-0 rounded-full bg-info"></div>
                <div class="min-w-0 flex-1">
                  {% if msg.reply_to.deleted_at %}
                    <span class="text-xs italic opacity-50">Message deleted</span>
                  {% else %}
                    <span class="text-xs font-semibold text-info">{{ msg.reply_to.author.username }}</span>
                    <p class="text-xs text-base-content/70 truncate">{{ msg.reply_to.body|truncatechars:100 }}</p>
                  {% endif %}
                </div>
              </a>
            {% endif %}
            {% if msg.body_html %}
              <div class="msg-body break-words">{{ msg.body_html|safe }}</div>
            {% endif %}

            {# Attachments #}
            {% with attachments=msg.attachments.all %}
              {% if attachments %}
                {% if msg.body_html %}<div class="border-t {% if is_own %}border-info/30{% else %}border-base-300{% endif %} my-1.5"></div>{% endif %}
                <div class="flex flex-col gap-1.5">
                  {% for att in attachments %}
                    {% if att.is_image %}
                      <div class="relative group/att inline-block">
                        <a href="/api/v1/chat/attachments/{{ att.uuid }}" target="_blank" class="block">
                          <img
                            src="/api/v1/chat/attachments/{{ att.uuid }}"
                            alt="{{ att.original_name }}"
                            class="max-h-64 max-w-full rounded-lg object-contain cursor-pointer hover:opacity-90 transition-opacity"
                            loading="lazy"
                          />
                        </a>
                        <button
                          class="absolute top-1 right-1 btn btn-xs btn-circle bg-base-100/80 hover:bg-base-100 border-base-300 shadow-sm opacity-0 group-hover/att:opacity-100 transition-opacity"
                          @click="saveAttachmentToFiles('{{ att.uuid }}')"
                          title="Save to Files"
                        >
                          <i data-lucide="folder-down" class="w-3 h-3"></i>
                        </button>
                      </div>
                    {% else %}
                      <div class="flex items-center gap-0.5 group/att">
                        <a href="/api/v1/chat/attachments/{{ att.uuid }}"
                           target="_blank"
                           class="flex items-center gap-2 p-2 rounded-lg {% if is_own %}bg-info/15 hover:bg-info/25{% else %}bg-base-300/50 hover:bg-base-300{% endif %} transition-colors min-w-0 flex-1">
                          <i data-lucide="file" class="w-4 h-4 flex-shrink-0"></i>
                          <span class="truncate text-xs font-medium">{{ att.original_name }}</span>
                          <span class="text-[0.65rem] opacity-60 flex-shrink-0">{{ att.size|filesize }}</span>
                          <i data-lucide="download" class="w-3.5 h-3.5 flex-shrink-0 opacity-60"></i>
                        </a>
                        <button
                          class="btn btn-ghost btn-xs btn-circle opacity-0 group-hover/att:opacity-100 transition-opacity flex-shrink-0"
                          @click="saveAttachmentToFiles('{{ att.uuid }}')"
                          title="Save to Files"
                        >
                          <i data-lucide="folder-down" class="w-3.5 h-3.5"></i>
                        </button>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}

            {% if msg.edited_at %}
              <span class="text-[0.65rem] opacity-50 italic ml-1">(edited)</span>
            {% endif %}
            {% if msg.uuid in pinned_message_ids %}
              <span class="inline-flex items-center gap-0.5 text-[0.65rem] opacity-50 ml-1" title="Pinned">
                <i data-lucide="pin" class="w-3 h-3"></i>
              </span>
            {% endif %}
          </div>

          {# Hover toolbar â€” floats below the bubble #}
          <div class="absolute top-full mt-0.5 {% if is_own %}right-0{% else %}left-0{% endif %} opacity-0 pointer-events-none group-hover/msg:opacity-100 group-hover/msg:pointer-events-auto transition-opacity z-50"
               >
            <div class="flex items-center gap-0.5 bg-base-100 border border-base-300 rounded-lg shadow-sm px-0.5 py-0.5">
              {# Quick reactions #}
              <template x-for="emoji in quickEmojis" :key="emoji">
                <button class="btn btn-ghost btn-xs btn-circle text-base leading-none"
                        @click="toggleReaction('{{ msg.uuid }}', emoji)"
                        x-text="emoji"></button>
              </template>
              <div class="w-px self-stretch my-0.5 bg-base-300"></div>
              {# Full emoji picker #}
              <button class="btn btn-ghost btn-xs btn-circle"
                      @click="openEmojiPicker('reaction', $event, '{{ msg.uuid }}')"
                      title="More reactions">
                <i data-lucide="smile-plus" class="w-3.5 h-3.5"></i>
              </button>
              {# Reply #}
              <button class="btn btn-ghost btn-xs btn-circle"
                      @click="startReply('{{ msg.uuid }}', '{{ msg.author.username|escapejs }}', '{{ msg.body|truncatechars:100|escapejs }}')"
                      title="Reply">
                <i data-lucide="reply" class="w-3.5 h-3.5"></i>
              </button>
              {% if msg.uuid in pinned_message_ids %}
                <button class="btn btn-ghost btn-xs btn-circle"
                        @click="unpinMessage('{{ msg.uuid }}')"
                        title="Unpin">
                  <i data-lucide="pin-off" class="w-3.5 h-3.5"></i>
                </button>
              {% else %}
                <button class="btn btn-ghost btn-xs btn-circle"
                        @click="pinMessage('{{ msg.uuid }}')"
                        title="Pin">
                  <i data-lucide="pin" class="w-3.5 h-3.5"></i>
                </button>
              {% endif %}
              {% if is_own %}
                <button class="btn btn-ghost btn-xs btn-circle"
                        @click="startEdit('{{ msg.uuid }}')"
                        title="Edit">
                  <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                </button>
                <button class="btn btn-ghost btn-xs btn-circle text-error"
                        @click="deleteMessage('{{ msg.uuid }}')"
                        title="Delete">
                  <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                </button>
              {% endif %}
            </div>
          </div>
        </div>

        {# Reactions #}
        {% render_reactions msg current_user %}
      {% endif %}
    {% endfor %}

    {# Footer: time + read receipt #}
    {% with last_msg=messages|last %}
      <div class="flex items-center gap-1 px-1">
        <span class="text-[0.65rem] text-base-content/40">{{ last_msg.created_at|localtime_tag }}</span>
        {% if is_own %}{% render_read_receipt last_msg conversation_kind %}{% endif %}
      </div>
    {% endwith %}
  </div>
</div>
{% endwith %}
