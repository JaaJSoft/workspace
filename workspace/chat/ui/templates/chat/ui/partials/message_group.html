{% load chat_tags avatar_tags %}
{% with author=group.author is_own=group.is_own messages=group.messages first_msg=group.messages.0 %}
<div class="msg-group {% if is_own %}msg-group-end{% else %}msg-group-start{% endif %} flex gap-2 mb-3 {% if is_own %}flex-row-reverse{% endif %}">

  {# Avatar column #}
  <div class="flex-shrink-0 w-8 mt-auto">
    {% include "ui/partials/user_avatar.html" with user=author size="sm" %}
  </div>

  {# Message column #}
  <div class="flex flex-col {% if is_own %}items-end{% else %}items-start{% endif %} gap-0.5 min-w-0 max-w-[75%]">
    {# Header: username + time #}
    <div class="flex items-baseline gap-1.5 px-1 text-xs">
      {% if not is_own %}
        <span class="font-semibold text-base-content">{{ author.username }}</span>
      {% endif %}
      <time class="text-base-content/50">{{ first_msg.created_at|format_time }}</time>
    </div>

    {# Bubbles #}
    {% for msg in messages %}
      {% if msg.deleted_at %}
        <div class="msg-bubble rounded-2xl px-3 py-1.5 text-sm italic
                    bg-base-200 text-base-content/40"
             id="msg-{{ msg.uuid }}">
          Message deleted
        </div>
      {% else %}
        <div class="relative group/msg">
          {# Bubble #}
          <div class="msg-bubble rounded-2xl px-3 py-1.5 text-sm
                      {% if is_own %}bg-info text-info-content{% else %}bg-base-200 text-base-content{% endif %}"
               id="msg-{{ msg.uuid }}"
               data-body="{{ msg.body }}">
            <div class="msg-body break-words">{{ msg.body_html|safe }}</div>
            {% if msg.edited_at %}
              <span class="text-[0.65rem] opacity-50 italic ml-1">(edited)</span>
            {% endif %}
          </div>

          {# Hover toolbar â€” floats below the bubble #}
          <div class="absolute top-full mt-0.5 {% if is_own %}left-0{% else %}right-0{% endif %} opacity-0 group-hover/msg:opacity-100 transition-opacity z-10"
               x-data="{ emojiOpen: false }">
            <div class="flex items-center gap-0.5 bg-base-100 border border-base-300 rounded-lg shadow-sm px-0.5 py-0.5">
              {# Reaction picker #}
              <div class="dropdown dropdown-bottom {% if is_own %}dropdown-end{% endif %}">
                <button class="btn btn-ghost btn-xs btn-circle"
                        @click="emojiOpen = !emojiOpen"
                        title="React">
                  <i data-lucide="smile-plus" class="w-3.5 h-3.5"></i>
                </button>
                <div x-show="emojiOpen" x-cloak @click.outside="emojiOpen = false"
                     class="dropdown-content mt-1 p-1.5 bg-base-100 border border-base-300 rounded-lg shadow-lg flex gap-0.5 z-20">
                  <template x-for="emoji in quickEmojis" :key="emoji">
                    <button class="btn btn-ghost btn-sm"
                            @click="toggleReaction('{{ msg.uuid }}', emoji); emojiOpen = false"
                            x-text="emoji"></button>
                  </template>
                </div>
              </div>
              {% if is_own %}
                <button class="btn btn-ghost btn-xs btn-circle"
                        @click="startEdit('{{ msg.uuid }}')"
                        title="Edit">
                  <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                </button>
                <button class="btn btn-ghost btn-xs btn-circle text-error"
                        @click="deleteMessage('{{ msg.uuid }}')"
                        title="Delete">
                  <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                </button>
              {% endif %}
            </div>
          </div>
        </div>

        {# Reactions #}
        {% render_reactions msg current_user %}
      {% endif %}
    {% endfor %}

    {# Trailing time for multi-message groups #}
    {% if messages|length > 1 %}
      {% with last_msg=messages|last %}
        {% if not last_msg.deleted_at %}
          <time class="text-[0.65rem] text-base-content/40 px-1">{{ last_msg.created_at|format_time }}</time>
        {% endif %}
      {% endwith %}
    {% endif %}
  </div>
</div>
{% endwith %}
