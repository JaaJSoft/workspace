{% load chat_tags ui_filters %}
{% with author=group.author is_own=group.is_own messages=group.messages first_msg=group.messages.0 %}
<div class="msg-group {% if is_own %}msg-group-end{% else %}msg-group-start{% endif %} flex gap-2 mb-3 {% if is_own %}flex-row-reverse{% endif %}">

  {# Avatar column #}
  <div class="flex-shrink-0 w-8 mt-auto">
    {% include "ui/partials/user_avatar.html" with user=author size="sm" show_card=True %}
  </div>

  {# Message column #}
  <div class="flex flex-col {% if is_own %}items-end{% else %}items-start{% endif %} gap-0.5 min-w-0 max-w-[75%]">
    {# Header: username + time #}
    <div class="flex items-baseline gap-1.5 px-1 text-xs">
      {% if not is_own %}
        <span class="font-semibold text-base-content">{{ author.username }}</span>
      {% endif %}
      <time class="text-base-content/50">{{ first_msg.created_at|format_time }}</time>
    </div>

    {# Bubbles #}
    {% for msg in messages %}
      {% if msg.deleted_at %}
        <div class="msg-bubble rounded-2xl px-3 py-1.5 text-sm italic
                    bg-base-200 text-base-content/40"
             id="msg-{{ msg.uuid }}">
          Message deleted
        </div>
      {% else %}
        <div class="relative group/msg">
          {# Bubble #}
          <div class="msg-bubble rounded-2xl px-3 py-1.5 text-sm
                      {% if is_own %}bg-info text-info-content{% else %}bg-base-200 text-base-content{% endif %}"
               id="msg-{{ msg.uuid }}"
               data-body="{{ msg.body }}">
            {% if msg.body_html %}
              <div class="msg-body break-words">{{ msg.body_html|safe }}</div>
            {% endif %}

            {# Attachments #}
            {% with attachments=msg.attachments.all %}
              {% if attachments %}
                {% if msg.body_html %}<div class="border-t {% if is_own %}border-info-content/20{% else %}border-base-300{% endif %} my-1.5"></div>{% endif %}
                <div class="flex flex-col gap-1.5">
                  {% for att in attachments %}
                    {% if att.is_image %}
                      <div class="relative group/att inline-block">
                        <a href="/api/v1/chat/attachments/{{ att.uuid }}" target="_blank" class="block">
                          <img
                            src="/api/v1/chat/attachments/{{ att.uuid }}"
                            alt="{{ att.original_name }}"
                            class="max-h-64 max-w-full rounded-lg object-contain cursor-pointer hover:opacity-90 transition-opacity"
                            loading="lazy"
                          />
                        </a>
                        <button
                          class="absolute top-1 right-1 btn btn-xs btn-circle bg-base-100/80 hover:bg-base-100 border-base-300 shadow-sm opacity-0 group-hover/att:opacity-100 transition-opacity"
                          @click="saveAttachmentToFiles('{{ att.uuid }}')"
                          title="Save to Files"
                        >
                          <i data-lucide="folder-down" class="w-3 h-3"></i>
                        </button>
                      </div>
                    {% else %}
                      <div class="flex items-center gap-0.5 group/att">
                        <a href="/api/v1/chat/attachments/{{ att.uuid }}"
                           target="_blank"
                           class="flex items-center gap-2 p-2 rounded-lg {% if is_own %}bg-info-content/10 hover:bg-info-content/20{% else %}bg-base-300/50 hover:bg-base-300{% endif %} transition-colors min-w-0 flex-1">
                          <i data-lucide="file" class="w-4 h-4 flex-shrink-0"></i>
                          <span class="truncate text-xs font-medium">{{ att.original_name }}</span>
                          <span class="text-[0.65rem] opacity-60 flex-shrink-0">{{ att.size|filesize }}</span>
                          <i data-lucide="download" class="w-3.5 h-3.5 flex-shrink-0 opacity-60"></i>
                        </a>
                        <button
                          class="btn btn-ghost btn-xs btn-circle opacity-0 group-hover/att:opacity-100 transition-opacity flex-shrink-0"
                          @click="saveAttachmentToFiles('{{ att.uuid }}')"
                          title="Save to Files"
                        >
                          <i data-lucide="folder-down" class="w-3.5 h-3.5"></i>
                        </button>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}

            {% if msg.edited_at %}
              <span class="text-[0.65rem] opacity-50 italic ml-1">(edited)</span>
            {% endif %}
            {% if msg.uuid in pinned_message_ids %}
              <span class="inline-flex items-center gap-0.5 text-[0.65rem] opacity-50 ml-1" title="Pinned">
                <i data-lucide="pin" class="w-3 h-3"></i>
              </span>
            {% endif %}
          </div>

          {# Hover toolbar â€” floats below the bubble #}
          <div class="absolute top-full mt-0.5 {% if is_own %}left-0{% else %}right-0{% endif %} opacity-0 group-hover/msg:opacity-100 transition-opacity z-10"
               x-data="{ emojiOpen: false }">
            <div class="flex items-center gap-0.5 bg-base-100 border border-base-300 rounded-lg shadow-sm px-0.5 py-0.5">
              {# Reaction picker #}
              <div class="dropdown dropdown-bottom {% if is_own %}dropdown-end{% endif %}">
                <button class="btn btn-ghost btn-xs btn-circle"
                        @click="emojiOpen = !emojiOpen"
                        title="React">
                  <i data-lucide="smile-plus" class="w-3.5 h-3.5"></i>
                </button>
                <div x-show="emojiOpen" x-cloak @click.outside="emojiOpen = false"
                     class="dropdown-content mt-1 p-1.5 bg-base-100 border border-base-300 rounded-lg shadow-lg flex gap-0.5 z-20">
                  <template x-for="emoji in quickEmojis" :key="emoji">
                    <button class="btn btn-ghost btn-sm"
                            @click="toggleReaction('{{ msg.uuid }}', emoji); emojiOpen = false"
                            x-text="emoji"></button>
                  </template>
                </div>
              </div>
              {% if msg.uuid in pinned_message_ids %}
                <button class="btn btn-ghost btn-xs btn-circle"
                        @click="unpinMessage('{{ msg.uuid }}')"
                        title="Unpin">
                  <i data-lucide="pin-off" class="w-3.5 h-3.5"></i>
                </button>
              {% else %}
                <button class="btn btn-ghost btn-xs btn-circle"
                        @click="pinMessage('{{ msg.uuid }}')"
                        title="Pin">
                  <i data-lucide="pin" class="w-3.5 h-3.5"></i>
                </button>
              {% endif %}
              {% if is_own %}
                <button class="btn btn-ghost btn-xs btn-circle"
                        @click="startEdit('{{ msg.uuid }}')"
                        title="Edit">
                  <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                </button>
                <button class="btn btn-ghost btn-xs btn-circle text-error"
                        @click="deleteMessage('{{ msg.uuid }}')"
                        title="Delete">
                  <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                </button>
              {% endif %}
            </div>
          </div>
        </div>

        {# Reactions #}
        {% render_reactions msg current_user %}
      {% endif %}
    {% endfor %}

    {# Trailing time for multi-message groups #}
    {% if messages|length > 1 %}
      {% with last_msg=messages|last %}
        {% if not last_msg.deleted_at %}
          <time class="text-[0.65rem] text-base-content/40 px-1">{{ last_msg.created_at|format_time }}</time>
        {% endif %}
      {% endwith %}
    {% endif %}
  </div>
</div>
{% endwith %}
