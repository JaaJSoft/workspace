<dialog x-ref="newConvDialog" class="modal" @keydown.escape="$refs.newConvDialog.close()">
  <div class="modal-box max-w-md">
    <h3 class="font-bold text-lg mb-4">New conversation</h3>

    <!-- User search -->
    <div class="form-control mb-3">
      <label class="label">
        <span class="label-text">Add participants</span>
      </label>
      <div class="relative">
        <label class="input input-sm input-bordered flex items-center gap-2 w-full">
          <i data-lucide="search" class="w-4 h-4 opacity-60"></i>
          <input
            type="text"
            class="grow"
            placeholder="Search users..."
            x-model="userSearchQuery"
            @input.debounce.300ms="searchUsers()"
            @click.outside="userSearchShowDropdown = false"
            @keydown.escape="userSearchShowDropdown = false"
            autocomplete="off"
          />
          <span x-show="userSearchLoading" class="loading loading-spinner loading-xs"></span>
        </label>

        <!-- Dropdown results -->
        <div
          x-show="userSearchShowDropdown && userSearchResults.length > 0"
          x-cloak
          class="absolute z-50 mt-1 w-full bg-base-100 border border-base-300 rounded-lg shadow-lg max-h-48 overflow-y-auto"
        >
          <ul class="menu menu-sm p-1">
            <template x-for="user in userSearchResults" :key="user.id">
              <li>
                <button
                  type="button"
                  class="flex items-center gap-2 rounded"
                  @click="selectSearchedUser(user)"
                >
                  <div class="avatar placeholder">
                    <div class="bg-neutral text-neutral-content w-6 h-6 rounded-full">
                      <span class="text-xs" x-text="(user.username || '?')[0].toUpperCase()"></span>
                    </div>
                  </div>
                  <div class="flex flex-col items-start">
                    <span class="font-medium text-sm" x-text="user.username"></span>
                    <span
                      class="text-xs text-base-content/60"
                      x-show="user.first_name || user.last_name"
                      x-text="((user.first_name || '') + ' ' + (user.last_name || '')).trim()"
                    ></span>
                  </div>
                </button>
              </li>
            </template>
          </ul>
        </div>

        <!-- No results -->
        <div
          x-show="userSearchShowDropdown && userSearchResults.length === 0 && userSearchQuery.length >= 2 && !userSearchLoading"
          x-cloak
          class="absolute z-50 mt-1 w-full bg-base-100 border border-base-300 rounded-lg shadow-lg p-3 text-sm text-base-content/60 text-center"
        >
          No users found
        </div>
      </div>
    </div>

    <!-- Selected users chips -->
    <div class="flex flex-wrap gap-1.5 mb-3" x-show="selectedUsers.length > 0" x-cloak>
      <template x-for="u in selectedUsers" :key="u.id">
        <span class="badge badge-info gap-1">
          <span x-text="u.username"></span>
          <button @click="removeSelectedUser(u.id)" class="btn btn-ghost btn-xs btn-circle p-0 w-4 h-4 min-h-0">
            <i data-lucide="x" class="w-3 h-3"></i>
          </button>
        </span>
      </template>
    </div>

    <!-- Group title (shown when 2+ users) -->
    <div class="form-control mb-4" x-show="selectedUsers.length >= 2" x-cloak>
      <label class="label">
        <span class="label-text">Group name (optional)</span>
      </label>
      <input
        type="text"
        class="input input-sm input-bordered w-full"
        placeholder="e.g. Project Team"
        x-model="newConvTitle"
      />
    </div>

    <!-- Actions -->
    <div class="modal-action">
      <button class="btn btn-ghost btn-sm" @click="$refs.newConvDialog.close()">Cancel</button>
      <button
        class="btn btn-info btn-sm"
        @click="createConversation()"
        :disabled="selectedUsers.length === 0 || creatingConversation"
      >
        <span x-show="!creatingConversation">Start</span>
        <span x-show="creatingConversation" class="loading loading-spinner loading-xs"></span>
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
