<!-- Search panel header -->
<div class="px-4 py-3 border-b border-base-300 flex items-center justify-between">
  <h4 class="font-semibold text-sm">Search messages</h4>
  <button class="btn btn-ghost btn-xs btn-circle" @click="closeSearchPanel()">
    <i data-lucide="x" class="w-3.5 h-3.5"></i>
  </button>
</div>

<div class="p-4 space-y-3">
  <!-- Search input -->
  <label class="input input-sm input-bordered flex items-center gap-2 w-full">
    <i data-lucide="search" class="w-3.5 h-3.5 opacity-50"></i>
    <input
      type="text"
      x-ref="searchInput"
      x-model="searchQuery"
      @input.debounce.300ms="searchMessages()"
      @keydown="handleSearchKeydown($event)"
      @keydown.escape="closeSearchPanel()"
      class="grow"
      placeholder="Search..."
    />
    <span
      x-show="searchQuery"
      class="btn btn-ghost btn-xs btn-circle"
      @click="searchQuery = ''; searchMessages()"
    >
      <i data-lucide="x" class="w-3 h-3"></i>
    </span>
  </label>

  <!-- Filter toggle -->
  <div class="flex items-center gap-2">
    <button
      class="btn btn-xs btn-ghost gap-1"
      :class="searchFiltersExpanded ? 'btn-active' : ''"
      @click="searchFiltersExpanded = !searchFiltersExpanded; $nextTick(() => lucide.createIcons())"
    >
      <i data-lucide="sliders-horizontal" class="w-3 h-3"></i>
      Filters
      <span
        x-show="hasActiveSearchFilters()"
        class="badge badge-xs badge-primary"
      ></span>
    </button>
    <button
      x-show="hasActiveSearchFilters()"
      class="btn btn-xs btn-ghost text-error gap-1"
      @click="clearSearchFilters()"
    >
      <i data-lucide="x" class="w-3 h-3"></i>
      Clear
    </button>
  </div>

  <!-- Collapsible filter section -->
  <div
    x-show="searchFiltersExpanded"
    x-transition:enter="transition ease-out duration-150"
    x-transition:enter-start="opacity-0 -translate-y-1"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-100"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 -translate-y-1"
    class="space-y-2 p-3 bg-base-200/50 rounded-lg"
  >
    <!-- Sender filter -->
    <div>
      <label class="text-xs font-medium text-base-content/60 mb-1 block">Sender</label>
      <select
        class="select select-xs select-bordered w-full"
        x-model="searchFilterAuthor"
        @change="searchMessages()"
      >
        <option value="">Anyone</option>
        <template x-for="m in (activeConversation?.members || [])" :key="m.user.id">
          <option :value="m.user.id" x-text="m.user.username"></option>
        </template>
      </select>
    </div>

    <!-- Date filter -->
    <div>
      <label class="text-xs font-medium text-base-content/60 mb-1 block">Date</label>
      <select
        class="select select-xs select-bordered w-full"
        x-model="searchFilterDateRange"
        @change="searchMessages()"
      >
        <option value="">Any time</option>
        <option value="today">Today</option>
        <option value="7d">Last 7 days</option>
        <option value="30d">Last 30 days</option>
        <option value="custom">Custom range</option>
      </select>
      <!-- Custom date inputs -->
      <div
        x-show="searchFilterDateRange === 'custom'"
        class="flex gap-2 mt-1"
      >
        <input
          type="date"
          class="input input-xs input-bordered flex-1"
          x-model="searchFilterDateFrom"
          @change="searchMessages()"
          placeholder="From"
        />
        <input
          type="date"
          class="input input-xs input-bordered flex-1"
          x-model="searchFilterDateTo"
          @change="searchMessages()"
          placeholder="To"
        />
      </div>
    </div>

    <!-- Attachment filters -->
    <div>
      <label class="text-xs font-medium text-base-content/60 mb-1 block">Attachments</label>
      <div class="flex gap-1">
        <button
          class="btn btn-xs gap-1"
          :class="searchFilterHasFiles ? 'btn-primary' : 'btn-ghost'"
          @click="searchFilterHasFiles = !searchFilterHasFiles; if (searchFilterHasFiles) searchFilterHasImages = false; searchMessages()"
        >
          <i data-lucide="paperclip" class="w-3 h-3"></i>
          Has files
        </button>
        <button
          class="btn btn-xs gap-1"
          :class="searchFilterHasImages ? 'btn-primary' : 'btn-ghost'"
          @click="searchFilterHasImages = !searchFilterHasImages; if (searchFilterHasImages) searchFilterHasFiles = false; searchMessages()"
        >
          <i data-lucide="image" class="w-3 h-3"></i>
          Has images
        </button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div x-show="searchLoading" class="flex justify-center py-4">
    <span class="loading loading-spinner loading-sm text-info"></span>
  </div>

  <!-- Result count -->
  <div
    x-show="!searchLoading && (searchQuery.trim().length >= 2 || hasActiveSearchFilters()) && searchResults.length > 0"
    class="text-xs text-base-content/50"
  >
    <span x-text="searchResults.length"></span> result<span x-show="searchResults.length !== 1">s</span>
  </div>

  <!-- Results list -->
  <div x-show="!searchLoading && searchResults.length > 0" class="space-y-1 max-h-[calc(100vh-16rem)] overflow-y-auto">
    <template x-for="(result, idx) in searchResults" :key="result.uuid">
      <div
        class="rounded-lg px-3 py-2 hover:bg-base-200 transition-colors cursor-pointer text-sm"
        :class="searchHighlight === idx ? 'bg-base-200' : ''"
        :data-search-result-active="searchHighlight === idx"
        @click="scrollToMessage(result.uuid)"
        @mouseenter="searchHighlight = idx"
      >
        <div class="flex items-center gap-2 mb-0.5">
          <span class="font-medium text-xs" x-text="result.author.username"></span>
          <span class="text-[0.65rem] text-base-content/40" x-text="formatDateTime(result.created_at)"></span>
        </div>
        <div
          class="text-xs text-base-content/70 line-clamp-3 break-words msg-body"
          x-html="highlightMatch(result.body_html, searchQuery)"
        ></div>
      </div>
    </template>
  </div>

  <!-- Empty state: no results -->
  <div
    x-show="!searchLoading && (searchQuery.trim().length >= 2 || hasActiveSearchFilters()) && searchResults.length === 0"
    class="text-center py-6"
  >
    <i data-lucide="search-x" class="w-8 h-8 mx-auto text-base-content/20 mb-2"></i>
    <p class="text-sm text-base-content/40">No messages found</p>
  </div>

  <!-- Empty state: prompt -->
  <div
    x-show="!searchLoading && searchQuery.trim().length < 2 && !hasActiveSearchFilters()"
    class="text-center py-6"
  >
    <i data-lucide="search" class="w-8 h-8 mx-auto text-base-content/20 mb-2"></i>
    <p class="text-sm text-base-content/40">Type at least 2 characters or use filters</p>
  </div>
</div>
