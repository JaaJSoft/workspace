{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}Workspace{% endblock %}</title>

  <!-- Apply saved theme immediately to prevent white flash -->
  <script>document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');</script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css"/>

  <!-- Alpine.js + Alpine AJAX -->
  <script defer src="https://cdn.jsdelivr.net/npm/@imacrayon/alpine-ajax@0.12.6/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Favicon -->
  <link rel="icon" href="https://fav.farm/ðŸ‘¥"/>

  <!-- Theme Color -->
  <meta name="theme-color" content="#111827"/>

  <style>
    [x-cloak] {
      display: none !important;
    }

    /* Breadcrumb separators */
    .bc-sep > li + li::before {
      content: "";
      display: block;
      margin: 0 0.375rem;
      height: 0.375rem;
      width: 0.375rem;
      opacity: 0.4;
      rotate: 45deg;
      border-top: 1px solid;
      border-right: 1px solid;
      flex-shrink: 0;
    }
    .bc-sep.bc-sep-slash > li + li::before {
      content: "/";
      rotate: none;
      border: none;
      height: auto;
      width: auto;
    }
    .bc-sep.bc-sep-dot > li + li::before {
      content: "Â·";
      rotate: none;
      border: none;
      height: auto;
      width: auto;
      font-size: 1.25em;
    }
    .bc-sep.bc-sep-arrow > li + li::before {
      content: "â†’";
      rotate: none;
      border: none;
      height: auto;
      width: auto;
    }
  </style>

  {% block extra_head %}{% endblock %}
</head>
<body class="{% block body_class %}bg-base-100{% endblock %}">
  {% block body %}{% endblock %}

  <!-- Generic Dialogs -->
  {% include "ui/partials/dialogs.html" %}
  <!-- Toast notifications -->
  {% include 'ui/partials/toasts.html' %}
  <!-- Initialize Lucide Icons -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    });

    // Theme toggle functionality
    (function () {
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        const saved = localStorage.getItem('theme') || 'light';
        themeToggle.checked = saved === 'dark';

        themeToggle.addEventListener('change', function() {
          const newTheme = this.checked ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
          // Persist to user settings API
          const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value
            || document.cookie.split('; ').find(c => c.startsWith('csrftoken='))?.split('=')[1]
            || '';
          fetch('/api/v1/settings/core/theme', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ value: newTheme }),
          }).catch(() => {});
        });
      }
    })();

    // Sync theme from server (if logged in) â€” runs after paint to avoid blocking
    (function () {
      fetch('/api/v1/settings/core/theme')
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if (!data || !data.value) return;
          const serverTheme = data.value;
          if (serverTheme !== localStorage.getItem('theme')) {
            localStorage.setItem('theme', serverTheme);
            document.documentElement.setAttribute('data-theme', serverTheme);
            const toggle = document.getElementById('themeToggle');
            if (toggle) toggle.checked = (serverTheme === 'dark');
          }
        })
        .catch(() => {});
    })();

    // Dialog utilities
    const AppDialog = {
      _setIcon(iconEl, icon, iconClass) {
        if (icon) {
          iconEl.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i>`;
          iconEl.className = `flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ${iconClass || 'bg-base-200 text-base-content'}`;
          if (typeof lucide !== 'undefined') lucide.createIcons({ nodes: [iconEl] });
        } else {
          iconEl.innerHTML = '';
          iconEl.className = 'hidden';
        }
      },

      confirm({ title = 'Confirm', message = 'Are you sure?', okLabel = 'OK', cancelLabel = 'Cancel', okClass = 'btn-primary', icon = '', iconClass = '' } = {}) {
        return new Promise((resolve) => {
          const dialog = document.getElementById('app-dialog-confirm');
          const iconEl = document.getElementById('app-dialog-confirm-icon');
          const titleEl = document.getElementById('app-dialog-confirm-title');
          const messageEl = document.getElementById('app-dialog-confirm-message');
          const okBtn = document.getElementById('app-dialog-confirm-ok');
          const cancelBtn = document.getElementById('app-dialog-confirm-cancel');

          this._setIcon(iconEl, icon, iconClass);
          titleEl.textContent = title;
          messageEl.textContent = message;
          okBtn.textContent = okLabel;
          cancelBtn.textContent = cancelLabel;
          okBtn.className = `btn btn-sm ${okClass}`;

          const cleanup = () => {
            okBtn.removeEventListener('click', onOk);
            dialog.removeEventListener('close', onClose);
            dialog.removeEventListener('keydown', onKeydown);
          };

          const onOk = () => {
            cleanup();
            dialog.close();
            resolve(true);
          };

          const onClose = () => {
            cleanup();
            resolve(false);
          };

          const onKeydown = (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              e.stopPropagation();
              onOk();
            }
          };

          okBtn.addEventListener('click', onOk);
          dialog.addEventListener('close', onClose);
          dialog.addEventListener('keydown', onKeydown);
          dialog.showModal();
          okBtn.focus();
        });
      },

      prompt({ title = 'Input', message = '', value = '', placeholder = '', okLabel = 'OK', cancelLabel = 'Cancel', okClass = 'btn-primary', icon = '', iconClass = '', inputSize = 'md' } = {}) {
        return new Promise((resolve) => {
          const dialog = document.getElementById('app-dialog-prompt');
          const iconEl = document.getElementById('app-dialog-prompt-icon');
          const titleEl = document.getElementById('app-dialog-prompt-title');
          const messageEl = document.getElementById('app-dialog-prompt-message');
          const input = document.getElementById('app-dialog-prompt-input');
          const textarea = document.getElementById('app-dialog-prompt-textarea');
          const okBtn = document.getElementById('app-dialog-prompt-ok');
          const cancelBtn = document.getElementById('app-dialog-prompt-cancel');

          this._setIcon(iconEl, icon, iconClass);
          titleEl.textContent = title;
          messageEl.textContent = message;
          messageEl.style.display = message ? '' : 'none';

          const useTextarea = inputSize === 'textarea';
          const activeInput = useTextarea ? textarea : input;
          const hiddenInput = useTextarea ? input : textarea;

          activeInput.classList.remove('hidden');
          hiddenInput.classList.add('hidden');

          activeInput.value = value;
          activeInput.placeholder = placeholder;

          if (!useTextarea) {
            input.className = `input input-bordered w-full mt-4 ${inputSize === 'sm' ? 'input-sm' : ''}`;
          }

          okBtn.textContent = okLabel;
          cancelBtn.textContent = cancelLabel;
          okBtn.className = `btn btn-sm ${okClass}`;

          const cleanup = () => {
            okBtn.removeEventListener('click', onOk);
            dialog.removeEventListener('close', onClose);
            activeInput.removeEventListener('keydown', onKeydown);
          };

          const onOk = () => {
            cleanup();
            const val = activeInput.value;
            dialog.close();
            resolve(val);
          };

          const onClose = () => {
            cleanup();
            resolve(null);
          };

          const onKeydown = (e) => {
            if (e.key === 'Enter' && !useTextarea) {
              e.preventDefault();
              e.stopPropagation();
              onOk();
            }
          };

          okBtn.addEventListener('click', onOk);
          dialog.addEventListener('close', onClose);
          activeInput.addEventListener('keydown', onKeydown);
          dialog.showModal();
          activeInput.focus();
          activeInput.select();
        });
      },

      message({ title = 'Message', message = 'Done.', okLabel = 'OK', icon = '', iconClass = '' } = {}) {
        return new Promise((resolve) => {
          const dialog = document.getElementById('app-dialog-message');
          const iconEl = document.getElementById('app-dialog-message-icon');
          const titleEl = document.getElementById('app-dialog-message-title');
          const messageEl = document.getElementById('app-dialog-message-message');
          const okBtn = document.getElementById('app-dialog-message-ok');

          this._setIcon(iconEl, icon, iconClass);
          titleEl.textContent = title;
          messageEl.textContent = message;
          okBtn.textContent = okLabel;

          const onClose = () => {
            dialog.removeEventListener('close', onClose);
            resolve();
          };

          dialog.addEventListener('close', onClose);
          dialog.showModal();
        });
      },

      error({ title = 'Error', message = 'An error occurred.', okLabel = 'OK' } = {}) {
        return this.message({ title, message, okLabel, icon: 'circle-alert', iconClass: 'bg-error/10 text-error' });
      }
    };

    // Inline Alert utilities
    const InlineAlert = {
      create({ type = 'info', message, title, dismissible = false, iconName, className = '' } = {}) {
        const icons = {
          success: 'check-circle',
          error: 'x-circle',
          warning: 'alert-triangle',
          info: 'info'
        };
        const icon = iconName || icons[type] || icons.info;

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} text-white ${className}`;

        let html = `<i data-lucide="${icon}" class="w-5 h-5 stroke-current shrink-0"></i>`;

        if (title) {
          html += `<div><h3 class="font-bold">${title}</h3><div class="text-sm">${message}</div></div>`;
        } else {
          html += `<span>${message}</span>`;
        }

        if (dismissible) {
          html += `<button type="button" class="btn btn-ghost btn-xs btn-circle ml-auto" aria-label="Dismiss">âœ•</button>`;
        }

        alertDiv.innerHTML = html;

        if (dismissible) {
          alertDiv.querySelector('button').addEventListener('click', () => {
            alertDiv.remove();
          });
        }

        // Initialize lucide icons for this element
        if (typeof lucide !== 'undefined') {
          const iconNodes = alertDiv.querySelectorAll('[data-lucide]');
          if (iconNodes.length) {
            lucide.createIcons({ nodes: [...iconNodes] });
          }
        }

        return alertDiv;
      },

      show(container, options) {
        const alert = this.create(options);
        if (typeof container === 'string') {
          container = document.querySelector(container);
        }
        container.appendChild(alert);
        return alert;
      }
    };
  </script>

  <!-- Shared components -->
  <script src="{% static 'ui/js/user_selector.js' %}"></script>

  {% if user.is_authenticated %}
  <!-- Chat unread store + SSE -->
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.store('chat', {
        totalUnread: 0,
        conversationUnreads: {},
        _es: null,

        init() {
          this.fetchUnreadCounts();
          this.connect();
        },

        async fetchUnreadCounts() {
          try {
            const resp = await fetch('/api/v1/chat/unread-counts', { credentials: 'same-origin' });
            if (resp.ok) {
              const data = await resp.json();
              this.totalUnread = data.total;
              this.conversationUnreads = data.conversations;
            }
          } catch (e) {}
        },

        _errorCount: 0,

        connect() {
          if (this._es) {
            this._es.close();
          }
          this._es = new EventSource('/api/v1/chat/stream');
          this._errorCount = 0;

          const events = ['unread', 'message', 'message_edited', 'message_deleted', 'reaction'];
          for (const evt of events) {
            this._es.addEventListener(evt, (e) => {
              try {
                const data = JSON.parse(e.data);
                if (evt === 'unread') {
                  this.totalUnread = data.total;
                  this.conversationUnreads = data.conversations;
                }
                window.dispatchEvent(new CustomEvent('chat-' + evt, { detail: data }));
              } catch (err) {}
            });
          }

          this._es.onerror = () => {
            this._errorCount++;
            // After repeated failures, back off â€” stop hammering the server
            if (this._errorCount > 5) {
              this._es.close();
              // Retry after 30s
              setTimeout(() => this.connect(), 30000);
            }
          };

          this._es.onopen = () => {
            this._errorCount = 0;
          };
        },
      });
    });
  </script>
  {% endif %}

  {% block extra_scripts %}{% endblock %}
</body>
</html>
