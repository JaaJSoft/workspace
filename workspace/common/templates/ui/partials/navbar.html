<div class="navbar bg-base-100 border-b border-base-300 backdrop-blur-lg bg-opacity-80 sticky top-0 z-50 min-h-[3.25rem] py-1">
  <div class="{% if navbar_full_width %}container mx-auto max-w-none{% else %}container mx-auto{% endif %}">
    <!-- Brand -->
    <div class="flex-none">
      <a href="/" class="btn btn-ghost normal-case hover:bg-primary/10 transition-all">
        {% include 'ui/partials/app_logo.html' with size='sm' %}
      </a>
    </div>

    <!-- Command palette dropdown -->
    <div class="flex-1 flex justify-center px-4" x-data="{ mobileSearchOpen: false }">
      <!-- Mobile search icon (visible only on small screens) -->
      <button
        @click="mobileSearchOpen = true"
        class="btn btn-ghost btn-circle btn-sm sm:hidden"
        title="Search"
      >
        <i data-lucide="search" class="w-5 h-5"></i>
      </button>

      <!-- Desktop search bar (hidden on small screens) -->
      <div class="w-full max-w-lg hidden sm:block relative" x-data="commandPaletteDropdown()">
        <!-- Search input trigger -->
        {% include 'ui/partials/search/search_input.html' with input_class='input-sm hover:border-primary/30' show_kbd=True %}

        <!-- Dropdown results -->
        <div
          x-show="open"
          x-cloak
          @click.outside="close()"
          class="absolute z-[100] mt-2 w-full bg-base-100 rounded-box shadow-2xl border border-base-300 overflow-hidden"
        >
          <!-- Quick actions & Search results -->
          {% include 'ui/partials/search/quick_actions.html' %}
          {% include 'ui/partials/search/search_results.html' %}

          <!-- Footer hints -->
          <div
            x-show="open"
            class="border-t border-base-300 px-3 py-2 bg-base-200/50 text-xs text-base-content/60 flex gap-3"
          >
            <span class="flex items-center gap-1">
              <kbd class="kbd kbd-xs">↑↓</kbd>
              navigate
            </span>
            <span class="flex items-center gap-1">
              <kbd class="kbd kbd-xs">⏎</kbd>
              select
            </span>
            <button
              type="button"
              @click="close()"
              class="btn btn-ghost btn-xs ml-auto"
              title="Close"
              aria-label="Close search results"
            >
              <i data-lucide="chevron-down" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile search modal (full screen overlay) -->
      <div
        x-show="mobileSearchOpen"
        x-cloak
        @click.self="mobileSearchOpen = false"
        class="sm:hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-start justify-center p-4"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
      >
        <div
          class="w-full max-w-lg mt-16 bg-base-100 rounded-box shadow-2xl"
          x-data="commandPaletteDropdown()"
          x-init="$watch('mobileSearchOpen', value => { if (value) { $nextTick(() => $refs.input?.focus()); open = true; } else { close(); } })"
          @click.stop
          x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0 scale-95"
          x-transition:enter-end="opacity-100 scale-100"
          x-transition:leave="transition ease-in duration-150"
          x-transition:leave-start="opacity-100 scale-100"
          x-transition:leave-end="opacity-0 scale-95"
        >
          <!-- Mobile search header -->
          <div class="p-4 border-b border-base-300 flex items-center gap-2">
            {% include 'ui/partials/search/search_input.html' with on_escape='mobileSearchOpen = false' %}
            <button
              @click="mobileSearchOpen = false"
              class="btn btn-ghost btn-circle btn-sm flex-shrink-0"
            >
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>

          <!-- Mobile search content -->
          <div class="max-h-[60vh] overflow-y-auto">
            {% include 'ui/partials/search/quick_actions.html' with on_click='mobileSearchOpen = false' %}
            {% include 'ui/partials/search/search_results.html' with on_click='mobileSearchOpen = false' container_class='p-2' %}
          </div>

          <!-- Footer hints -->
          <div class="border-t border-base-300 px-3 py-2 bg-base-200/50 text-xs text-base-content/60 flex gap-3">
            <span class="flex items-center gap-1">
              <kbd class="kbd kbd-xs">↑↓</kbd>
              navigate
            </span>
            <span class="flex items-center gap-1">
              <kbd class="kbd kbd-xs">⏎</kbd>
              select
            </span>
            <span class="flex items-center gap-1">
              <kbd class="kbd kbd-xs">Esc</kbd>
              close
            </span>
            <button
              type="button"
              @click="mobileSearchOpen = false"
              class="btn btn-ghost btn-xs ml-auto"
              title="Close"
              aria-label="Close search results"
            >
              <i data-lucide="chevron-down" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right side actions -->
    <div class="flex-none flex items-center gap-1.5">
      <!-- Add item button -->
      <a
        class="btn btn-ghost btn-circle btn-sm hover:bg-success/10 hover:text-success transition-all group"
        href="#"
        title="Add item (C)"
      >
        <i data-lucide="plus" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
      </a>

      <!-- Theme toggle -->
      <label
        class="swap swap-rotate btn btn-ghost btn-circle btn-sm hover:bg-warning/10 transition-all"
        title="Toggle theme"
      >
        <input id="themeToggle" type="checkbox" aria-label="Toggle theme"/>
        <!-- Sun icon (light) -->
        <div class="swap-off">
          <i data-lucide="sun" class="w-5 h-5 text-warning"></i>
        </div>
        <!-- Moon icon (dark) -->
        <div class="swap-on">
          <i data-lucide="moon" class="w-5 h-5 text-info"></i>
        </div>
      </label>
      <!-- Chat -->
      {% if user.is_authenticated %}
      <a href="/chat" class="btn btn-ghost btn-circle btn-sm hover:bg-info/10 transition-all indicator" title="Chat">
        <i data-lucide="message-circle" class="w-5 h-5"></i>
        <span class="indicator-item badge badge-info badge-xs"
              x-data x-show="$store.chat && $store.chat.totalUnread > 0"
              x-text="$store.chat.totalUnread > 99 ? '99+' : $store.chat.totalUnread"
              x-cloak></span>
      </a>
      {% endif %}

      {% include 'ui/partials/notifications.html' %}

      <!-- User menu dropdown -->
      <div class="dropdown dropdown-end">
        <label tabindex="0" class="btn btn-ghost btn-circle btn-sm cursor-pointer">
          {% include 'ui/partials/user_avatar.html' with user=user size='sm' show_ring=True %}
        </label>
        <ul
          tabindex="0"
          class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow-xl bg-base-100 border border-base-300 rounded-box w-64"
        >
          {% if user.is_authenticated %}
            <!-- User info header -->
            <li class="menu-title px-3 py-2 flex-row items-center gap-2">
              {% include 'ui/partials/user_avatar.html' with user=user size='md' %}
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-base-content truncate">{{ user.username }}</div>
                <div class="text-xs text-base-content/60 truncate">{{ user.email|default:"No email" }}</div>
              </div>
            </li>
            <div class="divider my-1"></div>

            <!-- Profile -->
            <li class="{% if request.resolver_match.view_name == 'user_profile' %}disabled{% endif %}">
              <a
                href="/profile"
                class="gap-3 {% if request.resolver_match.view_name != 'user_profile' %}hover:bg-primary/10 hover:text-primary{% endif %} transition-colors"
                {% if request.resolver_match.view_name == 'user_profile' %}style="opacity: 0.4;" onclick="event.preventDefault();"{% endif %}
              >
                <i data-lucide="user" class="w-4 h-4"></i>
                <span class="font-medium">Profile</span>
              </a>
            </li>

            <!-- Settings -->
            <li class="{% if request.resolver_match.view_name == 'user_settings' %}disabled{% endif %}">
              <a
                href="/settings"
                class="gap-3 {% if request.resolver_match.view_name != 'user_settings' %}hover:bg-info/10 hover:text-info{% endif %} transition-colors"
                {% if request.resolver_match.view_name == 'user_settings' %}style="opacity: 0.4;" onclick="event.preventDefault();"{% endif %}
              >
                <i data-lucide="settings" class="w-4 h-4"></i>
                <span class="font-medium">Settings</span>
              </a>
            </li>

            {% if user.is_staff or user.is_superuser %}
              <div class="divider my-1">
                <span class="text-xs text-base-content/40 uppercase tracking-wider">Admin</span>
              </div>

              <!-- Admin -->
              <li>
                <a href="/admin/" class="gap-3 hover:bg-error/10 hover:text-error transition-colors">
                  <i data-lucide="shield" class="w-4 h-4"></i>
                  <span class="font-medium">Admin Panel</span>
                </a>
              </li>

              <!-- API Docs -->
              <li>
                <a
                  href="/schema/swagger-ui/"
                  class="gap-3 hover:bg-secondary/10 hover:text-secondary transition-colors"
                >
                  <i data-lucide="code-2" class="w-4 h-4"></i>
                  <span class="font-medium">API Docs</span>
                </a>
              </li>
            {% endif %}

            <div class="divider my-1"></div>

            <!-- Health Check -->
            <li>
              <a href="/health/" class="gap-3 hover:bg-success/10 hover:text-success transition-colors">
                <i data-lucide="activity" class="w-4 h-4"></i>
                <span class="font-medium">Health Check</span>
              </a>
            </li>

            <div class="divider my-1"></div>

            <!-- Logout -->
            <li>
              <button
                type="button"
                onclick="document.getElementById('logout-form').submit();"
                class="gap-3 hover:bg-error/10 hover:text-error transition-colors font-medium"
              >
                <i data-lucide="log-out" class="w-4 h-4"></i>
                <span>Sign Out</span>
              </button>
            </li>
          {% else %}
            <li>
              <a
                href="{% url 'login' %}?next={{ request.path }}"
                class="gap-3 hover:bg-primary/10 hover:text-primary transition-colors"
              >
                <i data-lucide="log-in" class="w-4 h-4"></i>
                <span class="font-medium">Sign In</span>
              </a>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Hidden logout form -->
{% if user.is_authenticated %}
<form id="logout-form" method="post" action="{% url 'logout' %}" style="display: none;">
  {% csrf_token %}
</form>
{% endif %}

{% include 'ui/partials/search/command_palette_dropdown_scripts.html' %}
