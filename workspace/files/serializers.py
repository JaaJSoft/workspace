from rest_framework import serializers
from drf_spectacular.types import OpenApiTypes
from drf_spectacular.utils import extend_schema_field
from .models import File


class FileSerializer(serializers.ModelSerializer):
    is_folder = serializers.SerializerMethodField(
        help_text="True when node_type is 'folder'."
    )
    is_file = serializers.SerializerMethodField(
        help_text="True when node_type is 'file'."
    )

    class Meta:
        model = File
        fields = [
            'uuid',
            'name',
            'node_type',
            'parent',
            'content',
            'size',
            'mime_type',
            'owner',
            'created_at',
            'updated_at',
            'path',
            'is_folder',
            'is_file',
        ]
        read_only_fields = ['owner', 'created_at', 'updated_at', 'size', 'path']
        extra_kwargs = {
            'uuid': {
                'help_text': 'Unique identifier. Generated by the server if omitted.'
            },
            'name': {'help_text': 'Display name of the file or folder.'},
            'node_type': {'help_text': "Either 'file' or 'folder'."},
            'parent': {'help_text': 'Parent folder UUID.'},
            'content': {'help_text': 'File payload. Must be empty for folders.'},
            'size': {'help_text': 'File size in bytes.'},
            'mime_type': {'help_text': 'MIME type for file nodes.'},
            'owner': {'help_text': 'Owner user id.'},
            'created_at': {'help_text': 'Creation timestamp.'},
            'updated_at': {'help_text': 'Last update timestamp.'},
        }

    @extend_schema_field(OpenApiTypes.BOOL)
    def get_is_folder(self, obj):
        return obj.is_folder()

    @extend_schema_field(OpenApiTypes.BOOL)
    def get_is_file(self, obj):
        return obj.is_file()

    def validate(self, attrs):
        if self.instance is not None:
            errors = {}
            initial_data = self.initial_data or {}

            if 'uuid' in initial_data:
                incoming_uuid = str(initial_data.get('uuid')).lower()
                if incoming_uuid != str(self.instance.uuid).lower():
                    errors['uuid'] = 'This field is immutable.'

            if 'owner' in initial_data:
                incoming_owner = str(initial_data.get('owner'))
                if incoming_owner != str(self.instance.owner_id):
                    errors['owner'] = 'This field is immutable.'

            if 'node_type' in initial_data:
                if str(initial_data.get('node_type')) != self.instance.node_type:
                    errors['node_type'] = 'This field is immutable.'

            if errors:
                raise serializers.ValidationError(errors)

        return super().validate(attrs)

    def create(self, validated_data):
        validated_data['owner'] = self.context['request'].user
        return super().create(validated_data)
