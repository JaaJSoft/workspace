{% extends 'base_with_navbar.html' %}
{% load file_filters static %}

{% block title %}Files - Workspace{% endblock %}

{% block navbar %}
{% include 'ui/partials/navbar.html' with navbar_full_width=True %}
{% endblock %}

{% block drawer_class %}lg:drawer-open{% endblock %}
{% block drawer_id %}files-drawer{% endblock %}

{% block main_class %}p-0 flex flex-col h-full overflow-hidden{% endblock %}

{% block drawer_sidebar %}
<div class="drawer-side z-40 h-full" x-data="sidebarCollapse()" x-init="init()"
  <label for="files-drawer" aria-label="close sidebar" class="drawer-overlay"></label>

  <!-- Sidebar -->
  <aside class="bg-base-200 h-full border-r border-base-300 flex flex-col transition-all duration-300"
         :class="collapsed ? 'w-16' : 'w-72'">
    <!-- Sidebar header -->
    <div class="border-b border-base-300" :class="collapsed ? 'p-3' : 'p-4'">
      <div class="flex items-center" :class="collapsed ? 'justify-center' : 'justify-start'">
        <!-- Expanded state: Title only -->
        <h2 class="text-xl font-semibold flex items-center gap-2" x-show="!collapsed" x-transition>
          <i data-lucide="hard-drive" class="w-6 h-6"></i>
          My Files
        </h2>
        <!-- Collapsed state: Icon only -->
        <div x-show="collapsed" x-transition class="flex justify-center">
          <i data-lucide="hard-drive" class="w-6 h-6"></i>
        </div>
      </div>
    </div>

    <!-- Quick Access -->
    <div class="flex-1 overflow-y-auto" :class="collapsed ? 'p-2' : 'p-4'">
      <h3 class="text-sm font-semibold text-base-content/60 uppercase tracking-wider mb-4"
          x-show="!collapsed" x-transition>Quick Access</h3>
      <ul class="space-y-2">
        {% if not current_folder %}
          {% include "ui/partials/drawer_item.html" with href="/files" icon="folder" label="All Files" active=True x_target="folder-browser" x_target_history="push" %}
        {% else %}
          {% include "ui/partials/drawer_item.html" with href="/files" icon="folder" label="All Files" active=False x_target="folder-browser" x_target_history="push" %}
        {% endif %}
        {% include "ui/partials/drawer_item.html" with icon="clock" label="Recent" disabled=True badge="Soon" %}
        {% include "ui/partials/drawer_item.html" with icon="trash-2" label="Trash" disabled=True badge="Soon" %}
      </ul>
    </div>

    <!-- Storage Stats (Always at bottom) -->
    <div class="border-t border-base-300 bg-base-100/50" :class="collapsed ? 'p-3' : 'p-4'">
      <div x-show="!collapsed" x-transition>
        <h3 class="text-sm font-semibold text-base-content/60 uppercase tracking-wider mb-3">Storage</h3>
        <div class="space-y-2">
          <div class="flex justify-between text-base">
            <span class="text-base-content/70">Used</span>
            <span class="font-medium">{{ storage_stats.total_size|filesize }}</span>
          </div>
          <div class="flex gap-4 text-sm text-base-content/60">
            <span>{{ storage_stats.file_count }} file{{ storage_stats.file_count|pluralize }}</span>
            <span>{{ storage_stats.folder_count }} folder{{ storage_stats.folder_count|pluralize }}</span>
          </div>
        </div>
      </div>
      <div x-show="collapsed" x-transition class="flex justify-center py-1">
        <div class="tooltip tooltip-right" data-tip="{{ storage_stats.total_size|filesize }} used">
          <i data-lucide="database" class="w-5 h-5"></i>
        </div>
      </div>
    </div>

    <!-- Toggle Button (Always at bottom) -->
    <div class="border-t border-base-300" :class="collapsed ? 'p-2' : 'p-4'">
      <button @click="toggleCollapse()"
              class="flex items-center w-full py-3 text-base hover:bg-base-300/50 rounded-lg transition-colors"
              :class="collapsed ? 'justify-center px-2' : 'gap-3 px-3'"
              :aria-label="collapsed ? 'Expand sidebar' : 'Collapse sidebar'"
              :title="collapsed ? 'Expand sidebar' : 'Collapse sidebar'">
        <i :data-lucide="collapsed ? 'panel-left-open' : 'panel-left-close'" class="w-5 h-5 flex-shrink-0"></i>
        <span x-show="!collapsed" x-transition class="flex-1 text-left">Collapse</span>
      </button>
    </div>
  </aside>
</div>
{% endblock %}

{% block content %}
<div x-data="fileBrowser()" class="h-full flex flex-col">
  {% partialdef folder-browser inline %}
  <div class="h-full flex flex-col" id="folder-browser" data-folder="{{ current_folder.uuid|default:'' }}" x-init="$nextTick(() => lucide.createIcons())">

    <!-- Top Header Bar -->
    <div class="bg-base-100 border-b border-base-300 p-4 lg:p-6">
      <!-- Header with breadcrumb, title and actions on same line -->
      <div class="flex items-start gap-3">
        <!-- Mobile drawer toggle -->
        <label for="files-drawer" class="btn btn-square btn-ghost drawer-button lg:hidden flex-shrink-0 -ml-2">
          <i data-lucide="panel-left" class="w-5 h-5"></i>
        </label>

        <!-- Left: Breadcrumb and Title -->
        <div class="flex-1 min-w-0">
          <!-- Breadcrumb row with action button aligned -->
          <div class="flex items-center justify-between gap-4 mb-1">
            <div class="flex items-center gap-2 min-w-0">
              {% include 'ui/partials/breadcrumbs.html' with breadcrumbs=breadcrumbs x_target="folder-browser" x_target_history="push" %}
              <a
                href="{% if current_folder %}/files/{{ current_folder.uuid }}{% else %}/files{% endif %}"
                class="btn btn-ghost btn-sm btn-square"
                title="Refresh"
                aria-label="Refresh"
                x-target="folder-browser"
              >
                <i data-lucide="rotate-cw" class="w-4 h-4"></i>
              </a>
            </div>

            <!-- Action button with dropdown -->
            <div class="dropdown dropdown-end flex-shrink-0">
              <button tabindex="0" class="btn btn-primary btn-sm gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i>
                <span class="hidden sm:inline">New</span>
                <i data-lucide="chevron-down" class="w-3 h-3 hidden sm:inline opacity-70"></i>
              </button>
              {% include 'files/ui/partials/new_menu.html' %}
            </div>
          </div>

          <!-- Title below breadcrumb -->
          <h1 class="text-2xl font-bold text-base-content">
            {% if current_folder %}{{ current_folder.name }}{% else %}All Files{% endif %}
          </h1>
        </div>
      </div>
    </div>

    <!-- Alerts container -->
    <div x-ref="alertsContainer" class="px-4 lg:px-6"></div>

    <!-- Main Content Area with Table -->
    <div class="flex-1 overflow-hidden flex flex-col bg-base-200/30">
      {% include 'files/ui/partials/folder_content.html' with nodes=nodes folder_stats=folder_stats %}
    </div>
  </div>
  {% endpartialdef %}
</div>

{% include 'files/ui/partials/dialogs.html' %}
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'files/ui/js/file_browser.js' %}"></script>
{% endblock %}
