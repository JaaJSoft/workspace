{% extends 'base_with_navbar.html' %}
{% load file_filters static %}

{% block title %}Files - Workspace{% endblock %}

{% block navbar %}
{% include 'ui/partials/navbar.html' with navbar_full_width=True %}
{% endblock %}

{% block drawer_class %}drawer-open{% endblock %}
{% block drawer_id %}files-drawer{% endblock %}

{% block main_class %}p-0 flex flex-col h-full overflow-hidden{% endblock %}

{% block drawer_sidebar %}
<div class="drawer-side z-40 h-full" x-data="sidebarCollapse()"
  <label for="files-drawer" aria-label="close sidebar" class="drawer-overlay"></label>

  <!-- Sidebar -->
  <aside class="bg-base-200 h-full border-r border-base-300 flex flex-col transition-all duration-300"
         :class="collapsed ? 'w-16' : 'w-72'">
    <!-- Sidebar header -->
    <div class="border-b border-base-300 py-4 px-3">
      <div class="flex items-center" :class="collapsed ? 'justify-center' : 'justify-between'">
        <h2 class="text-xl font-semibold flex items-center gap-2" :class="collapsed ? '' : 'pl-2'">
          <i data-lucide="hard-drive" class="w-6 h-6 text-primary"></i>
          <span x-show="!collapsed" x-transition>My Files</span>
        </h2>
        <button
          type="button"
          class="btn btn-ghost btn-sm btn-square mr-1 hover:text-primary"
          aria-label="Settings"
          title="Settings"
          x-show="!collapsed"
          x-transition
        >
          <i data-lucide="settings" class="w-4 h-4"></i>
        </button>
      </div>
    </div>

    <!-- Quick Access -->
    <div class="flex-1 overflow-y-auto py-4 px-3">
      <h3 class="text-sm font-semibold text-base-content/60 uppercase tracking-wider overflow-hidden transition-all duration-200"
          :class="collapsed ? 'max-h-0 mb-0 opacity-0' : 'max-h-6 mb-4 opacity-100'"
          :aria-hidden="collapsed">
        <span class="flex items-center gap-2">
          <i data-lucide="zap" class="w-3 h-3"></i>
          Quick Access
        </span>
      </h3>
      <ul class="space-y-2">
        {% include "ui/partials/drawer_item.html" with href="/files" icon="folder" label="All Files" color="primary" active=is_root_view active_binding="activeView === 'root'" onclick="setActiveView('root')" x_target="folder-browser" x_target_history="push" %}
        {% include "ui/partials/drawer_item.html" with href="/files?favorites=1" icon="star" label="Favorites" color="warning" active=is_favorites_view active_binding="activeView === 'favorites'" onclick="setActiveView('favorites')" x_target="folder-browser" x_target_history="push" %}
        {% include "ui/partials/drawer_item.html" with href="/files?recent=1" icon="clock" label="Recent" color="info" active=is_recent_view active_binding="activeView === 'recent'" onclick="setActiveView('recent')" x_target="folder-browser" x_target_history="push" %}
        {% include "ui/partials/drawer_item.html" with href="/files/trash" icon="trash-2" label="Trash" color="error" active=is_trash_view active_binding="activeView === 'trash'" onclick="setActiveView('trash')" x_target="folder-browser" x_target_history="push" %}
      </ul>

      <!-- Pinned Folders -->
      <div id="pinned-folders-section" x-data="pinnedFoldersSection()">
        <hr class="my-3 border-base-300 transition-all duration-200"
            :class="collapsed ? 'opacity-0' : 'opacity-100'"
            x-show="!collapsed || pinnedCount > 0">
        <h3 class="text-sm font-semibold text-base-content/60 uppercase tracking-wider overflow-hidden transition-all duration-200"
            :class="collapsed ? 'max-h-0 mb-0 opacity-0' : 'max-h-6 mb-3 opacity-100'"
            :aria-hidden="collapsed"
            x-show="!collapsed || pinnedCount > 0">
          <span class="flex items-center gap-2">
            <i data-lucide="pin" class="w-3 h-3"></i>
            Pinned
          </span>
        </h3>
        <!-- Drop zone -->
        <div
          @dragover.prevent="onDragOver($event)"
          @dragenter.prevent="onDragEnter($event)"
          @dragleave="onDragLeave($event)"
          @drop.prevent="onDrop($event)"
          :class="dragOver ? 'bg-primary/10 ring-2 ring-primary/40 ring-inset rounded-lg scale-[1.02]' : ''"
          class="transition-all duration-200 -mx-1 px-1 py-2 min-h-[60px]"
        >
          <ul class="space-y-2" id="pinned-folders-list" x-target="pinned-folders-list">
            {% include 'files/ui/partials/pinned_folders.html' %}
          </ul>
          <!-- Drop hint when dragging -->
          <div x-show="dragOver" x-cloak x-transition
               class="text-xs text-primary font-medium text-center py-4 border-2 border-dashed border-primary/40 rounded-lg mt-2 bg-primary/5"
               :class="collapsed ? 'hidden' : ''">
            <i data-lucide="pin" class="w-4 h-4 inline-block mb-1"></i>
            <br>
            Drop to pin folder
          </div>
        </div>
      </div>
    </div>

    <!-- Toggle Button (Always at bottom) -->
    <div class="border-t border-base-300 py-4 px-3">
      <ul class="menu p-0" x-show="!isMobile()">
        {% include "ui/partials/drawer_item.html" with icon_binding="collapsed ? 'panel-left-open' : 'panel-left-close'" label="Collapse" onclick="toggleCollapse()" title_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" aria_label_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" %}
      </ul>
    </div>
  </aside>
</div>
{% endblock %}

{% block content %}
<div x-data="fileBrowser()" class="h-full flex flex-col">
  {% partialdef folder-browser inline %}
  <div class="h-full flex flex-col" id="folder-browser" data-folder="{{ current_folder.uuid|default:'' }}" x-init="$nextTick(() => lucide.createIcons())">

    <!-- Top Header Bar -->
    <div class="bg-base-100 border-b border-base-300 p-4 lg:p-6">
      <!-- Header with breadcrumb, title and actions on same line -->
      <div class="flex items-start gap-3">
        <!-- Left: Breadcrumb and Title -->
        <div class="flex-1 min-w-0">
          <!-- Breadcrumb row with action button aligned -->
          <div class="flex items-center justify-between gap-4 mb-1">
            <div class="flex items-center gap-2 min-w-0">
              {% include 'ui/partials/breadcrumbs.html' with breadcrumbs=breadcrumbs x_target="folder-browser" x_target_history="push" %}
              <a
                href="{{ current_view_url }}"
                class="btn btn-ghost btn-sm btn-square"
                title="Refresh"
                aria-label="Refresh"
                x-target="folder-browser"
                data-refresh-folder-browser
              >
                <i data-lucide="rotate-cw" class="w-4 h-4"></i>
              </a>
            </div>

            {% if is_trash_view %}
            <div class="flex-shrink-0">
              <button type="button" class="btn btn-error btn-sm gap-2" @click="confirmCleanTrash()">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
                <span class="hidden sm:inline">Empty trash</span>
              </button>
            </div>
            {% else %}
            <!-- Action button with dropdown -->
            <div class="dropdown dropdown-end flex-shrink-0">
              <button tabindex="0" class="btn btn-primary btn-sm gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i>
                <span class="hidden sm:inline">New</span>
                <i data-lucide="chevron-down" class="w-3 h-3 hidden sm:inline opacity-70"></i>
              </button>
              {% include 'files/ui/partials/new_menu.html' %}
            </div>
            {% endif %}
          </div>

          <!-- Title below breadcrumb -->
          <h1 class="text-2xl font-bold text-base-content">{{ page_title }}</h1>
        </div>
      </div>
    </div>

    <!-- Main Content Area with Table -->
    <div class="flex-1 overflow-hidden flex flex-col bg-base-200/30 relative"
         @dragenter="onFileDragEnter($event)"
         @dragover="onFileDragOver($event)"
         @dragleave="onFileDragLeave($event)"
         @drop.prevent="onFileDrop($event)">
      <!-- Drop zone overlay -->
      <div x-show="dropZoneActive" x-cloak x-transition.opacity
           class="absolute inset-0 z-50 bg-base-100/90 backdrop-blur-sm border-2 border-dashed border-primary rounded-lg flex items-center justify-center pointer-events-none">
        <div class="text-center">
          <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto mb-3 text-primary"></i>
          <p class="text-lg font-semibold text-primary">Drop files to upload</p>
          <p class="text-sm text-base-content/60">Files will be added to the current folder</p>
        </div>
      </div>
      {% include 'files/ui/partials/folder_content.html' with nodes=nodes folder_stats=folder_stats empty_title=empty_title empty_message=empty_message %}
    </div>
  </div>
  {% endpartialdef %}
</div>

{% include 'files/ui/partials/dialogs.html' %}
{% include 'files/ui/partials/file_viewer_modal.html' %}
{% include 'files/ui/partials/properties_modal.html' %}
{% include 'files/ui/partials/context_menu.html' %}
{% endblock %}

{% block extra_scripts %}
<!-- Monaco Editor for text/code viewing and editing -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

<!-- File browser -->
<script src="{% static 'files/ui/js/file_browser.js' %}"></script>

{% endblock %}
