{% extends 'base_with_navbar.html' %}
{% load file_filters %}

{% block title %}Files - Workspace{% endblock %}

{% block drawer_class %}lg:drawer-open{% endblock %}
{% block drawer_id %}files-drawer{% endblock %}

{% block main_class %}p-0 flex flex-col h-full overflow-hidden{% endblock %}

{% block drawer_sidebar %}
<div class="drawer-side z-40 h-full">
  <label for="files-drawer" aria-label="close sidebar" class="drawer-overlay"></label>

  <!-- Sidebar -->
  <aside class="bg-base-200 w-72 h-full border-r border-base-300 flex flex-col">
    <!-- Sidebar header -->
    <div class="p-4 border-b border-base-300">
      <h2 class="text-lg font-semibold flex items-center gap-2">
        <i data-lucide="hard-drive" class="w-5 h-5"></i>
        My Files
      </h2>
    </div>

    <!-- Quick Access -->
    <div class="flex-1 overflow-y-auto p-4">
      <h3 class="text-xs font-semibold text-base-content/60 uppercase tracking-wider mb-3">Quick Access</h3>
      <ul class="menu menu-sm p-0 gap-1">
        <li>
          <a href="/files" class="{% if not current_folder %}active{% endif %} gap-3" x-target="folder-browser">
            <i data-lucide="folder" class="w-4 h-4"></i>
            All Files
          </a>
        </li>
        <li class="disabled">
          <span class="gap-3 opacity-50 cursor-not-allowed">
            <i data-lucide="clock" class="w-4 h-4"></i>
            Recent
            <span class="badge badge-xs">Soon</span>
          </span>
        </li>
        <li class="disabled">
          <span class="gap-3 opacity-50 cursor-not-allowed">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
            Trash
            <span class="badge badge-xs">Soon</span>
          </span>
        </li>
      </ul>
    </div>

    <!-- Storage Stats (Always at bottom) -->
    <div class="p-4 border-t border-base-300 bg-base-100/50 mt-auto">
      <h3 class="text-xs font-semibold text-base-content/60 uppercase tracking-wider mb-3">Storage</h3>
      <div class="space-y-2">
        <div class="flex justify-between text-sm">
          <span class="text-base-content/70">Used</span>
          <span class="font-medium">{{ storage_stats.total_size|filesize }}</span>
        </div>
        <div class="flex gap-4 text-xs text-base-content/60">
          <span>{{ storage_stats.file_count }} file{{ storage_stats.file_count|pluralize }}</span>
          <span>{{ storage_stats.folder_count }} folder{{ storage_stats.folder_count|pluralize }}</span>
        </div>
      </div>
    </div>
  </aside>
</div>
{% endblock %}

{% block content %}
<div x-data="fileBrowser()" class="h-full flex flex-col">
  {% partialdef folder-browser inline %}
  <div class="h-full flex flex-col" id="folder-browser" data-folder="{{ current_folder.uuid|default:'' }}" x-init="$nextTick(() => lucide.createIcons())">

    <!-- Top Header Bar -->
    <div class="bg-base-100 border-b border-base-300 p-4 lg:p-6">
      <!-- Header with breadcrumb, title and actions on same line -->
      <div class="flex items-start gap-3">
        <!-- Mobile drawer toggle -->
        <label for="files-drawer" class="btn btn-square btn-ghost drawer-button lg:hidden flex-shrink-0 -ml-2">
          <i data-lucide="panel-left" class="w-5 h-5"></i>
        </label>

        <!-- Left: Breadcrumb and Title -->
        <div class="flex-1 min-w-0">
          <div class="flex items-center justify-between gap-4">
            <div class="flex-1 min-w-0">
              {% include 'ui/partials/breadcrumbs.html' with breadcrumbs=breadcrumbs x_target="folder-browser" %}
              <h1 class="text-2xl font-bold text-base-content mt-1">
                {% if current_folder %}{{ current_folder.name }}{% else %}All Files{% endif %}
              </h1>
            </div>

            <!-- Right: Action button with dropdown -->
            <div class="dropdown dropdown-end">
              <button tabindex="0" class="btn btn-primary btn-sm gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i>
                <span class="hidden sm:inline">New</span>
                <i data-lucide="chevron-down" class="w-3 h-3 hidden sm:inline opacity-70"></i>
              </button>
              <ul tabindex="0" class="dropdown-content z-50 menu menu-sm shadow-xl bg-base-100 border border-base-300 rounded-lg w-56 p-1 mt-2">
                <li>
                  <button
                    type="button"
                    class="gap-3 rounded"
                    @click="showCreateFolderDialog()"
                  >
                    <i data-lucide="folder-plus" class="w-4 h-4 text-warning"></i>
                    <div class="flex-1">
                      <div class="font-medium">New Folder</div>
                      <div class="text-xs text-base-content/60">Create a new folder</div>
                    </div>
                  </button>
                </li>
                <li>
                  <label class="gap-3 rounded cursor-pointer">
                    <i data-lucide="file-plus" class="w-4 h-4 text-info"></i>
                    <div class="flex-1">
                      <div class="font-medium">Upload Files</div>
                      <div class="text-xs text-base-content/60">Select files from your computer</div>
                    </div>
                    <input
                      type="file"
                      class="hidden"
                      multiple
                      @change="handleUpload($event)"
                    />
                  </label>
                </li>
                <div class="divider my-1"></div>
                <li>
                  <label class="gap-3 rounded cursor-pointer">
                    <i data-lucide="folder-open" class="w-4 h-4 text-success"></i>
                    <div class="flex-1">
                      <div class="font-medium">Upload Folder</div>
                      <div class="text-xs text-base-content/60">Upload entire folder</div>
                    </div>
                    <input
                      type="file"
                      class="hidden"
                      webkitdirectory
                      directory
                      @change="handleUpload($event)"
                    />
                  </label>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alerts container -->
    <div x-ref="alertsContainer" class="px-4 lg:px-6"></div>

    <!-- Main Content Area with Table -->
    <div class="flex-1 overflow-hidden flex flex-col bg-base-200/30">
      {% include 'files/ui/partials/folder_content.html' with nodes=nodes folder_stats=folder_stats %}
    </div>
  </div>
  {% endpartialdef %}
</div>

<!-- Create Folder Dialog -->
<dialog id="create-folder-dialog" class="modal">
  <div class="modal-box" x-data>
    <h3 class="font-bold text-lg mb-4">Create New Folder</h3>
    <form @submit.prevent="$dispatch('create-folder', { name: $refs.folderName.value })">
      <div class="form-control">
        <label class="label">
          <span class="label-text">Folder name</span>
        </label>
        <input
          x-ref="folderName"
          type="text"
          placeholder="New folder"
          class="input input-bordered w-full"
          required
        />
      </div>
      <div class="modal-action">
        <button type="button" class="btn" onclick="document.getElementById('create-folder-dialog').close()">Cancel</button>
        <button type="submit" class="btn btn-primary">Create</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<!-- Rename Dialog -->
<dialog id="rename-dialog" class="modal">
  <div class="modal-box" x-data="{ uuid: '', name: '' }" @open-rename.window="uuid = $event.detail.uuid; name = $event.detail.name">
    <h3 class="font-bold text-lg mb-4">Rename</h3>
    <form @submit.prevent="$dispatch('rename-item', { uuid: uuid, name: $refs.newName.value })">
      <div class="form-control">
        <label class="label">
          <span class="label-text">New name</span>
        </label>
        <input
          x-ref="newName"
          x-model="name"
          type="text"
          class="input input-bordered w-full"
          required
        />
      </div>
      <div class="modal-action">
        <button type="button" class="btn" onclick="document.getElementById('rename-dialog').close()">Cancel</button>
        <button type="submit" class="btn btn-primary">Rename</button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<script>
function fileBrowser() {
  return {
    get currentFolder() {
      const folderEl = document.getElementById('folder-browser');
      return folderEl?.dataset.folder || '';
    },

    showCreateFolderDialog() {
      const dialog = document.getElementById('create-folder-dialog');
      const input = dialog.querySelector('input');
      input.value = '';
      dialog.showModal();
      setTimeout(() => input.focus(), 100);
    },

    showRenameDialog(uuid, name) {
      const dialog = document.getElementById('rename-dialog');
      window.dispatchEvent(new CustomEvent('open-rename', { detail: { uuid, name } }));
      dialog.showModal();
      setTimeout(() => dialog.querySelector('input').focus(), 100);
    },

    async confirmDelete(uuid, name, nodeType) {
      const confirmed = await AppDialog.confirm({
        title: `Delete ${nodeType}?`,
        message: `Are you sure you want to delete "${name}"?${nodeType === 'folder' ? ' This will also delete all contents.' : ''}`,
        okLabel: 'Delete',
        okClass: 'btn-error'
      });
      if (confirmed) {
        this.deleteItem(uuid);
      }
    },

    async createFolder(name) {
      try {
        const response = await fetch('/api/v1/files', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': this.getCsrfToken()
          },
          body: JSON.stringify({
            name: name,
            node_type: 'folder',
            parent: this.currentFolder || null
          })
        });
        if (response.ok) {
          document.getElementById('create-folder-dialog').close();
          window.location.reload();
        } else {
          const data = await response.json();
          this.showAlert('error', data.detail || 'Failed to create folder');
        }
      } catch (error) {
        this.showAlert('error', 'Failed to create folder');
      }
    },

    async handleUpload(event) {
      const files = event.target.files;
      if (!files.length) return;

      for (const file of files) {
        const formData = new FormData();
        formData.append('name', file.name);
        formData.append('node_type', 'file');
        formData.append('content', file);
        if (this.currentFolder) {
          formData.append('parent', this.currentFolder);
        }

        try {
          const response = await fetch('/api/v1/files', {
            method: 'POST',
            headers: {
              'X-CSRFToken': this.getCsrfToken()
            },
            body: formData
          });
          if (!response.ok) {
            const data = await response.json();
            this.showAlert('error', `Failed to upload ${file.name}: ${data.detail || 'Unknown error'}`);
          }
        } catch (error) {
          this.showAlert('error', `Failed to upload ${file.name}`);
        }
      }
      window.location.reload();
    },

    async renameItem(uuid, newName) {
      try {
        const response = await fetch(`/api/v1/files/${uuid}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': this.getCsrfToken()
          },
          body: JSON.stringify({ name: newName })
        });
        if (response.ok) {
          document.getElementById('rename-dialog').close();
          window.location.reload();
        } else {
          const data = await response.json();
          this.showAlert('error', data.detail || 'Failed to rename');
        }
      } catch (error) {
        this.showAlert('error', 'Failed to rename');
      }
    },

    async deleteItem(uuid) {
      try {
        const response = await fetch(`/api/v1/files/${uuid}`, {
          method: 'DELETE',
          headers: {
            'X-CSRFToken': this.getCsrfToken()
          }
        });
        if (response.ok) {
          window.location.reload();
        } else {
          this.showAlert('error', 'Failed to delete');
        }
      } catch (error) {
        this.showAlert('error', 'Failed to delete');
      }
    },

    showAlert(type, message) {
      const alert = InlineAlert.create({ type, message, dismissible: true, className: 'mb-4' });
      this.$refs.alertsContainer.appendChild(alert);
    },

    getCsrfToken() {
      return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
             document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
    },

    init() {
      // Listen for form submissions from dialogs
      window.addEventListener('create-folder', (e) => this.createFolder(e.detail.name));
      window.addEventListener('rename-item', (e) => this.renameItem(e.detail.uuid, e.detail.name));
    }
  };
}
</script>
{% endblock %}