{% extends 'base_with_navbar.html' %}
{% load file_filters static %}

{% block title %}Files - Workspace{% endblock %}

{% block extra_head %}
<!-- Milkdown Crepe - External dependency CSS (loaded directly to avoid bare @import 404s) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prosemirror-view@1/style/prosemirror.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prosemirror-gapcursor@1/style/gapcursor.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prosemirror-virtual-cursor@0/style/virtual-cursor.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prosemirror-tables@1/style/tables.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0/dist/katex.min.css">
<!-- Milkdown Crepe - Common feature styles (only files without bare @import) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@milkdown/crepe@7.17.3/lib/theme/common/reset.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@milkdown/crepe@7.17.3/lib/theme/common/block-edit.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@milkdown/crepe@7.17.3/lib/theme/common/code-mirror.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@milkdown/crepe@7.17.3/lib/theme/common/image-block.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@milkdown/crepe@7.17.3/lib/theme/common/link-tooltip.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@milkdown/crepe@7.17.3/lib/theme/common/list-item.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@milkdown/crepe@7.17.3/lib/theme/common/placeholder.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@milkdown/crepe@7.17.3/lib/theme/common/toolbar.css">
<!-- Milkdown Crepe - DaisyUI theme bridge + custom rules (cursor, table, latex) -->
<link rel="stylesheet" href="{% static 'files/ui/css/milkdown-overrides.css' %}">
{% endblock %}

{% block navbar %}
{% include 'ui/partials/navbar.html' with navbar_full_width=True %}
{% endblock %}

{% block drawer_class %}drawer-open{% endblock %}
{% block drawer_id %}files-drawer{% endblock %}

{% block main_class %}p-0 flex flex-col h-full overflow-hidden{% endblock %}

{% block drawer_sidebar %}
<div class="drawer-side z-40 h-full" x-data="sidebarCollapse()"
  <label for="files-drawer" aria-label="close sidebar" class="drawer-overlay"></label>

  <!-- Sidebar -->
  <aside class="bg-base-200 h-full border-r border-base-300 flex flex-col transition-all duration-300"
         :class="collapsed ? 'w-16' : 'w-72'">
    <!-- Sidebar header -->
    <div class="border-b border-base-300 py-4 px-3">
      <div class="flex items-center" :class="collapsed ? 'justify-center' : 'justify-between'">
        <h2 class="text-xl font-semibold flex items-center gap-2" :class="collapsed ? '' : 'pl-2'">
          <i data-lucide="hard-drive" class="w-6 h-6 text-primary"></i>
          <span x-show="!collapsed" x-transition>My Files</span>
        </h2>
        <div class="dropdown dropdown-end" x-data="filePreferences()" x-show="!collapsed" x-transition>
          <button
            type="button"
            tabindex="0"
            class="btn btn-ghost btn-sm btn-square mr-1 hover:text-primary"
            aria-label="Settings"
            title="Settings"
          >
            <i data-lucide="settings" class="w-4 h-4"></i>
          </button>
          <div tabindex="0" class="dropdown-content z-50 bg-base-100 rounded-box shadow-lg ring-1 ring-base-300 p-4 w-64 mt-1">
            <h4 class="font-semibold text-sm mb-3 flex items-center gap-2">
              <i data-lucide="settings" class="w-4 h-4 text-primary"></i>
              Preferences
            </h4>
            <div class="space-y-3">
              <!-- Show hidden files -->
              <label class="flex items-center justify-between gap-2 cursor-pointer">
                <span class="text-sm">Show hidden files</span>
                <input type="checkbox" class="toggle toggle-sm toggle-primary"
                  :checked="prefs.showHiddenFiles"
                  @change="update('showHiddenFiles', $event.target.checked)">
              </label>
              <!-- Confirm before delete -->
              <label class="flex items-center justify-between gap-2 cursor-pointer">
                <span class="text-sm">Confirm before delete</span>
                <input type="checkbox" class="toggle toggle-sm toggle-primary"
                  :checked="prefs.confirmBeforeDelete"
                  @change="update('confirmBeforeDelete', $event.target.checked)">
              </label>
              <hr class="border-base-300">
              <!-- Default sort -->
              <div>
                <label class="text-sm text-base-content/60 block mb-1">Default sort</label>
                <select class="select select-bordered select-sm w-full"
                  :value="prefs.defaultSort"
                  @change="update('defaultSort', $event.target.value)">
                  <option value="default">Default</option>
                  <option value="name">Name</option>
                  <option value="modified">Modified</option>
                  <option value="created">Created</option>
                  <option value="size">Size</option>
                  <option value="type">Type</option>
                </select>
              </div>
              <hr class="border-base-300">
              <!-- Breadcrumb collapse threshold -->
              <div>
                <label class="text-sm text-base-content/60 block mb-1">
                  Breadcrumb collapse after
                </label>
                <div class="flex items-center gap-2">
                  <input type="range" min="2" max="8" step="1"
                    class="range range-sm range-primary flex-1"
                    :value="prefs.breadcrumbCollapse"
                    @input="update('breadcrumbCollapse', parseInt($event.target.value))">
                  <span class="text-sm font-mono w-5 text-center" x-text="prefs.breadcrumbCollapse"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Access -->
    <div class="flex-1 overflow-y-auto py-4 px-3">
      <h3 class="text-sm font-semibold text-base-content/60 uppercase tracking-wider overflow-hidden transition-all duration-200"
          :class="collapsed ? 'max-h-0 mb-0 opacity-0' : 'max-h-6 mb-4 opacity-100'"
          :aria-hidden="collapsed">
        <span class="flex items-center gap-2">
          <i data-lucide="zap" class="w-3 h-3"></i>
          Quick Access
        </span>
      </h3>
      <ul class="space-y-2">
        {% include "ui/partials/drawer_item.html" with href="/files" icon="folder" label="All Files" color="primary" active=is_root_view active_binding="activeView === 'root'" onclick="setActiveView('root')" x_target="folder-browser" x_target_history="push" %}
        {% include "ui/partials/drawer_item.html" with href="/files?favorites=1" icon="star" label="Favorites" color="warning" active=is_favorites_view active_binding="activeView === 'favorites'" onclick="setActiveView('favorites')" x_target="folder-browser" x_target_history="push" %}
        {% include "ui/partials/drawer_item.html" with href="/files?recent=1" icon="clock" label="Recent" color="info" active=is_recent_view active_binding="activeView === 'recent'" onclick="setActiveView('recent')" x_target="folder-browser" x_target_history="push" %}
        {% include "ui/partials/drawer_item.html" with href="/files/trash" icon="trash-2" label="Trash" color="error" active=is_trash_view active_binding="activeView === 'trash'" onclick="setActiveView('trash')" x_target="folder-browser" x_target_history="push" %}
        {% include "ui/partials/drawer_item.html" with href="/files?shared=1" icon="share-2" label="Shared with me" color="secondary" active=is_shared_view active_binding="activeView === 'shared'" onclick="setActiveView('shared')" x_target="folder-browser" x_target_history="push" %}
      </ul>

      <!-- Pinned Folders -->
      <div id="pinned-folders-section" x-data="pinnedFoldersSection()">
        <hr class="my-3 border-base-300 transition-all duration-200"
            :class="collapsed ? 'opacity-0' : 'opacity-100'"
            x-show="!collapsed || pinnedCount > 0">
        <h3 class="text-sm font-semibold text-base-content/60 uppercase tracking-wider overflow-hidden transition-all duration-200"
            :class="collapsed ? 'max-h-0 mb-0 opacity-0' : 'max-h-6 mb-3 opacity-100'"
            :aria-hidden="collapsed"
            x-show="!collapsed || pinnedCount > 0">
          <span class="flex items-center gap-2">
            <i data-lucide="pin" class="w-3 h-3"></i>
            Pinned
          </span>
        </h3>
        <!-- Drop zone -->
        <div
          @dragover.prevent="onDragOver($event)"
          @dragenter.prevent="onDragEnter($event)"
          @dragleave="onDragLeave($event)"
          @drop.prevent="onDrop($event)"
          :class="dragOver ? 'bg-primary/10 ring-2 ring-primary/40 ring-inset rounded-lg scale-[1.02]' : ''"
          class="transition-all duration-200 -mx-1 px-1 py-2 min-h-[60px]"
        >
          <ul class="space-y-2" id="pinned-folders-list" x-target="pinned-folders-list">
            {% include 'files/ui/partials/pinned_folders.html' %}
          </ul>
          <!-- Drop hint when dragging -->
          <div x-show="dragOver" x-cloak x-transition
               class="text-xs text-primary font-medium text-center py-4 border-2 border-dashed border-primary/40 rounded-lg mt-2 bg-primary/5"
               :class="collapsed ? 'hidden' : ''">
            <i data-lucide="pin" class="w-4 h-4 inline-block mb-1"></i>
            <br>
            Drop to pin folder
          </div>
        </div>
      </div>
    </div>

    <!-- Help Button -->
    <div class="px-3 pb-2">
      <ul class="menu p-0">
        {% include "ui/partials/drawer_item.html" with icon="circle-help" label="Help" color="primary" onclick="document.getElementById('help-dialog').showModal()" tooltip="Help" %}
      </ul>
    </div>

    <!-- Toggle Button (Always at bottom) -->
    <div class="border-t border-base-300 py-4 px-3">
      <ul class="menu p-0" x-show="!isMobile()">
        {% include "ui/partials/drawer_item.html" with icon_binding="collapsed ? 'panel-left-open' : 'panel-left-close'" label="Collapse" color="primary" onclick="toggleCollapse()" title_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" aria_label_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" %}
      </ul>
    </div>
  </aside>
</div>
{% endblock %}

{% block content %}
<div x-data="fileBrowser()" class="h-full flex flex-col">
  <!-- Persistent nav links for Alpine AJAX navigation (outside #folder-browser so they survive replacements) -->
  <a id="folder-nav-push" class="hidden" x-target.push="folder-browser"></a>
  <a id="folder-nav-replace" class="hidden" x-target.replace="folder-browser"></a>
  <div class="flex-1 flex min-h-0">
    <!-- Folder browser (replaced on navigation) -->
    <div class="flex-1 flex flex-col min-w-0">
      {% partialdef folder-browser inline %}
      <div class="h-full flex flex-col" id="folder-browser" data-folder="{{ current_folder.uuid|default:'' }}" data-view-url="{{ current_view_url }}" data-parent-url="{{ parent_url|default:'' }}" x-init="$nextTick(() => { lucide.createIcons(); window.folderNav.onNavigate($el.dataset.viewUrl); window.dispatchEvent(new CustomEvent('folder-browser-replaced', { detail: { viewUrl: $el.dataset.viewUrl } })); })">

        <!-- Top Header Bar -->
        <div class="bg-base-100 border-b border-base-300 p-4 lg:p-6">
          <!-- Header with breadcrumb, title and actions on same line -->
          <div class="flex items-start gap-3">
            <!-- Left: Breadcrumb and Title -->
            <div class="flex-1 min-w-0">
              <!-- Breadcrumb row with action button aligned -->
              <div class="flex items-center justify-between gap-4 mb-1">
                <div class="flex items-center gap-2 min-w-0">
                  <div class="join" x-data="navButtons()">
                    <button type="button"
                      class="btn btn-ghost btn-sm btn-square join-item disabled:bg-transparent disabled:border-transparent transition-colors"
                      :class="canGoBack ? 'text-base-content' : 'text-base-content/20'"
                      title="Back (Alt+Left)" :disabled="!canGoBack" @click="window.folderNav.back()">
                      <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    </button>
                    <button type="button"
                      class="btn btn-ghost btn-sm btn-square join-item disabled:bg-transparent disabled:border-transparent transition-colors"
                      :class="canGoForward ? 'text-base-content' : 'text-base-content/20'"
                      title="Forward (Alt+Right)" :disabled="!canGoForward" @click="window.folderNav.forward()">
                      <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                    <button type="button"
                      class="btn btn-ghost btn-sm btn-square join-item disabled:bg-transparent disabled:border-transparent transition-colors"
                      :class="parentUrl ? 'text-base-content' : 'text-base-content/20'"
                      title="Up (Alt+Up)" :disabled="!parentUrl" @click="navigateUp()">
                      <i data-lucide="arrow-up" class="w-4 h-4"></i>
                    </button>
                    <button type="button" class="btn btn-ghost btn-sm btn-square join-item"
                      title="Sync & refresh" aria-label="Sync and refresh folder"
                      @click="syncAndRefreshFolderBrowser()">
                      <i data-lucide="rotate-cw" class="w-4 h-4"></i>
                    </button>
                  </div>
                  {% include 'ui/partials/breadcrumbs.html' with breadcrumbs=breadcrumbs collapse=True collapse_after=breadcrumb_collapse x_target="folder-browser" x_target_history="push" %}
                  <a
                    href="{{ current_view_url }}"
                    class="hidden"
                    x-target="folder-browser"
                    data-refresh-folder-browser
                  ></a>
                </div>

                {% if is_trash_view %}
                <div class="flex-shrink-0">
                  <button type="button" class="btn btn-error btn-sm gap-2" @click="confirmCleanTrash()" :disabled="cleaningTrash">
                    <span x-show="cleaningTrash" class="loading loading-spinner loading-xs"></span>
                    <i x-show="!cleaningTrash" data-lucide="trash-2" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Empty trash</span>
                  </button>
                </div>
                {% elif not is_shared_view and not is_recent_view %}
                <!-- Action button with dropdown -->
                <div class="dropdown dropdown-end flex-shrink-0">
                  <button tabindex="0" class="btn btn-primary btn-sm gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">New</span>
                    <i data-lucide="chevron-down" class="w-3 h-3 hidden sm:inline opacity-70"></i>
                  </button>
                  {% include 'files/ui/partials/new_menu.html' %}
                </div>
                {% endif %}
              </div>

              <!-- Title below breadcrumb -->
              <h1 class="text-2xl font-bold text-base-content">{{ page_title }}</h1>
            </div>
          </div>
        </div>

        <!-- Main Content Area with Table -->
        <div class="flex-1 overflow-hidden flex flex-col bg-base-200/30 relative"
             @dragenter="onFileDragEnter($event)"
             @dragover="onFileDragOver($event)"
             @dragleave="onFileDragLeave($event)"
             @drop.prevent="onFileDrop($event)">
          <!-- Drop zone overlay -->
          <div x-show="dropZoneActive" x-cloak x-transition.opacity
               class="absolute inset-0 z-50 bg-base-100/90 backdrop-blur-sm border-2 border-dashed border-primary rounded-lg flex items-center justify-center pointer-events-none">
            <div class="text-center">
              <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto mb-3 text-primary"></i>
              <p class="text-lg font-semibold text-primary">Drop files to upload</p>
              <p class="text-sm text-base-content/60">Files will be added to the current folder</p>
            </div>
          </div>
          {% include 'files/ui/partials/folder_content.html' with nodes=nodes folder_stats=folder_stats empty_title=empty_title empty_message=empty_message %}
        </div>
      </div>
      {% endpartialdef %}
    </div>

    <!-- Properties sidebar -->
    <div x-show="showPropertiesPanel" x-cloak
         x-transition:enter="transition-[width] ease-out duration-200"
         x-transition:enter-start="!w-0"
         x-transition:enter-end="!w-80"
         x-transition:leave="transition-[width] ease-in duration-150"
         x-transition:leave-start="!w-80"
         x-transition:leave-end="!w-0"
         class="w-80 border-l border-base-300 bg-base-100 flex flex-col overflow-hidden">
      <div class="w-80 flex-1 overflow-y-auto">
        {% include "files/ui/partials/properties_panel.html" %}
      </div>
    </div>
  </div>
</div>

{% include 'files/ui/partials/dialogs.html' %}
{% include 'files/ui/partials/file_viewer_modal.html' %}
{% include 'files/ui/partials/context_menu.html' %}
{% include 'files/ui/partials/share_modal.html' %}
{% endblock %}

{% block extra_scripts %}
<!-- Monaco Editor for text/code viewing and editing -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

<!-- File locking (must load before viewers) -->
<script src="{% static 'files/ui/js/file_lock.js' %}"></script>

<!-- File browser -->
<script src="{% static 'files/ui/js/file_browser.js' %}"></script>

{% endblock %}
