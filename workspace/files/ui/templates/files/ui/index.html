{% extends 'base_with_navbar.html' %}
{% load file_filters static %}

{% block title %}Files - Workspace{% endblock %}

{% block drawer_class %}lg:drawer-open{% endblock %}
{% block drawer_id %}files-drawer{% endblock %}

{% block main_class %}p-0 flex flex-col h-full overflow-hidden{% endblock %}

{% block drawer_sidebar %}
<div class="drawer-side z-40 h-full">
  <label for="files-drawer" aria-label="close sidebar" class="drawer-overlay"></label>

  <!-- Sidebar -->
  <aside class="bg-base-200 w-72 h-full border-r border-base-300 flex flex-col">
    <!-- Sidebar header -->
    <div class="p-4 border-b border-base-300">
      <h2 class="text-lg font-semibold flex items-center gap-2">
        <i data-lucide="hard-drive" class="w-5 h-5"></i>
        My Files
      </h2>
    </div>

    <!-- Quick Access -->
    <div class="flex-1 overflow-y-auto p-4">
      <h3 class="text-xs font-semibold text-base-content/60 uppercase tracking-wider mb-3">Quick Access</h3>
      <ul class="menu menu-sm p-0 gap-1">
        <li>
          <a href="/files" class="{% if not current_folder %}active{% endif %} gap-3" x-target.push="folder-browser">
            <i data-lucide="folder" class="w-4 h-4"></i>
            All Files
          </a>
        </li>
        <li class="disabled">
          <span class="gap-3 opacity-50 cursor-not-allowed">
            <i data-lucide="clock" class="w-4 h-4"></i>
            Recent
            <span class="badge badge-xs">Soon</span>
          </span>
        </li>
        <li class="disabled">
          <span class="gap-3 opacity-50 cursor-not-allowed">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
            Trash
            <span class="badge badge-xs">Soon</span>
          </span>
        </li>
      </ul>
    </div>

    <!-- Storage Stats (Always at bottom) -->
    <div class="p-4 border-t border-base-300 bg-base-100/50 mt-auto">
      <h3 class="text-xs font-semibold text-base-content/60 uppercase tracking-wider mb-3">Storage</h3>
      <div class="space-y-2">
        <div class="flex justify-between text-sm">
          <span class="text-base-content/70">Used</span>
          <span class="font-medium">{{ storage_stats.total_size|filesize }}</span>
        </div>
        <div class="flex gap-4 text-xs text-base-content/60">
          <span>{{ storage_stats.file_count }} file{{ storage_stats.file_count|pluralize }}</span>
          <span>{{ storage_stats.folder_count }} folder{{ storage_stats.folder_count|pluralize }}</span>
        </div>
      </div>
    </div>
  </aside>
</div>
{% endblock %}

{% block content %}
<div x-data="fileBrowser()" class="h-full flex flex-col">
  {% partialdef folder-browser inline %}
  <div class="h-full flex flex-col" id="folder-browser" data-folder="{{ current_folder.uuid|default:'' }}" x-init="$nextTick(() => lucide.createIcons())">

    <!-- Top Header Bar -->
    <div class="bg-base-100 border-b border-base-300 p-4 lg:p-6">
      <!-- Header with breadcrumb, title and actions on same line -->
      <div class="flex items-start gap-3">
        <!-- Mobile drawer toggle -->
        <label for="files-drawer" class="btn btn-square btn-ghost drawer-button lg:hidden flex-shrink-0 -ml-2">
          <i data-lucide="panel-left" class="w-5 h-5"></i>
        </label>

        <!-- Left: Breadcrumb and Title -->
        <div class="flex-1 min-w-0">
          <!-- Breadcrumb row with action button aligned -->
          <div class="flex items-center justify-between gap-4 mb-1">
            {% include 'ui/partials/breadcrumbs.html' with breadcrumbs=breadcrumbs x_target="folder-browser" x_target_history="push" %}

            <!-- Action button with dropdown -->
            <div class="dropdown dropdown-end flex-shrink-0">
              <button tabindex="0" class="btn btn-primary btn-sm gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i>
                <span class="hidden sm:inline">New</span>
                <i data-lucide="chevron-down" class="w-3 h-3 hidden sm:inline opacity-70"></i>
              </button>
              {% include 'files/ui/partials/new_menu.html' %}
            </div>
          </div>

          <!-- Title below breadcrumb -->
          <h1 class="text-2xl font-bold text-base-content">
            {% if current_folder %}{{ current_folder.name }}{% else %}All Files{% endif %}
          </h1>
        </div>
      </div>
    </div>

    <!-- Alerts container -->
    <div x-ref="alertsContainer" class="px-4 lg:px-6"></div>

    <!-- Main Content Area with Table -->
    <div class="flex-1 overflow-hidden flex flex-col bg-base-200/30">
      {% include 'files/ui/partials/folder_content.html' with nodes=nodes folder_stats=folder_stats %}
    </div>
  </div>
  {% endpartialdef %}
</div>

{% include 'files/ui/partials/dialogs.html' %}
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'files/ui/js/file_browser.js' %}"></script>
{% endblock %}
