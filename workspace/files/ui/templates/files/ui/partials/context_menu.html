<!-- Context Menu Component -->
<div
  x-data="contextMenu()"
  x-show="isOpen"
  x-cloak
  @click.outside="close()"
  @keydown.escape.window="close()"
  class="fixed z-[100] shadow-xl bg-base-100 border border-base-300 rounded-lg w-64 p-1"
  :style="`top: ${position.y}px; left: ${position.x}px;`"
>
  <!-- Background menu (right-click on empty area) -->
  <template x-if="isBackgroundMenu">
    <ul class="menu menu-sm p-0">
      <!-- Create folder -->
      <li>
        <button
          type="button"
          class="gap-3 rounded"
          @click="createFolder()"
        >
          <i data-lucide="folder-plus" class="w-4 h-4"></i>
          <span>New folder</span>
        </button>
      </li>

      <!-- Create file -->
      <li>
        <button
          type="button"
          class="gap-3 rounded"
          @click="createFile()"
        >
          <i data-lucide="file-text" class="w-4 h-4"></i>
          <span>New file</span>
        </button>
      </li>

      <!-- Upload -->
      <li>
        <button
          type="button"
          class="gap-3 rounded"
          @click="uploadFiles()"
        >
          <i data-lucide="file-plus" class="w-4 h-4"></i>
          <span>Upload files</span>
        </button>
      </li>

      <!-- Paste (only show when clipboard has items) -->
      <template x-if="hasClipboardItems">
        <hr class="my-1 border-base-300" />
      </template>
      <template x-if="hasClipboardItems">
        <li>
          <button
            type="button"
            class="gap-3 rounded"
            @click="pasteHere()"
          >
            <i data-lucide="clipboard-paste" class="w-4 h-4"></i>
            <span>Paste</span>
            <kbd class="kbd kbd-xs ml-auto">Ctrl+V</kbd>
          </button>
        </li>
      </template>
    </ul>
  </template>

  <!-- Node menu (right-click on file/folder) -->
  <template x-if="nodeData && !isBackgroundMenu">
    <ul class="menu menu-sm p-0">
      <!-- View in browser (files only, if viewable) -->
      <template x-if="nodeData.nodeType === 'file' && nodeData.isViewable && !nodeData.isTrash">
        <li>
          <button
            type="button"
            class="gap-3 rounded"
            @click="viewFile()"
          >
            <i data-lucide="eye" class="w-4 h-4"></i>
            <span>View in browser</span>
            <kbd class="kbd kbd-xs ml-auto">Enter/Space</kbd>
          </button>
        </li>
      </template>

      <!-- Open folder (folders only) -->
      <template x-if="nodeData.nodeType === 'folder' && !nodeData.isTrash">
        <li>
          <button
            type="button"
            class="gap-3 rounded"
            @click="openFolder()"
          >
            <i data-lucide="folder-open" class="w-4 h-4"></i>
            <span>Open</span>
            <kbd class="kbd kbd-xs ml-auto">Enter/Space</kbd>
          </button>
        </li>
      </template>

      <!-- Open in new tab (files only) -->
      <template x-if="nodeData.nodeType === 'file' && !nodeData.isTrash">
        <li>
          <a :href="`/api/v1/files/${nodeData.uuid}/content`" target="_blank" class="gap-3 rounded">
            <i data-lucide="external-link" class="w-4 h-4"></i>
            <span>Open in new tab</span>
          </a>
        </li>
      </template>

      <!-- Download (files only) -->
      <template x-if="nodeData.nodeType === 'file' && !nodeData.isTrash">
        <li>
          <a :href="`/api/v1/files/${nodeData.uuid}/content`" download :download="nodeData.name" class="gap-3 rounded">
            <i data-lucide="download" class="w-4 h-4"></i>
            <span>Download</span>
          </a>
        </li>
      </template>

      <!-- Copy link (files only) -->
      <template x-if="nodeData.nodeType === 'file' && !nodeData.isTrash">
        <li>
          <button
            type="button"
            class="gap-3 rounded"
            @click="copyLink()"
          >
            <i data-lucide="link" class="w-4 h-4"></i>
            <span>Copy link</span>
          </button>
        </li>
      </template>

      <template x-if="!nodeData.isTrash">
        <hr class="my-1 border-base-300" />
      </template>

      <!-- Favorite/Unfavorite -->
      <template x-if="!nodeData.isTrash">
        <li>
          <button
            type="button"
            class="gap-3 rounded"
            @click="toggleFavorite()"
          >
            <i data-lucide="star" class="w-4 h-4" :class="nodeData.isFavorite ? 'text-warning fill-current' : ''"></i>
            <span x-text="nodeData.isFavorite ? 'Remove from favorites' : 'Add to favorites'"></span>
            <kbd class="kbd kbd-xs ml-auto">F</kbd>
          </button>
        </li>
      </template>

      <!-- Pin/Unpin to sidebar (folders only) -->
      <template x-if="nodeData.nodeType === 'folder' && !nodeData.isTrash">
        <li>
          <button
            type="button"
            class="gap-3 rounded"
            @click="togglePin()"
          >
            <i data-lucide="pin" class="w-4 h-4" :class="nodeData.isPinned ? 'text-primary fill-current' : ''"></i>
            <span x-text="nodeData.isPinned ? 'Unpin from sidebar' : 'Pin to sidebar'"></span>
            <kbd class="kbd kbd-xs ml-auto">P</kbd>
          </button>
        </li>
      </template>

      <!-- Rename -->
      <template x-if="!nodeData.isTrash">
        <li>
          <button
            type="button"
            class="gap-3 rounded"
            @click="rename()"
          >
            <i data-lucide="pencil" class="w-4 h-4"></i>
            <span>Rename</span>
            <kbd class="kbd kbd-xs ml-auto">F2</kbd>
          </button>
        </li>
      </template>

      <!-- Cut -->
      <template x-if="!nodeData.isTrash">
        <li>
          <button
            type="button"
            class="gap-3 rounded"
            @click="cut()"
          >
            <i data-lucide="scissors" class="w-4 h-4"></i>
            <span>Cut</span>
            <kbd class="kbd kbd-xs ml-auto">Ctrl+X</kbd>
          </button>
        </li>
      </template>

      <!-- Copy -->
      <template x-if="!nodeData.isTrash">
        <li>
          <button
            type="button"
            class="gap-3 rounded"
            @click="copy()"
          >
            <i data-lucide="copy" class="w-4 h-4"></i>
            <span>Copy</span>
            <kbd class="kbd kbd-xs ml-auto">Ctrl+C</kbd>
          </button>
        </li>
      </template>

      <!-- Paste (only show when clipboard has items) -->
      <template x-if="!nodeData.isTrash && nodeData.nodeType === 'folder' && hasClipboardItems">
        <li>
          <button
            type="button"
            class="gap-3 rounded"
            @click="paste()"
          >
            <i data-lucide="clipboard-paste" class="w-4 h-4"></i>
            <span>Paste here</span>
            <kbd class="kbd kbd-xs ml-auto">Ctrl+V</kbd>
          </button>
        </li>
      </template>

      <!-- Info/Properties -->
      <template x-if="!nodeData.isTrash">
        <li>
          <button
            type="button"
            class="gap-3 rounded"
            @click="showInfo()"
          >
            <i data-lucide="info" class="w-4 h-4"></i>
            <span>Properties</span>
            <kbd class="kbd kbd-xs ml-auto">Ctrl+I</kbd>
          </button>
        </li>
      </template>

      <hr class="my-1 border-base-300" />

      <!-- Trash actions -->
      <template x-if="nodeData.isTrash">
        <li>
          <button
            type="button"
            class="gap-3 rounded"
            @click="restore()"
          >
            <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
            <span>Restore</span>
          </button>
        </li>
        <li>
          <button
            type="button"
            class="gap-3 rounded text-error"
            @click="purge()"
          >
            <i data-lucide="trash-2" class="w-4 h-4"></i>
            <span>Delete permanently</span>
          </button>
        </li>
      </template>

      <!-- Delete (normal view) -->
      <template x-if="!nodeData.isTrash">
        <li>
          <button
            type="button"
            class="gap-3 rounded text-error"
            @click="deleteNode()"
          >
            <i data-lucide="trash-2" class="w-4 h-4"></i>
            <span>Delete</span>
            <kbd class="kbd kbd-xs ml-auto">Del</kbd>
          </button>
        </li>
      </template>
    </ul>
  </template>
</div>

<script>
function contextMenu() {
  return {
    isOpen: false,
    position: { x: 0, y: 0 },
    nodeData: null,
    isBackgroundMenu: false,
    hasClipboardItems: false,

    init() {
      // Listen for context menu events (on files/folders)
      window.addEventListener('open-context-menu', (e) => {
        this.open(e.detail.event, e.detail.nodeData);
      });

      // Listen for background context menu events (on empty area)
      window.addEventListener('open-background-context-menu', (e) => {
        this.openBackground(e.detail.event);
      });

      // Listen for clipboard changes
      window.addEventListener('clipboard-changed', () => {
        this.hasClipboardItems = window.fileClipboard.hasItems();
      });

      // Initialize clipboard state
      this.hasClipboardItems = window.fileClipboard.hasItems();
    },

    open(event, nodeData) {
      event.preventDefault();

      // Update node data first
      this.nodeData = nodeData;
      this.isBackgroundMenu = false;

      // If already open, just update position and return
      if (this.isOpen) {
        this.updatePosition(event);
        return;
      }

      this.isOpen = true;

      // Calculate position to avoid overflow
      this.$nextTick(() => {
        this.updatePosition(event);
      });
    },

    openBackground(event) {
      event.preventDefault();

      this.nodeData = null;
      this.isBackgroundMenu = true;

      if (this.isOpen) {
        this.updatePosition(event);
        return;
      }

      this.isOpen = true;

      this.$nextTick(() => {
        this.updatePosition(event);
      });
    },

    updatePosition(event) {
      const menu = this.$el;
      const menuRect = menu.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;

      let x = event.clientX;
      let y = event.clientY;

      // Adjust if menu would overflow right edge
      if (x + menuRect.width > viewportWidth) {
        x = viewportWidth - menuRect.width - 10;
      }

      // Adjust if menu would overflow bottom edge
      if (y + menuRect.height > viewportHeight) {
        y = viewportHeight - menuRect.height - 10;
      }

      this.position = { x, y };

      // Reinitialize Lucide icons
      if (typeof lucide !== 'undefined') {
        this.$nextTick(() => lucide.createIcons());
      }
    },

    close() {
      this.isOpen = false;
      this.nodeData = null;
    },

    viewFile() {
      window.dispatchEvent(new CustomEvent('open-file-viewer', {
        detail: {
          uuid: this.nodeData.uuid,
          name: this.nodeData.name,
          mime_type: this.nodeData.mimeType
        }
      }));
      this.close();
    },

    openFolder() {
      const link = document.querySelector(`a[href="/files/${this.nodeData.uuid}"]`);
      if (link) {
        link.click();
      }
      this.close();
    },

    toggleFavorite() {
      // Dispatch event for file browser to handle
      window.dispatchEvent(new CustomEvent('file-action', {
        detail: {
          action: 'toggleFavorite',
          uuid: this.nodeData.uuid,
          isFavorite: this.nodeData.isFavorite
        }
      }));
      this.close();
    },

    togglePin() {
      window.dispatchEvent(new CustomEvent('file-action', {
        detail: {
          action: 'togglePin',
          uuid: this.nodeData.uuid,
          isPinned: this.nodeData.isPinned
        }
      }));
      this.close();
    },

    rename() {
      // Dispatch event for file browser to handle
      window.dispatchEvent(new CustomEvent('file-action', {
        detail: {
          action: 'rename',
          uuid: this.nodeData.uuid,
          name: this.nodeData.name
        }
      }));
      this.close();
    },

    deleteNode() {
      // Dispatch event for file browser to handle
      window.dispatchEvent(new CustomEvent('file-action', {
        detail: {
          action: 'delete',
          uuid: this.nodeData.uuid,
          name: this.nodeData.name,
          nodeType: this.nodeData.nodeType
        }
      }));
      this.close();
    },

    restore() {
      // Dispatch event for file browser to handle
      window.dispatchEvent(new CustomEvent('file-action', {
        detail: {
          action: 'restore',
          uuid: this.nodeData.uuid,
          name: this.nodeData.name,
          nodeType: this.nodeData.nodeType
        }
      }));
      this.close();
    },

    purge() {
      // Dispatch event for file browser to handle
      window.dispatchEvent(new CustomEvent('file-action', {
        detail: {
          action: 'purge',
          uuid: this.nodeData.uuid,
          name: this.nodeData.name,
          nodeType: this.nodeData.nodeType
        }
      }));
      this.close();
    },

    copyLink() {
      const url = new URL(window.location.origin + window.location.pathname);
      url.searchParams.set('open', this.nodeData.uuid);

      navigator.clipboard.writeText(url.toString()).then(() => {
        // Show success toast using AppAlert
        if (window.AppAlert) {
          window.AppAlert.success('Link copied to clipboard', {
            duration: 2000
          });
        }
      }).catch(err => {
        console.error('Failed to copy link:', err);
        if (window.AppAlert) {
          window.AppAlert.error('Failed to copy link');
        }
      });

      this.close();
    },

    showInfo() {
      window.dispatchEvent(new CustomEvent('open-properties', {
        detail: {
          uuid: this.nodeData.uuid,
          nodeType: this.nodeData.nodeType
        }
      }));
      this.close();
    },

    cut() {
      window.dispatchEvent(new CustomEvent('file-action', {
        detail: {
          action: 'cut',
          uuid: this.nodeData.uuid,
          name: this.nodeData.name,
          nodeType: this.nodeData.nodeType
        }
      }));
      this.close();
    },

    copy() {
      window.dispatchEvent(new CustomEvent('file-action', {
        detail: {
          action: 'copy',
          uuid: this.nodeData.uuid,
          name: this.nodeData.name,
          nodeType: this.nodeData.nodeType
        }
      }));
      this.close();
    },

    paste() {
      window.dispatchEvent(new CustomEvent('file-action', {
        detail: {
          action: 'paste',
          uuid: this.nodeData.uuid
        }
      }));
      this.close();
    },

    // Background menu actions
    createFolder() {
      window.dispatchEvent(new CustomEvent('folder-action', {
        detail: { action: 'createFolder' }
      }));
      this.close();
    },

    createFile() {
      window.dispatchEvent(new CustomEvent('folder-action', {
        detail: { action: 'createFile' }
      }));
      this.close();
    },

    uploadFiles() {
      window.dispatchEvent(new CustomEvent('folder-action', {
        detail: { action: 'upload' }
      }));
      this.close();
    },

    pasteHere() {
      window.dispatchEvent(new CustomEvent('folder-action', {
        detail: { action: 'paste' }
      }));
      this.close();
    }
  };
}
</script>
