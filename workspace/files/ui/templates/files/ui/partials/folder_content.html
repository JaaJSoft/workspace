{% load file_filters %}
{% comment %}
  Folder content component - displays files and folders in a table

  Required context:
    - nodes: QuerySet of File objects to display

  Optional context:
    - show_actions: bool (default: True) - show row action buttons
    - empty_title: str - custom empty state title
    - empty_message: str - custom empty state message
{% endcomment %}

<div class="bg-base-100 shadow border border-base-300 flex flex-col h-full">
  <div class="card-body p-0 flex flex-col flex-1 ">
    <!-- Table container with overflow -->
    <div class="overflow-auto flex-1 min-h-0">
      {% if nodes %}
      <table class="table">
        <thead class="sticky top-0 z-10">
          <tr class="bg-base-200">
            <th class="w-12"></th>
            <th>Name</th>
            <th class="hidden sm:table-cell">Size</th>
            <th class="hidden md:table-cell">Modified</th>
            {% if show_actions != False %}
            <th class="w-16"></th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for node in nodes %}
          <tr class="hover group">
            <td class="text-base-content/60">
              {% if node.node_type == 'folder' %}
                <i data-lucide="folder" class="w-5 h-5 text-warning"></i>
              {% else %}
                {% with node.mime_type as mime %}
                  {% if 'image' in mime %}
                    <i data-lucide="image" class="w-5 h-5 text-success"></i>
                  {% elif 'video' in mime %}
                    <i data-lucide="video" class="w-5 h-5 text-error"></i>
                  {% elif 'audio' in mime %}
                    <i data-lucide="music" class="w-5 h-5 text-secondary"></i>
                  {% elif 'pdf' in mime %}
                    <i data-lucide="file-text" class="w-5 h-5 text-error"></i>
                  {% elif 'zip' in mime or 'rar' in mime or 'tar' in mime or 'gz' in mime %}
                    <i data-lucide="file-archive" class="w-5 h-5 text-warning"></i>
                  {% else %}
                    <i data-lucide="file" class="w-5 h-5"></i>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </td>
            <td>
              {% if node.node_type == 'folder' %}
                <a
                  href="/files/{{ node.uuid }}"
                  class="font-medium hover:text-primary hover:underline"
                  x-target.push="folder-browser"
                >
                  {{ node.name }}
                </a>
              {% else %}
                <span class="font-medium">{{ node.name }}</span>
              {% endif %}
            </td>
            <td class="hidden sm:table-cell text-sm text-base-content/70">
              {% if node.node_type == 'file' %}
                {{ node.size|filesize }}
              {% else %}
                -
              {% endif %}
            </td>
            <td class="hidden md:table-cell text-sm text-base-content/70">
              {{ node.updated_at|date:"M j, Y" }}
            </td>
            {% if show_actions != False %}
            <td>
              <div class="dropdown dropdown-end">
                <label
                  tabindex="0"
                  class="btn btn-ghost btn-xs btn-circle opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity"
                >
                  <i data-lucide="more-vertical" class="w-4 h-4"></i>
                </label>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-100 border border-base-300 rounded-box w-40">
                  {% if node.node_type == 'file' and node.content %}
                  <li>
                    <a href="{{ node.content.url }}" target="_blank" class="gap-2">
                      <i data-lucide="eye" class="w-4 h-4"></i>View
                    </a>
                  </li>
                  <li>
                    <a href="{{ node.content.url }}" download class="gap-2">
                      <i data-lucide="download" class="w-4 h-4"></i>Download
                    </a>
                  </li>
                  {% endif %}
                  <li>
                    <button
                      type="button"
                      class="gap-2"
                      @click="showRenameDialog('{{ node.uuid }}', '{{ node.name|escapejs }}')"
                    >
                      <i data-lucide="pencil" class="w-4 h-4"></i>Rename
                    </button>
                  </li>
                  <li>
                    <button
                      type="button"
                      class="gap-2 text-error"
                      @click="confirmDelete('{{ node.uuid }}', '{{ node.name|escapejs }}', '{{ node.node_type }}')"
                    >
                      <i data-lucide="trash-2" class="w-4 h-4"></i>Delete
                    </button>
                  </li>
                </ul>
              </div>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="flex h-full items-center justify-center text-base-content/60">
        <div class="text-center">
          <i data-lucide="folder-open" class="w-12 h-12 mb-4 opacity-40 mx-auto"></i>
          <p class="text-lg font-medium mb-1">{{ empty_title|default:"This folder is empty" }}</p>
          <p class="text-sm">{{ empty_message|default:"Create a folder or upload files to get started." }}</p>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Status bar - Always visible at bottom -->
    <div class="flex-shrink-0 px-4 py-2 border-t border-base-300 bg-base-200/50 text-xs text-base-content/60">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div class="flex items-center gap-4 flex-wrap">
          {% if nodes %}
            <!-- Total items -->
            <span class="flex items-center gap-1">
              <i data-lucide="layers" class="w-3 h-3"></i>
              <span>{{ nodes|length }} item{{ nodes|length|pluralize }}</span>
            </span>

            <!-- Folders count -->
            {% if folder_stats.folder_count > 0 %}
            <span class="flex items-center gap-1">
              <i data-lucide="folder" class="w-3 h-3"></i>
              <span>{{ folder_stats.folder_count }} folder{{ folder_stats.folder_count|pluralize }}</span>
            </span>
            {% endif %}

            <!-- Files count -->
            {% if folder_stats.file_count > 0 %}
            <span class="flex items-center gap-1">
              <i data-lucide="file" class="w-3 h-3"></i>
              <span>{{ folder_stats.file_count }} file{{ folder_stats.file_count|pluralize }}</span>
            </span>
            {% endif %}
          {% else %}
            <span class="flex items-center gap-1">
              <i data-lucide="folder-open" class="w-3 h-3"></i>
              <span>Empty folder</span>
            </span>
          {% endif %}
        </div>

        <!-- Total size -->
        {% if folder_stats.total_size > 0 %}
        <div class="flex items-center gap-1">
          <i data-lucide="hard-drive" class="w-3 h-3"></i>
          <span>{{ folder_stats.total_size|filesize }}</span>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
