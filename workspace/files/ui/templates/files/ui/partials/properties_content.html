{% load file_filters %}
{% comment %}
Properties Content Partial
==========================
Loaded via AJAX into the properties panel.

Context:
- file: File object
- is_favorite: boolean
- is_pinned: boolean (for folders)
- children_count: int (for folders)
- total_size: int (for folders, recursive size)
{% endcomment %}

<div class="p-4 space-y-5" x-data="folderIconPicker('{{ file.uuid }}', '{{ file.icon|default:"folder" }}', '{{ file.color|default:"text-warning" }}')">
  <!-- Icon + Name (centered, like chat avatar) -->
  <div class="flex flex-col items-center text-center gap-2">
    <div class="w-14 h-14 flex items-center justify-center bg-base-200 rounded-xl mb-1" x-ref="previewIcon" {% if file.node_type == 'folder' %}x-init="$nextTick(() => updatePreviewIcon())"{% endif %}>
      {% if file.node_type != 'folder' %}
        <i data-lucide="{{ file.mime_type|mime_to_lucide }}" class="w-8 h-8 {{ file.mime_type|mime_to_color }}"></i>
      {% endif %}
    </div>
    <h3 class="font-bold text-base break-all">{{ file.name }}</h3>
    <div class="flex flex-wrap justify-center gap-1.5">
      <span class="badge badge-sm badge-ghost">
        {% if file.node_type == 'folder' %}Folder{% else %}File{% endif %}
      </span>
      {% if is_favorite %}
      <span class="badge badge-sm badge-warning gap-1">
        <i data-lucide="star" class="w-3 h-3 fill-current"></i>
        Favorite
      </span>
      {% endif %}
      {% if is_pinned %}
      <span class="badge badge-sm badge-primary gap-1">
        <i data-lucide="pin" class="w-3 h-3 fill-current"></i>
        Pinned
      </span>
      {% endif %}
      {% if file.deleted_at %}
      <span class="badge badge-sm badge-error gap-1">
        <i data-lucide="trash-2" class="w-3 h-3"></i>
        In Trash
      </span>
      {% endif %}
    </div>
  </div>

  <!-- Details -->
  <div class="space-y-2 text-sm">
    <div class="flex items-center gap-2 text-base-content/60">
      <i data-lucide="map-pin" class="w-3.5 h-3.5 flex-shrink-0"></i>
      <span class="font-mono text-xs truncate">/{{ file.path }}</span>
    </div>
    {% if file.node_type == 'file' %}
    <div class="flex items-center gap-2 text-base-content/60">
      <i data-lucide="hard-drive" class="w-3.5 h-3.5 flex-shrink-0"></i>
      <span>{{ file.size|filesizeformat }}</span>
    </div>
    <div class="flex items-center gap-2 text-base-content/60">
      <i data-lucide="file-type" class="w-3.5 h-3.5 flex-shrink-0"></i>
      <span class="font-mono text-xs">{{ file.mime_type|default:"-" }}</span>
    </div>
    {% endif %}
    {% if file.node_type == 'folder' %}
    <div class="flex items-center gap-2 text-base-content/60">
      <i data-lucide="layers" class="w-3.5 h-3.5 flex-shrink-0"></i>
      <span>
        {{ children_count }} item{{ children_count|pluralize }}
        {% if total_size %}
          <span class="text-base-content/40">({{ total_size|filesizeformat }})</span>
        {% endif %}
      </span>
    </div>
    {% endif %}
    <div class="flex items-center gap-2 text-base-content/60">
      <i data-lucide="calendar" class="w-3.5 h-3.5 flex-shrink-0"></i>
      <span>Created {{ file.created_at|date:"N j, Y" }}</span>
    </div>
    <div class="flex items-center gap-2 text-base-content/60">
      <i data-lucide="clock" class="w-3.5 h-3.5 flex-shrink-0"></i>
      <span>Modified {{ file.updated_at|date:"N j, Y" }}</span>
    </div>
    <div class="flex items-center gap-2 text-base-content/60">
      <div class="flex-shrink-0">{% include "ui/partials/user_avatar.html" with user=file.owner size="2xs" %}</div>
      <span class="text-sm">{{ file.owner.username }}</span>
    </div>
  </div>

  {% if file.node_type == 'folder' and is_owner %}
  <!-- Customize Icon -->
  <div class="divider my-0 text-xs text-base-content/40">Customize Icon</div>

  <div class="space-y-3">
    <!-- Icon Selection -->
    <div>
      <label class="text-xs text-base-content/60 mb-1.5 block">Icon</label>
      <div class="flex flex-wrap gap-1" x-ref="iconGrid" x-init="setTimeout(() => lucide.createIcons({nodes: $refs.iconGrid.querySelectorAll('[data-lucide]')}), 50)">
        <template x-for="icon in icons" :key="icon">
          <button
            type="button"
            class="btn btn-xs btn-square"
            :class="selectedIcon === icon ? 'btn-primary' : 'btn-ghost'"
            @click="selectIcon(icon)"
            :title="icon"
          >
            <i :data-lucide="icon" class="w-3.5 h-3.5 pointer-events-none"></i>
          </button>
        </template>
      </div>
    </div>

    <!-- Color Selection -->
    <div>
      <label class="text-xs text-base-content/60 mb-1.5 block">Color</label>
      <div class="flex flex-wrap gap-1" x-ref="colorGrid" x-init="setTimeout(() => lucide.createIcons({nodes: $refs.colorGrid.querySelectorAll('[data-lucide]')}), 50)">
        <template x-for="color in colors" :key="color.class">
          <button
            type="button"
            class="btn btn-xs btn-square btn-ghost"
            :class="selectedColor === color.class ? 'ring-2 ring-primary ring-offset-1' : ''"
            @click="selectColor(color.class)"
            :title="color.name"
          >
            <i data-lucide="circle" class="w-3.5 h-3.5 fill-current pointer-events-none" :class="color.class"></i>
          </button>
        </template>
      </div>
    </div>

    <!-- Save indicator -->
    <div x-show="saving" class="text-xs text-base-content/60 flex items-center gap-1">
      <span class="loading loading-spinner loading-xs"></span>
      Saving...
    </div>
    <div x-show="saved" x-transition class="text-xs text-success flex items-center gap-1">
      <i data-lucide="check" class="w-3 h-3"></i>
      Saved
    </div>
  </div>
  {% endif %}

  {% if file.node_type == 'file' %}
  <!-- Sharing -->
  <div class="divider my-0 text-xs text-base-content/40">
    Sharing
    {% if is_owner and shares %}
      <span class="badge badge-ghost badge-xs">{{ shares|length }}</span>
    {% endif %}
  </div>

  <div class="space-y-2">
    {% if is_owner %}
      <button
        type="button"
        class="btn btn-ghost btn-xs gap-1"
        onclick="window.dispatchEvent(new CustomEvent('open-share-modal', { detail: { uuid: '{{ file.uuid }}', name: '{{ file.name|escapejs }}' } }))"
      >
        <i data-lucide="settings" class="w-3 h-3"></i>
        Manage sharing
      </button>
      {% if shares %}
      <ul class="space-y-1">
        {% for share in shares %}
        <li class="flex items-center gap-2.5 px-2 py-1.5 rounded-lg hover:bg-base-200 transition-colors">
          <div class="flex-shrink-0">{% include "ui/partials/user_avatar.html" with user=share.shared_with size="xs" %}</div>
          <div class="flex-1 min-w-0">
            <span class="text-sm font-medium truncate block">{{ share.shared_with.username }}</span>
          </div>
          <span class="badge badge-xs {% if share.permission == 'rw' %}badge-primary{% else %}badge-ghost{% endif %}">
            {% if share.permission == 'rw' %}rw{% else %}r{% endif %}
          </span>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-sm text-base-content/40">Not shared with anyone</p>
      {% endif %}
    {% else %}
      <div class="flex items-center gap-2 text-sm">
        <span class="text-base-content/60">Your access</span>
        <span class="badge badge-sm {% if share_permission == 'rw' %}badge-primary{% else %}badge-ghost{% endif %}">
          {% if share_permission == 'rw' %}Read & write{% else %}Read only{% endif %}
        </span>
      </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Comments -->
  <div class="divider my-0 text-xs text-base-content/40">
    Comments
  </div>

  <div class="space-y-3" x-data="fileComments('{{ file.uuid }}', {{ request.user.id }})">
    <!-- Loading -->
    <div x-show="loading" class="flex justify-center py-4">
      <span class="loading loading-spinner loading-sm"></span>
    </div>

    <!-- Comment list -->
    <div x-show="!loading" x-ref="commentsList" class="space-y-3">
      <template x-if="comments.length === 0 && !loading">
        <p class="text-sm text-base-content/40">No comments yet.</p>
      </template>

      <template x-for="comment in comments" :key="comment.uuid">
        <div class="flex gap-2">
          <!-- Avatar -->
          <div class="flex-shrink-0" x-html="userAvatarHtml(comment.author.id, comment.author.username, 'w-7 h-7 text-xs')"></div>
          <div class="flex-1 min-w-0">
            <!-- Header -->
            <div class="flex items-center gap-2 text-xs">
              <span class="font-medium" x-text="comment.author.username"></span>
              <span class="text-base-content/50" x-text="formatDate(comment.created_at)"></span>
              <template x-if="comment.edited_at">
                <span class="text-base-content/40 italic">(edited)</span>
              </template>
            </div>

            <!-- Body or Edit form -->
            <template x-if="editingId !== comment.uuid">
              <div>
                <p class="text-sm mt-0.5 whitespace-pre-wrap break-words" x-text="comment.body"></p>
                <!-- Actions (only for author) -->
                <template x-if="comment.author.id === currentUserId">
                  <div class="flex gap-1 mt-1">
                    <button type="button" class="btn btn-ghost btn-xs gap-1 text-base-content/50" @click="startEdit(comment)">
                      <i data-lucide="pencil" class="w-3 h-3"></i>
                      Edit
                    </button>
                    <button type="button" class="btn btn-ghost btn-xs gap-1 text-error/60" @click="deleteComment(comment.uuid)">
                      <i data-lucide="trash-2" class="w-3 h-3"></i>
                      Delete
                    </button>
                  </div>
                </template>
              </div>
            </template>

            <template x-if="editingId === comment.uuid">
              <div class="mt-1 space-y-2">
                <textarea
                  class="textarea textarea-bordered textarea-sm w-full"
                  rows="2"
                  x-model="editBody"
                  @keydown.ctrl.enter="saveEdit(comment.uuid)"
                  @keydown.meta.enter="saveEdit(comment.uuid)"
                  @keydown.escape="cancelEdit()"
                ></textarea>
                <div class="flex gap-1">
                  <button type="button" class="btn btn-primary btn-xs" @click="saveEdit(comment.uuid)">Save</button>
                  <button type="button" class="btn btn-ghost btn-xs" @click="cancelEdit()">Cancel</button>
                </div>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>

    <!-- Add comment form -->
    <div class="pt-2 border-t border-base-300 space-y-2">
      <textarea
        class="textarea textarea-bordered textarea-sm w-full"
        rows="2"
        placeholder="Add a comment..."
        x-model="newBody"
        @keydown.ctrl.enter="addComment()"
        @keydown.meta.enter="addComment()"
      ></textarea>
      <div class="flex justify-end">
        <button
          type="button"
          class="btn btn-primary btn-xs gap-1"
          :disabled="!newBody.trim() || sending"
          @click="addComment()"
        >
          <i data-lucide="send" class="w-3 h-3" x-show="!sending"></i>
          <span class="loading loading-spinner loading-xs" x-show="sending"></span>
          Send
        </button>
      </div>
    </div>
  </div>

  <!-- Advanced (UUID) -->
  <details class="group">
    <summary class="flex items-center justify-between cursor-pointer text-xs text-base-content/40 hover:text-base-content/60 transition-colors list-none">
      <span>Advanced</span>
      <i data-lucide="chevron-down" class="w-3.5 h-3.5 transition-transform group-open:rotate-180"></i>
    </summary>
    <div class="pt-2">
      <div class="text-xs">
        <span class="text-base-content/60">UUID</span>
        <code class="block mt-1 text-xs bg-base-200 px-2 py-1 rounded select-all break-all">{{ file.uuid }}</code>
      </div>
    </div>
  </details>
</div>
