<!-- Properties Modal -->
<div x-data="propertiesModal()">
  <dialog
    x-ref="dialog"
    class="modal"
    @close="close()"
  >
    <div class="modal-box max-w-lg">
      <!-- Header -->
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-bold text-lg flex items-center gap-2">
          <i :data-lucide="nodeType === 'folder' ? 'folder' : 'file'" class="w-5 h-5"></i>
          <span>Properties</span>
        </h3>
        <button
          type="button"
          class="btn btn-ghost btn-sm btn-square"
          @click="close()"
        >
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <!-- Loading State -->
      <div x-show="loading" class="flex items-center justify-center py-8">
        <span class="loading loading-spinner loading-lg"></span>
      </div>

      <!-- Error State -->
      <div x-show="error && !loading" class="alert alert-error" x-cloak>
        <i data-lucide="alert-circle" class="w-5 h-5"></i>
        <span x-text="error"></span>
      </div>

      <!-- Content -->
      <div x-ref="content" x-show="!loading && !error" x-cloak>
        <!-- Content loaded via AJAX -->
      </div>

      <!-- Footer -->
      <div class="modal-action" x-show="!loading && !error" x-cloak>
        <button type="button" class="btn btn-sm" @click="close()">Close</button>
      </div>
    </div>

    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <script>
    function propertiesModal() {
      return {
        loading: false,
        error: null,
        nodeUuid: null,
        nodeType: 'file',

        async openProperties(uuid, nodeType) {
          this.nodeUuid = uuid;
          this.nodeType = nodeType || 'file';
          this.error = null;
          this.loading = true;

          this.$refs.content.replaceChildren();
          this.$refs.dialog.showModal();

          try {
            const response = await fetch(`/files/properties/${uuid}`);
            if (!response.ok) {
              throw new Error('Failed to load properties');
            }

            const html = await response.text();

            // Parse and insert content
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newContent = Array.from(doc.body.children);
            this.$refs.content.replaceChildren(...newContent);

            // Reinitialize icons
            this.$nextTick(() => {
              if (typeof lucide !== 'undefined') {
                lucide.createIcons();
              }
            });
          } catch (err) {
            this.error = err.message;
          } finally {
            this.loading = false;
          }
        },

        close() {
          this.$refs.dialog.close();
          this.nodeUuid = null;
          this.error = null;
          this.$refs.content.replaceChildren();
        },

        init() {
          // Listen for open-properties event
          window.addEventListener('open-properties', (e) => {
            const { uuid, nodeType } = e.detail;
            this.openProperties(uuid, nodeType);
          });
        }
      };
    }
  </script>
</div>
