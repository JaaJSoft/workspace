<!-- Markdown WYSIWYG Editor with Milkdown Crepe -->
<div class="flex flex-col h-full"
     x-data="markdownViewerCrepe()"
     x-init="initEditor()"
     @viewer-cleanup.window="dispose()">

  <!-- Toolbar -->
  <div class="flex items-center justify-between gap-1 px-3 py-1.5 bg-base-100 border-b border-base-300">
    <div class="flex items-center gap-2 min-w-0">
      <span class="badge badge-sm badge-ghost font-mono">markdown</span>
      {% if can_edit %}
      <span x-show="isDirty" x-cloak class="flex items-center gap-1 text-warning text-xs whitespace-nowrap">
        <span class="w-1.5 h-1.5 rounded-full bg-warning inline-block"></span>
        Modified
      </span>
      {% endif %}
    </div>
    {% if can_edit %}
    <div class="flex items-center gap-0.5">
      <!-- Save -->
      <button type="button"
              class="btn btn-primary btn-xs"
              :disabled="!isDirty || saving"
              @click="save()"
              title="Save (Ctrl+S)">
        <span x-show="saving" class="loading loading-spinner loading-xs"></span>
        <i x-show="!saving" data-lucide="save" class="w-3.5 h-3.5"></i>
        Save
      </button>
    </div>
    {% endif %}
  </div>

  <!-- Lock banner -->
  <div x-show="lockOwner" x-cloak
       class="flex items-center gap-2 px-3 py-2 bg-warning/10 border-b border-warning/30 text-warning-content text-sm">
    <i data-lucide="lock" class="w-4 h-4 text-warning shrink-0"></i>
    <span class="flex-1"><strong x-text="lockOwner"></strong> is editing this file</span>
    <button type="button" class="btn btn-warning btn-xs" @click="forceUnlock()">Force unlock</button>
  </div>

  <!-- Loading State -->
  <div x-show="loading" class="flex-1 flex items-center justify-center" x-cloak>
    <span class="loading loading-spinner loading-lg"></span>
  </div>

  <!-- Error State -->
  <div x-show="!loading && error" class="flex-1 flex items-center justify-center p-8" x-cloak>
    <div class="text-center">
      <i data-lucide="alert-circle" class="w-12 h-12 text-error mx-auto mb-4"></i>
      <p class="text-lg font-medium mb-2">Failed to load editor</p>
      <p class="text-sm text-base-content/60" x-text="error"></p>
    </div>
  </div>

  <!-- Milkdown Crepe Container -->
  <div x-ref="crepeContainer"
       x-show="!loading && !error"
       class="flex-1 min-h-0 overflow-auto flex flex-col"
       x-cloak></div>
</div>

<script>
window.markdownViewerCrepe = function() {
  // Keep complex objects OUT of Alpine's reactive scope
  let _crepe = null;
  let _keydownHandler = null;
  let _container = null;
  let _lock = null;

  function getCSRFToken() {
    var match = document.cookie.split('; ').find(function(row) { return row.startsWith('csrftoken='); });
    return match ? match.split('=')[1] : '';
  }

  function _attachEditHandlers(self, container) {
    _crepe.on(function(listener) {
      listener.markdownUpdated(function(md) {
        self.isDirty = md !== self.originalContent;
      });
    });
    if (!_keydownHandler) {
      _keydownHandler = function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          e.preventDefault();
          self.save();
        }
      };
      container.addEventListener('keydown', _keydownHandler, true);
    }
  }

  return {
    canEdit: {{ can_edit|yesno:'true,false' }},
    isDirty: false,
    saving: false,
    loading: true,
    error: null,
    originalContent: '{{ content|escapejs }}',
    fileUuid: '{{ file.uuid }}',
    fileName: '{{ file.name }}',
    lockOwner: {% if lock_info %}'{{ lock_info.locked_by_username|escapejs }}'{% else %}null{% endif %},

    async initEditor() {
      var container = this.$refs.crepeContainer;
      var self = this;
      _container = container;
      _lock = window.fileLock(this.fileUuid, getCSRFToken);

      try {
        var mod = await import('https://esm.sh/@milkdown/crepe@7.17.3?bundle');
        var Crepe = mod.Crepe;

        _crepe = new Crepe({ root: container, defaultValue: self.originalContent });
        await _crepe.create();

        if (!self.canEdit || self.lockOwner) {
          _crepe.setReadonly(true);
        }

        self.originalContent = _crepe.getMarkdown();

        if (self.canEdit && !self.lockOwner) {
          _attachEditHandlers(self, container);
        }

        self.loading = false;

        if (self.canEdit && !self.lockOwner) {
          _lock.acquire(self, {
            onLocked: function() { if (_crepe) _crepe.setReadonly(true); },
          });
        }
      } catch (err) {
        console.error('Failed to load Milkdown:', err);
        self.error = err.message || 'Failed to load editor';
        self.loading = false;
      }
    },

    forceUnlock() {
      var self = this;
      _lock.forceUnlock(self, {
        onAcquired: function() {
          if (_crepe) {
            _crepe.setReadonly(false);
            _attachEditHandlers(self, _container);
          }
        },
      });
    },

    async save() {
      if (!_crepe || this.saving || !this.isDirty) return;
      this.saving = true;

      try {
        var content = _crepe.getMarkdown();
        var blob = new Blob([content], { type: 'text/markdown' });
        var formData = new FormData();
        formData.append('content', blob, this.fileName || 'file.md');

        var response = await fetch('/api/v1/files/' + this.fileUuid, {
          method: 'PATCH',
          headers: { 'X-CSRFToken': getCSRFToken() },
          body: formData,
        });

        if (!response.ok) throw new Error('Failed to save');

        this.originalContent = content;
        this.isDirty = false;

        if (window.AppAlert) {
          window.AppAlert.success('File saved successfully');
        }
      } catch (error) {
        console.error('Failed to save:', error);
        if (window.AppAlert) {
          window.AppAlert.error('Failed to save: ' + error.message);
        }
      } finally {
        this.saving = false;
      }
    },

    dispose() {
      if (_lock) _lock.dispose();
      if (_keydownHandler && _container) {
        _container.removeEventListener('keydown', _keydownHandler, true);
        _keydownHandler = null;
        _container = null;
      }
      if (_crepe) {
        _crepe.destroy();
        _crepe = null;
      }
    },
  };
};
</script>
