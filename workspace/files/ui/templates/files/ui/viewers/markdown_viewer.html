<!-- Markdown Viewer/Editor -->
<div class="flex flex-col h-full" id="md-viewer-{{ file.uuid }}">

  <!-- Toolbar -->
  <div class="flex items-center justify-between gap-2 p-4 bg-base-100 border-b border-base-300">
    <div id="md-edit-info-{{ file.uuid }}" style="display:none" class="flex items-center gap-2">
      <i data-lucide="info" class="w-4 h-4 text-info"></i>
      <span class="text-sm">Editing mode – Press Ctrl+S to save or ESC to cancel</span>
    </div>
    <div id="md-view-spacer-{{ file.uuid }}" class="flex-1"></div>
    <div class="flex gap-2">
      <button id="md-btn-edit-{{ file.uuid }}" type="button" class="btn btn-sm btn-ghost" title="Edit file">
        <i data-lucide="pencil" class="w-4 h-4"></i>
        Edit
      </button>
      <button id="md-btn-cancel-{{ file.uuid }}" type="button" class="btn btn-sm btn-ghost" style="display:none">
        <i data-lucide="x" class="w-4 h-4"></i>
        Cancel
      </button>
      <button id="md-btn-save-{{ file.uuid }}" type="button" class="btn btn-sm btn-primary" style="display:none">
        <i data-lucide="save" class="w-4 h-4"></i>
        Save
      </button>
    </div>
  </div>

  <!-- Rendered Markdown (view mode) -->
  <div id="md-rendered-{{ file.uuid }}"
       class="flex-1 overflow-auto bg-base-100">
    <div class="prose prose-sm sm:prose lg:prose-lg max-w-3xl mx-auto p-6 md:py-10 md:px-8">
      {{ rendered_html|safe }}
    </div>
  </div>

  <!-- Raw Markdown (edit mode) -->
  <div id="md-editor-wrap-{{ file.uuid }}" class="flex-1 flex justify-center overflow-auto bg-base-100" style="display:none">
    <textarea
      id="md-editor-{{ file.uuid }}"
      class="textarea w-full max-w-3xl h-full font-mono text-sm text-base-content bg-base-100 border-none focus:outline-none resize-none p-6 md:py-10 md:px-8"
      spellcheck="false"
    >{{ content }}</textarea>
  </div>
</div>

<script>
(function() {
  var FILE_UUID = '{{ file.uuid }}';
  var saving = false;
  var editing = false;

  function $(id) { return document.getElementById(id); }

  function initViewer() {
    var root = $('md-viewer-' + FILE_UUID);
    if (!root) return false;

    var rendered   = $('md-rendered-'    + FILE_UUID);
    var editorWrap = $('md-editor-wrap-' + FILE_UUID);
    var editor     = $('md-editor-'      + FILE_UUID);
    var btnEdit    = $('md-btn-edit-'    + FILE_UUID);
    var btnCancel  = $('md-btn-cancel-'  + FILE_UUID);
    var btnSave    = $('md-btn-save-'    + FILE_UUID);
    var editInfo   = $('md-edit-info-'   + FILE_UUID);
    var viewSpacer = $('md-view-spacer-' + FILE_UUID);

    if (typeof lucide !== 'undefined') lucide.createIcons({ nodes: [root] });

    function setEditMode(on) {
      editing = on;
      rendered.style.display   = on ? 'none' : '';
      editorWrap.style.display = on ? ''     : 'none';
      btnEdit.style.display    = on ? 'none' : '';
      btnCancel.style.display  = on ? ''     : 'none';
      btnSave.style.display    = on ? ''     : 'none';
      editInfo.style.display   = on ? ''     : 'none';
      viewSpacer.style.display = on ? 'none' : '';
      if (on) editor.focus();
    }

    btnEdit.addEventListener('click', function()   { setEditMode(true); });
    btnCancel.addEventListener('click', function()  { editor.value = editor.defaultValue; setEditMode(false); });
    btnSave.addEventListener('click', function()    { save(); });

    function handleKeydown(e) {
      if (!editing) return;
      if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); save(); }
      if (e.key === 'Escape') { e.preventDefault(); editor.value = editor.defaultValue; setEditMode(false); }
    }
    window.addEventListener('keydown', handleKeydown);

    // Cleanup on removal
    var obs = new MutationObserver(function(muts) {
      for (var i = 0; i < muts.length; i++) {
        var removed = muts[i].removedNodes;
        for (var j = 0; j < removed.length; j++) {
          if (removed[j] === root || (removed[j].contains && removed[j].contains(root))) {
            window.removeEventListener('keydown', handleKeydown);
            obs.disconnect();
            return;
          }
        }
      }
    });
    if (root.parentNode) obs.observe(root.parentNode, { childList: true, subtree: true });

    function save() {
      if (saving) return;
      saving = true;

      var content = editor.value;
      var blob = new Blob([content], { type: 'text/markdown' });
      var fd = new FormData();
      fd.append('content', blob, '{{ file.name|escapejs }}' || 'file.md');

      var cookie = document.cookie.split('; ').find(function(r) { return r.startsWith('csrftoken='); });
      var csrf = cookie ? cookie.split('=')[1] : '';

      fetch('/api/v1/files/' + FILE_UUID, { method: 'PATCH', headers: { 'X-CSRFToken': csrf }, body: fd })
        .then(function(res) {
          if (!res.ok) throw new Error('Failed to save');
          // Re-render server-side: fetch updated viewer HTML
          return fetch('/files/view/' + FILE_UUID);
        })
        .then(function(res) {
          if (!res.ok) throw new Error('Failed to reload');
          return res.text();
        })
        .then(function(html) {
          // Extract the rendered markdown from the response
          var tmp = document.createElement('div');
          tmp.innerHTML = html;
          var newRendered = tmp.querySelector('#md-rendered-' + FILE_UUID);
          if (newRendered) rendered.innerHTML = newRendered.innerHTML;
          editor.defaultValue = editor.value;
          setEditMode(false);
          if (window.AppAlert) window.AppAlert.success('File saved successfully');
        })
        .catch(function(err) {
          console.error('Failed to save:', err);
          if (window.AppAlert) window.AppAlert.error('Failed to save: ' + err.message);
        })
        .finally(function() { saving = false; });
    }

    return true;
  }

  // Script runs before HTML injection — wait for DOM
  if (!initViewer()) {
    setTimeout(function() {
      if (!initViewer()) setTimeout(initViewer, 500);
    }, 50);
  }
})();
</script>
