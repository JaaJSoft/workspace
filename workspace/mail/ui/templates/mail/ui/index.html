{% extends 'base_with_navbar.html' %}
{% load static %}

{% block title %}Mail - Workspace{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'mail/ui/css/mail.css' %}">
{% endblock %}

{% block navbar %}
{% include 'ui/partials/navbar.html' with navbar_full_width=True %}
{% endblock %}

{% block drawer_class %}drawer-open{% endblock %}
{% block drawer_id %}mail-drawer{% endblock %}

{% block main_class %}p-0 flex flex-col h-full overflow-hidden{% endblock %}

{% block drawer_attrs %}
x-data="mailApp()"
x-init="init()"
@keydown.window="handleKeydown($event)"
{% endblock %}

{% block drawer_sidebar %}
<div class="drawer-side z-40 h-full">
  <label for="mail-drawer" aria-label="close sidebar" class="drawer-overlay"></label>

  <!-- Sidebar -->
  <aside class="bg-base-200 h-full border-r border-base-300 flex flex-col transition-all duration-300"
         :class="collapsed ? 'w-16' : 'w-72'">
    <!-- Sidebar header -->
    <div class="border-b border-base-300 py-4 px-3">
      <div class="flex items-center" :class="collapsed ? 'justify-center' : 'justify-between'">
        <h2 class="text-xl font-semibold flex items-center gap-2" :class="collapsed ? '' : 'pl-2'">
          <i data-lucide="mail" class="w-6 h-6 text-warning"></i>
          <span x-show="!collapsed" x-transition>Mail</span>
        </h2>
        <button
          x-show="!collapsed" x-transition
          class="btn btn-ghost btn-sm btn-square mr-1 hover:text-warning"
          @click="showCompose()"
          title="Compose (C)"
        >
          <i data-lucide="plus" class="w-4 h-4"></i>
        </button>
      </div>
    </div>

    <!-- Folder list -->
    <div class="flex-1 overflow-y-auto py-2 px-3">
      {% include "mail/ui/partials/folder_list.html" %}
    </div>

    <!-- Compose button (collapsed) -->
    <div class="px-3 pb-2" x-show="collapsed" x-cloak>
      <ul class="menu p-0">
        {% include "ui/partials/drawer_item.html" with icon="plus" label="New" color="warning" onclick="showCompose()" tooltip="Compose" %}
      </ul>
    </div>

    <!-- Help button -->
    <div class="px-3 pb-2">
      <ul class="menu p-0">
        {% include "ui/partials/drawer_item.html" with icon="circle-help" label="Help" color="warning" onclick="document.getElementById('mail-help-dialog').showModal(); lucide?.createIcons()" tooltip="Help (?)" %}
      </ul>
    </div>

    <!-- Collapse toggle -->
    <div class="border-t border-base-300 py-4 px-3">
      <ul class="menu p-0" x-show="!isMobile()">
        {% include "ui/partials/drawer_item.html" with icon_binding="collapsed ? 'panel-left-open' : 'panel-left-close'" label="Collapse" color="warning" onclick="toggleCollapse()" title_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" aria_label_binding="collapsed ? 'Expand sidebar' : 'Collapse sidebar'" %}
      </ul>
    </div>
  </aside>
</div>
{% endblock %}

{% block content %}
<div class="h-full flex min-w-0 bg-base-100">
  <!-- Message list panel -->
  <div class="w-96 border-r border-base-300 flex flex-col min-h-0"
       :class="selectedMessage && isMobile() ? 'hidden' : ''"
       x-show="selectedFolder">
    {% include "mail/ui/partials/message_list.html" %}
  </div>

  <!-- Message detail panel -->
  <div class="flex-1 flex flex-col min-h-0 min-w-0"
       :class="!selectedMessage && isMobile() ? 'hidden' : ''">
    {% include "mail/ui/partials/message_detail.html" %}
  </div>

  <!-- Empty state (no folder selected) -->
  <div class="flex-1 flex items-center justify-center" x-show="!selectedFolder">
    <div class="text-center text-base-content/40">
      <i data-lucide="mail" class="w-16 h-16 mx-auto mb-4 opacity-30"></i>
      <p class="text-lg font-medium" x-show="accounts.length > 0">Select a folder to view messages</p>
      <template x-if="accounts.length === 0">
        <div>
          <p class="text-lg font-medium mb-2">No mail accounts configured</p>
          <p class="text-sm mb-4">Add a mail account to get started</p>
          <button class="btn btn-warning btn-sm" @click="showAddAccount()">
            <i data-lucide="plus" class="w-4 h-4"></i>
            Add Account
          </button>
        </div>
      </template>
    </div>
  </div>
</div>

<!-- Folder context menu -->
{% include "mail/ui/partials/folder_context_menu.html" %}

<!-- Message context menu -->
{% include "mail/ui/partials/message_context_menu.html" %}

<!-- Folder icon picker dialog -->
<dialog id="mail-folder-icon-dialog" class="modal">
  <div class="modal-box max-w-md"
       x-data="iconPicker(
         folderIconEdit.uuid,
         folderIconEdit.icon,
         folderIconEdit.color,
         '/api/v1/mail/folders/',
         function(icon, color) { onFolderIconSaved(icon, color); }
       )"
       x-effect="if (folderIconEdit.uuid) { uuid = folderIconEdit.uuid; selectedIcon = folderIconEdit.icon || 'folder'; selectedColor = folderIconEdit.color || 'text-warning'; $nextTick(() => updatePreviewIcon()); }">
    <h3 class="font-bold text-lg mb-1">Change folder icon</h3>
    <p class="text-sm text-base-content/50 mb-4" x-text="folderIconEdit.name"></p>

    <!-- Preview -->
    <div class="flex justify-center mb-4">
      <div class="w-14 h-14 flex items-center justify-center bg-base-200 rounded-xl" x-ref="previewIcon"
           x-init="$nextTick(() => updatePreviewIcon())">
      </div>
    </div>

    {% include "ui/partials/icon_picker.html" %}

    <div class="modal-action">
      <button type="button" class="btn btn-ghost btn-sm" @click="document.getElementById('mail-folder-icon-dialog').close()">Close</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<!-- Help dialog -->
{% include "mail/ui/partials/help_dialog.html" %}

<!-- Compose dialog -->
{% include "mail/ui/partials/compose_dialog.html" %}

<!-- Add account dialog -->
<dialog id="mail-add-account-dialog" class="modal">
  <div class="modal-box max-w-lg">
    <h3 class="font-bold text-lg mb-4">Add Mail Account</h3>
    <form @submit.prevent="addAccount()">
      <div class="grid grid-cols-1 gap-3">
        <label class="form-control w-full">
          <div class="label"><span class="label-text">Email address</span></div>
          <input type="email" x-model="newAccount.email" class="input input-bordered w-full input-sm" required />
        </label>
        <label class="form-control w-full">
          <div class="label"><span class="label-text">Display name</span></div>
          <input type="text" x-model="newAccount.display_name" class="input input-bordered w-full input-sm" />
        </label>
        <div class="divider text-xs my-1">IMAP (Incoming)</div>
        <div class="grid grid-cols-3 gap-2">
          <label class="form-control col-span-2">
            <div class="label"><span class="label-text">Host</span></div>
            <input type="text" x-model="newAccount.imap_host" class="input input-bordered w-full input-sm" required />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Port</span></div>
            <input type="number" x-model.number="newAccount.imap_port" class="input input-bordered w-full input-sm" />
          </label>
        </div>
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" x-model="newAccount.imap_use_ssl" class="toggle toggle-sm toggle-warning" />
          <span class="label-text">Use SSL</span>
        </label>
        <div class="divider text-xs my-1">SMTP (Outgoing)</div>
        <div class="grid grid-cols-3 gap-2">
          <label class="form-control col-span-2">
            <div class="label"><span class="label-text">Host</span></div>
            <input type="text" x-model="newAccount.smtp_host" class="input input-bordered w-full input-sm" required />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Port</span></div>
            <input type="number" x-model.number="newAccount.smtp_port" class="input input-bordered w-full input-sm" />
          </label>
        </div>
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" x-model="newAccount.smtp_use_tls" class="toggle toggle-sm toggle-warning" />
          <span class="label-text">Use STARTTLS</span>
        </label>
        <div class="divider text-xs my-1">Authentication</div>
        <label class="form-control w-full">
          <div class="label"><span class="label-text">Username</span></div>
          <input type="text" x-model="newAccount.username" class="input input-bordered w-full input-sm" required />
        </label>
        <label class="form-control w-full">
          <div class="label"><span class="label-text">Password</span></div>
          <input type="password" x-model="newAccount.password" class="input input-bordered w-full input-sm" required />
        </label>
      </div>
      <div id="account-error" class="mt-3" x-show="accountError" x-cloak>
        <div class="alert alert-error text-white text-sm">
          <i data-lucide="x-circle" class="w-4 h-4"></i>
          <span x-text="accountError"></span>
        </div>
      </div>
      <div class="modal-action">
        <button type="button" class="btn btn-ghost btn-sm" @click="closeAddAccount()">Cancel</button>
        <button type="submit" class="btn btn-warning btn-sm" :disabled="addingAccount">
          <span x-show="!addingAccount">Add Account</span>
          <span x-show="addingAccount" class="loading loading-spinner loading-xs"></span>
        </button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<!-- Edit account dialog -->
<dialog id="mail-edit-account-dialog" class="modal">
  <template x-if="editAccount">
  <div class="modal-box max-w-lg">
    <h3 class="font-bold text-lg mb-1">Edit Account</h3>
    <p class="text-sm text-base-content/50 mb-4" x-text="editAccount?.email"></p>
    <form @submit.prevent="saveAccount()">
      <div class="grid grid-cols-1 gap-3">
        <label class="form-control w-full">
          <div class="label"><span class="label-text">Display name</span></div>
          <input type="text" x-model="editAccount.display_name" class="input input-bordered w-full input-sm" />
        </label>
        <div class="divider text-xs my-1">IMAP (Incoming)</div>
        <div class="grid grid-cols-3 gap-2">
          <label class="form-control col-span-2">
            <div class="label"><span class="label-text">Host</span></div>
            <input type="text" x-model="editAccount.imap_host" class="input input-bordered w-full input-sm" required />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Port</span></div>
            <input type="number" x-model.number="editAccount.imap_port" class="input input-bordered w-full input-sm" />
          </label>
        </div>
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" x-model="editAccount.imap_use_ssl" class="toggle toggle-sm toggle-warning" />
          <span class="label-text">Use SSL</span>
        </label>
        <div class="divider text-xs my-1">SMTP (Outgoing)</div>
        <div class="grid grid-cols-3 gap-2">
          <label class="form-control col-span-2">
            <div class="label"><span class="label-text">Host</span></div>
            <input type="text" x-model="editAccount.smtp_host" class="input input-bordered w-full input-sm" required />
          </label>
          <label class="form-control">
            <div class="label"><span class="label-text">Port</span></div>
            <input type="number" x-model.number="editAccount.smtp_port" class="input input-bordered w-full input-sm" />
          </label>
        </div>
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" x-model="editAccount.smtp_use_tls" class="toggle toggle-sm toggle-warning" />
          <span class="label-text">Use STARTTLS</span>
        </label>
        <div class="divider text-xs my-1">Authentication</div>
        <label class="form-control w-full">
          <div class="label"><span class="label-text">Username</span></div>
          <input type="text" x-model="editAccount.username" class="input input-bordered w-full input-sm" required />
        </label>
        <label class="form-control w-full">
          <div class="label"><span class="label-text">Password</span><span class="label-text-alt text-base-content/40">Leave empty to keep current</span></div>
          <input type="password" x-model="editAccount.password" class="input input-bordered w-full input-sm" placeholder="••••••••" />
        </label>
      </div>
      <div class="mt-3" x-show="editAccountError" x-cloak>
        <div class="alert alert-error text-white text-sm">
          <i data-lucide="x-circle" class="w-4 h-4"></i>
          <span x-text="editAccountError"></span>
        </div>
      </div>
      <div class="modal-action">
        <button type="button" class="btn btn-ghost btn-sm" @click="closeEditAccount()">Cancel</button>
        <button type="submit" class="btn btn-warning btn-sm" :disabled="savingAccount">
          <span x-show="!savingAccount">Save</span>
          <span x-show="savingAccount" class="loading loading-spinner loading-xs"></span>
        </button>
      </div>
    </form>
  </div>
  </template>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>

<!-- Embedded data -->
<script id="accounts-data" type="application/json">{{ accounts_json|safe }}</script>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'mail/ui/js/mail.js' %}"></script>
{% endblock %}
