<!-- Compose email dialog -->
<dialog id="mail-compose-dialog" class="modal">
  <div class="modal-box max-w-2xl h-[80vh] flex flex-col p-0">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-base-300">
      <h3 class="font-semibold" x-text="compose.is_reply ? compose.subject : 'New Message'"></h3>
      <button type="button" class="btn btn-ghost btn-sm btn-circle" @click="closeCompose()">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>

    <!-- Compose form -->
    <form @submit.prevent="sendEmail()" class="flex flex-col flex-1 min-h-0"
          x-effect="compose.to.length, compose.subject, compose.body, compose.cc.length, compose.bcc.length; _scheduleDraftSave()">
      <!-- Fields -->
      <div class="px-4 pt-3 space-y-0">
        <!-- From -->
        <div class="flex items-center gap-3 py-1.5 border-b border-base-200">
          <label class="text-xs font-medium text-base-content/40 w-10 shrink-0">From</label>
          <select x-model="compose.account_id"
                  class="select select-ghost select-sm flex-1 focus:outline-none focus:bg-transparent" required>
            <template x-for="acc in accounts" :key="acc.uuid">
              <option :value="acc.uuid"
                      x-text="acc.display_name ? acc.display_name + ' <' + acc.email + '>' : acc.email"></option>
            </template>
          </select>
        </div>

        <!-- To -->
        <div class="flex items-start gap-3 py-1.5 border-b border-base-200">
          <label class="text-xs font-medium text-base-content/40 w-10 shrink-0 mt-1.5">To</label>
          <div class="flex-1 relative">
            <div class="flex flex-wrap items-center gap-1 min-h-[2rem]">
              <template x-for="(email, i) in compose.to" :key="'to-'+i">
                <span class="badge badge-sm gap-1 pr-0.5 bg-warning/10 text-warning border-warning/20">
                  <span x-text="email" class="max-w-40 truncate"></span>
                  <button type="button" class="opacity-60 hover:opacity-100 leading-none text-xs"
                          @click="removeTag('to', i)">&times;</button>
                </span>
              </template>
              <input type="text" x-model="_tagInput.to"
                     @keydown="handleTagKeydown($event, 'to')"
                     @paste="handleTagPaste($event, 'to')"
                     @blur="addTag('to', _tagInput.to)"
                     @input="_acSearch('to')"
                     autocomplete="off"
                     class="input input-ghost input-sm flex-1 min-w-[8rem] focus:outline-none focus:bg-transparent"
                     placeholder="recipient@example.com" />
            </div>
            {% include "mail/ui/partials/autocomplete_dropdown.html" with field="to" %}
          </div>
          <button type="button"
                  class="btn btn-ghost btn-xs text-base-content/40 hover:text-base-content mt-0.5"
                  x-show="!showCcBcc" @click="showCcBcc = true">
            Cc/Bcc
          </button>
        </div>

        <!-- Cc -->
        <div class="flex items-start gap-3 py-1.5 border-b border-base-200"
             x-show="showCcBcc" x-collapse>
          <label class="text-xs font-medium text-base-content/40 w-10 shrink-0 mt-1.5">Cc</label>
          <div class="flex-1 relative">
            <div class="flex flex-wrap items-center gap-1 min-h-[2rem]">
              <template x-for="(email, i) in compose.cc" :key="'cc-'+i">
                <span class="badge badge-sm gap-1 pr-0.5 bg-base-200 border-base-300">
                  <span x-text="email" class="max-w-40 truncate"></span>
                  <button type="button" class="opacity-60 hover:opacity-100 leading-none text-xs"
                          @click="removeTag('cc', i)">&times;</button>
                </span>
              </template>
              <input type="text" x-model="_tagInput.cc"
                     @keydown="handleTagKeydown($event, 'cc')"
                     @paste="handleTagPaste($event, 'cc')"
                     @blur="addTag('cc', _tagInput.cc)"
                     @input="_acSearch('cc')"
                     autocomplete="off"
                     class="input input-ghost input-sm flex-1 min-w-[8rem] focus:outline-none focus:bg-transparent"
                     placeholder="cc@example.com" />
            </div>
            {% include "mail/ui/partials/autocomplete_dropdown.html" with field="cc" %}
          </div>
        </div>

        <!-- Bcc -->
        <div class="flex items-start gap-3 py-1.5 border-b border-base-200"
             x-show="showCcBcc" x-collapse>
          <label class="text-xs font-medium text-base-content/40 w-10 shrink-0 mt-1.5">Bcc</label>
          <div class="flex-1 relative">
            <div class="flex flex-wrap items-center gap-1 min-h-[2rem]">
              <template x-for="(email, i) in compose.bcc" :key="'bcc-'+i">
                <span class="badge badge-sm gap-1 pr-0.5 bg-base-200 border-base-300">
                  <span x-text="email" class="max-w-40 truncate"></span>
                  <button type="button" class="opacity-60 hover:opacity-100 leading-none text-xs"
                          @click="removeTag('bcc', i)">&times;</button>
                </span>
              </template>
              <input type="text" x-model="_tagInput.bcc"
                     @keydown="handleTagKeydown($event, 'bcc')"
                     @paste="handleTagPaste($event, 'bcc')"
                     @blur="addTag('bcc', _tagInput.bcc)"
                     @input="_acSearch('bcc')"
                     autocomplete="off"
                     class="input input-ghost input-sm flex-1 min-w-[8rem] focus:outline-none focus:bg-transparent"
                     placeholder="bcc@example.com" />
            </div>
            {% include "mail/ui/partials/autocomplete_dropdown.html" with field="bcc" %}
          </div>
        </div>

        <!-- Subject -->
        <div class="flex items-center gap-3 py-1.5 border-b border-base-200">
          <label class="text-xs font-medium text-base-content/40 w-10 shrink-0">Subject</label>
          <input type="text" x-model="compose.subject"
                 class="input input-ghost input-sm flex-1 focus:outline-none focus:bg-transparent"
                 placeholder="Subject" />
        </div>
      </div>

      {% if ai_enabled %}
      <!-- AI Compose -->
      <div class="px-4 pt-2" x-show="showAICompose" x-collapse x-cloak>
        <div class="flex gap-2 items-end p-2 rounded-lg bg-secondary/5 border border-secondary/20">
          <div class="flex-1">
            <label class="text-xs font-semibold text-secondary flex items-center gap-1 mb-1">
              <i data-lucide="sparkles" class="w-3 h-3"></i> AI Assistant
            </label>
            <input type="text" x-model="aiComposePrompt" x-ref="aiComposeInput"
                   @keydown.enter.prevent="aiCompose()"
                   class="input input-sm input-bordered w-full"
                   placeholder="Describe what you want to write..." />
          </div>
          <button type="button" class="btn btn-secondary btn-sm"
                  @click="aiCompose()" :disabled="aiComposing || !aiComposePrompt.trim()">
            <span x-show="!aiComposing">Generate</span>
            <span x-show="aiComposing" class="loading loading-spinner loading-xs"></span>
          </button>
          <button type="button" class="btn btn-ghost btn-sm btn-square"
                  @click="showAICompose = false" title="Close">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
      {% endif %}

      <!-- Body -->
      <div class="flex-1 min-h-0 px-4 py-3">
        <textarea
          x-model="compose.body"
          class="w-full h-full text-sm leading-relaxed resize-none bg-transparent focus:outline-none"
          placeholder="Write your message..."
        ></textarea>
      </div>

      <!-- Attachments preview -->
      <div class="px-4 flex flex-wrap gap-2" x-show="compose.attachments.length > 0" x-cloak>
        <template x-for="(file, idx) in compose.attachments" :key="idx">
          <span class="badge badge-sm gap-1 pr-0.5 overflow-hidden">
            <i data-lucide="file" class="w-3 h-3 flex-shrink-0"></i>
            <span class="max-w-32 truncate" x-text="file.name"></span>
            <button type="button" class="opacity-60 hover:opacity-100 leading-none text-xs"
                    @click="compose.attachments.splice(idx, 1)">&times;</button>
          </span>
        </template>
      </div>

      <!-- Error -->
      <div x-show="compose.error" x-cloak class="px-4">
        <div class="alert alert-error text-sm py-2">
          <i data-lucide="alert-circle" class="w-4 h-4 shrink-0"></i>
          <span x-text="compose.error"></span>
        </div>
      </div>

      <!-- Footer -->
      <div class="flex items-center gap-2 p-4 border-t border-base-300">
        <button type="button" class="btn btn-ghost btn-sm btn-square text-error/60 hover:text-error"
                @click="closeCompose()" title="Discard">
          <i data-lucide="trash-2" class="w-4 h-4"></i>
        </button>

        <button type="button" class="btn btn-ghost btn-sm btn-square"
                @click="$refs.composeFileInput.click()" title="Attach files">
          <i data-lucide="paperclip" class="w-4 h-4"></i>
        </button>
        <input type="file" multiple x-ref="composeFileInput" class="hidden"
               @change="handleComposeFiles($event)" />

        {% if ai_enabled %}
        <button type="button" class="btn btn-ghost btn-sm btn-square"
                @click="showAICompose = !showAICompose; if (showAICompose) $nextTick(() => $refs.aiComposeInput?.focus())" title="Compose with AI">
          <i data-lucide="sparkles" class="w-4 h-4" :class="showAICompose ? 'text-secondary' : ''"></i>
        </button>
        {% endif %}

        <div class="flex-1"></div>

        <span class="text-xs text-base-content/40" x-cloak>
          <span x-show="compose.saving" class="inline-flex items-center gap-1">
            <span class="loading loading-spinner loading-xs"></span> Saving...
          </span>
          <span x-show="!compose.saving && compose.last_saved" x-text="'Draft saved'"></span>
        </span>

        <button type="submit" class="btn btn-warning btn-sm gap-2" :disabled="compose.sending">
          <span x-show="compose.sending" class="loading loading-spinner loading-xs" x-cloak></span>
          Send
          <i data-lucide="send" class="w-4 h-4" x-show="!compose.sending"></i>
        </button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop"><button>close</button></form>
</dialog>
