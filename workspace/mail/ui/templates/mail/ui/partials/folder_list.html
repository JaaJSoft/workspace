<!-- Folder list per account -->
<template x-for="account in accounts" :key="account.uuid">
  <div class="mb-2">
    <!-- Account header (expanded) -->
    <div class="flex items-center gap-2 px-2 py-1.5 cursor-pointer rounded-lg hover:bg-base-content/5"
         @click="toggleAccountExpanded(account.uuid)"
         x-show="!collapsed">
      <i :data-lucide="expandedAccounts[account.uuid] ? 'chevron-down' : 'chevron-right'"
         class="w-3.5 h-3.5 text-base-content/50 flex-shrink-0"
         x-show="!syncingAccounts[account.uuid]"></i>
      <span class="loading loading-spinner loading-xs text-warning flex-shrink-0"
            x-show="syncingAccounts[account.uuid]" x-cloak></span>
      <span class="text-sm font-medium truncate flex-1" x-text="account.display_name || account.email"></span>
      <button class="btn btn-ghost btn-xs btn-circle opacity-50 hover:opacity-100"
              @click.stop="openAccountContextMenu($event, account)">
        <i data-lucide="more-horizontal" class="w-3.5 h-3.5"></i>
      </button>
    </div>

    <!-- Folders (expanded â€” hierarchical tree) -->
    <div x-show="expandedAccounts[account.uuid] && !collapsed" x-collapse>
      <template x-for="node in getFlatFolderTree(account.uuid)" :key="node.folder.uuid + '-' + (node.folder.icon || '') + '-' + (node.folder.color || '')">
        <button
          class="flex items-center gap-2.5 w-full px-3 py-1.5 text-sm rounded-lg transition-colors"
          :style="node.depth > 0 ? `padding-left: ${0.75 + node.depth * 1}rem` : ''"
          :class="{
            'bg-warning/10 text-warning': selectedFolder?.uuid === node.folder.uuid && dragOverFolder?.uuid !== node.folder.uuid,
            'text-base-content/70 hover:bg-base-content/5 hover:text-warning': selectedFolder?.uuid !== node.folder.uuid && dragOverFolder?.uuid !== node.folder.uuid,
            'ring-2 ring-warning/50 ring-offset-1 bg-warning/10': dragOverFolder?.uuid === node.folder.uuid,
          }"
          @click="selectFolder(node.folder)"
          @contextmenu="openFolderContextMenu($event, node.folder)"
          @dragover.prevent="onFolderDragOver($event, node.folder)"
          @dragleave="onFolderDragLeave($event, node.folder)"
          @drop.prevent="onFolderDrop($event, node.folder)"
        >
          <span class="flex-shrink-0" :class="node.folder.color || ''">
            <i :data-lucide="node.folder.icon || folderIcon(node.folder.folder_type)" class="w-4 h-4"></i>
          </span>
          <span class="flex-1 text-left truncate" x-text="node.folder.display_name"></span>
          <span
            x-show="getSubtreeUnreadCount(node) > 0"
            class="badge badge-xs badge-warning"
            x-text="getSubtreeUnreadCount(node)"
          ></span>
          <!-- Expand/collapse toggle for parents -->
          <span class="flex-shrink-0 w-4 h-4 flex items-center justify-center"
                x-show="node.children.length > 0"
                @click.stop="toggleFolderExpanded(node.folder.name)">
            <i :data-lucide="(expandedFolders[node.folder.name] === undefined || expandedFolders[node.folder.name]) ? 'chevron-down' : 'chevron-right'"
               class="w-3 h-3 opacity-50 hover:opacity-100"></i>
          </span>
        </button>
      </template>
    </div>

    <!-- Folders (collapsed: icons only with tooltip) -->
    <div x-show="collapsed" x-cloak>
      <template x-for="folder in getFolders(account.uuid)" :key="'c-' + folder.uuid + '-' + (folder.icon || '') + '-' + (folder.color || '')">
        <button
          class="flex items-center justify-center w-10 h-10 mx-auto rounded-lg transition-colors"
          :class="{
            'bg-warning/10 text-warning': selectedFolder?.uuid === folder.uuid && dragOverFolder?.uuid !== folder.uuid,
            'text-base-content/70 hover:bg-base-content/5 hover:text-warning': selectedFolder?.uuid !== folder.uuid && dragOverFolder?.uuid !== folder.uuid,
            'ring-2 ring-warning/50 ring-offset-1 bg-warning/10': dragOverFolder?.uuid === folder.uuid,
          }"
          :title="folder.display_name"
          @click="selectFolder(folder)"
          @contextmenu="openFolderContextMenu($event, folder)"
          @dragover.prevent="onFolderDragOver($event, folder)"
          @dragleave="onFolderDragLeave($event, folder)"
          @drop.prevent="onFolderDrop($event, folder)"
        >
          <span :class="folder.color || ''">
            <i :data-lucide="folder.icon || folderIcon(folder.folder_type)" class="w-5 h-5"></i>
          </span>
        </button>
      </template>
    </div>
  </div>
</template>

<!-- Add account button (expanded) -->
<div class="mt-2 px-1" x-show="!collapsed">
  <button class="btn btn-ghost btn-sm btn-block justify-start text-base-content/50 hover:text-warning"
          @click="showAddAccount()">
    <i data-lucide="plus-circle" class="w-4 h-4"></i>
    Add account
  </button>
</div>
