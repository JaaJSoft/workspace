<!-- Folder list per account -->
<template x-for="account in accounts" :key="account.uuid">
  <div class="mb-2">
    <!-- Account header (expanded) -->
    <div class="flex items-center gap-2 px-2 py-1.5 cursor-pointer rounded-lg hover:bg-base-content/5"
         @click="toggleAccountExpanded(account.uuid)"
         x-show="!collapsed">
      <i :data-lucide="expandedAccounts[account.uuid] ? 'chevron-down' : 'chevron-right'"
         class="w-3.5 h-3.5 text-base-content/50 flex-shrink-0"
         x-show="!syncingAccounts[account.uuid]"></i>
      <span class="loading loading-spinner loading-xs text-warning flex-shrink-0"
            x-show="syncingAccounts[account.uuid]" x-cloak></span>
      <span class="text-sm font-medium truncate flex-1" x-text="account.display_name || account.email"></span>
      <div class="dropdown dropdown-end" @click.stop>
        <button class="btn btn-ghost btn-xs btn-circle opacity-50 hover:opacity-100" tabindex="0">
          <i data-lucide="more-horizontal" class="w-3.5 h-3.5"></i>
        </button>
        <ul tabindex="0" class="dropdown-content menu menu-sm bg-base-100 border border-base-300 rounded-lg shadow-lg z-50 w-40">
          <li><a @click="syncAccount(account.uuid)" :class="syncingAccounts[account.uuid] ? 'pointer-events-none opacity-50' : ''">
            <i data-lucide="refresh-cw" class="w-3.5 h-3.5" x-show="!syncingAccounts[account.uuid]"></i>
            <span class="loading loading-spinner loading-xs" x-show="syncingAccounts[account.uuid]" x-cloak></span>
            <span x-text="syncingAccounts[account.uuid] ? 'Syncing...' : 'Sync'"></span>
          </a></li>
          <li><a @click="showEditAccount(account)"><i data-lucide="settings" class="w-3.5 h-3.5"></i> Edit</a></li>
          <li><a @click="testAccount(account.uuid)"><i data-lucide="plug" class="w-3.5 h-3.5"></i> Test</a></li>
          <li><a @click="removeAccount(account.uuid)" class="text-error"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Remove</a></li>
        </ul>
      </div>
    </div>

    <!-- Folders (expanded) -->
    <div x-show="expandedAccounts[account.uuid] && !collapsed" x-collapse>
      <template x-for="folder in getFolders(account.uuid)" :key="folder.uuid + '-' + (folder.icon || '') + '-' + (folder.color || '')">
        <button
          class="flex items-center gap-2.5 w-full px-3 py-1.5 text-sm rounded-lg transition-colors"
          :class="{
            'bg-warning/10 text-warning': selectedFolder?.uuid === folder.uuid && dragOverFolder?.uuid !== folder.uuid,
            'text-base-content/70 hover:bg-base-content/5 hover:text-warning': selectedFolder?.uuid !== folder.uuid && dragOverFolder?.uuid !== folder.uuid,
            'ring-2 ring-warning/50 ring-offset-1 bg-warning/10': dragOverFolder?.uuid === folder.uuid,
          }"
          @click="selectFolder(folder)"
          @contextmenu="openFolderContextMenu($event, folder)"
          @dragover.prevent="onFolderDragOver($event, folder)"
          @dragleave="onFolderDragLeave($event, folder)"
          @drop.prevent="onFolderDrop($event, folder)"
        >
          <span class="flex-shrink-0" :class="folder.color || ''">
            <i :data-lucide="folder.icon || folderIcon(folder.folder_type)" class="w-4 h-4"></i>
          </span>
          <span class="flex-1 text-left truncate" x-text="folder.display_name"></span>
          <span
            x-show="folder.unread_count > 0"
            class="badge badge-xs badge-warning"
            x-text="folder.unread_count"
          ></span>
        </button>
      </template>
    </div>

    <!-- Folders (collapsed: icons only with tooltip) -->
    <div x-show="collapsed" x-cloak>
      <template x-for="folder in getFolders(account.uuid)" :key="'c-' + folder.uuid + '-' + (folder.icon || '') + '-' + (folder.color || '')">
        <button
          class="flex items-center justify-center w-10 h-10 mx-auto rounded-lg transition-colors"
          :class="{
            'bg-warning/10 text-warning': selectedFolder?.uuid === folder.uuid && dragOverFolder?.uuid !== folder.uuid,
            'text-base-content/70 hover:bg-base-content/5 hover:text-warning': selectedFolder?.uuid !== folder.uuid && dragOverFolder?.uuid !== folder.uuid,
            'ring-2 ring-warning/50 ring-offset-1 bg-warning/10': dragOverFolder?.uuid === folder.uuid,
          }"
          :title="folder.display_name"
          @click="selectFolder(folder)"
          @contextmenu="openFolderContextMenu($event, folder)"
          @dragover.prevent="onFolderDragOver($event, folder)"
          @dragleave="onFolderDragLeave($event, folder)"
          @drop.prevent="onFolderDrop($event, folder)"
        >
          <span :class="folder.color || ''">
            <i :data-lucide="folder.icon || folderIcon(folder.folder_type)" class="w-5 h-5"></i>
          </span>
        </button>
      </template>
    </div>
  </div>
</template>

<!-- Add account button (expanded) -->
<div class="mt-2 px-1" x-show="!collapsed">
  <button class="btn btn-ghost btn-sm btn-block justify-start text-base-content/50 hover:text-warning"
          @click="showAddAccount()">
    <i data-lucide="plus-circle" class="w-4 h-4"></i>
    Add account
  </button>
</div>
