<!-- Message Context Menu -->
<div
  x-show="msgCtx.open"
  x-cloak
  @click.outside="if (!moveMenuOpen) msgCtx.open = false"
  @keydown.escape.window="msgCtx.open = false; moveMenuOpen = false"
  class="fixed z-[100] shadow-xl bg-base-100 border border-base-300 rounded-lg w-52 p-1"
  :style="`top: ${msgCtx.y}px; left: ${msgCtx.x}px;`"
  id="message-context-menu"
>
  <ul class="menu menu-sm p-0">
    <li>
      <button type="button" class="gap-3 rounded" @click="msgCtxAction('reply')">
        <i data-lucide="reply" class="w-4 h-4"></i>
        <span>Reply</span>
      </button>
    </li>
    <li>
      <button type="button" class="gap-3 rounded" @click="msgCtxAction('reply_all')">
        <i data-lucide="reply-all" class="w-4 h-4"></i>
        <span>Reply all</span>
      </button>
    </li>
    <li>
      <button type="button" class="gap-3 rounded" @click="msgCtxAction('forward')">
        <i data-lucide="forward" class="w-4 h-4"></i>
        <span>Forward</span>
      </button>
    </li>
    <hr class="my-1 border-base-300" />
    <li>
      <button type="button" class="gap-3 rounded" @click="msgCtxAction('toggle_star')">
        <i data-lucide="star" class="w-4 h-4"></i>
        <span x-text="msgCtx.msg?.is_starred ? 'Unstar' : 'Star'"></span>
      </button>
    </li>
    <li>
      <button type="button" class="gap-3 rounded" @click="msgCtxAction('toggle_read')">
        <i data-lucide="mail" class="w-4 h-4" x-show="msgCtx.msg?.is_read"></i>
        <i data-lucide="mail-open" class="w-4 h-4" x-show="!msgCtx.msg?.is_read"></i>
        <span x-text="msgCtx.msg?.is_read ? 'Mark unread' : 'Mark read'"></span>
      </button>
    </li>
    <hr class="my-1 border-base-300" />
    <li @mouseenter="showMoveMenu($el)" @mouseleave="scheduleMoveMenuClose()">
      <button type="button" class="gap-3 rounded justify-between">
        <span class="flex items-center gap-3">
          <i data-lucide="folder-input" class="w-4 h-4"></i>
          <span>Move to</span>
        </span>
        <i data-lucide="chevron-right" class="w-3 h-3 opacity-50"></i>
      </button>
    </li>
    <hr class="my-1 border-base-300" />
    <li>
      <button type="button" class="gap-3 rounded text-error" @click="msgCtxAction('delete')">
        <i data-lucide="trash-2" class="w-4 h-4"></i>
        <span>Delete</span>
      </button>
    </li>
  </ul>
</div>

<!-- Move to submenu (fixed, positioned via JS) -->
<div
  x-show="moveMenuOpen"
  x-cloak
  @mouseenter="cancelMoveMenuClose()"
  @mouseleave="scheduleMoveMenuClose()"
  class="fixed z-[101] shadow-xl bg-base-100 border border-base-300 rounded-lg w-48 p-1"
  :style="`top: ${moveMenu.y}px; left: ${moveMenu.x}px;`"
  id="move-submenu"
>
  <ul class="menu menu-sm p-0">
    <template x-for="folder in getMoveTargetFolders(msgCtx.msg)" :key="folder.uuid">
      <li>
        <button type="button" class="gap-3 rounded" @click="moveMessages(selectedMessages.length > 0 && selectedMessages.includes(msgCtx.msg?.uuid) ? [...selectedMessages] : [msgCtx.msg?.uuid], folder); msgCtx.open = false; moveMenuOpen = false;">
          <i :data-lucide="folder.icon || folderIcon(folder.folder_type)" class="w-4 h-4"></i>
          <span x-text="folder.display_name"></span>
        </button>
      </li>
    </template>
    <li x-show="getMoveTargetFolders(msgCtx.msg).length === 0">
      <span class="text-base-content/40 text-xs px-3 py-1">No folders available</span>
    </li>
  </ul>
</div>
