<!-- Empty state: folder info -->
<div x-show="!selectedMessage && selectedFolder" class="flex-1 flex items-center justify-center">
  <div class="text-center max-w-xs">
    <!-- Folder icon -->
    <div class="mb-4">
      <span :class="selectedFolder?.color || 'text-warning'" class="opacity-60">
        <i :data-lucide="selectedFolder?.icon || folderIcon(selectedFolder?.folder_type)" class="w-16 h-16 mx-auto"></i>
      </span>
    </div>
    <!-- Folder name -->
    <h3 class="text-lg font-semibold mb-1" x-text="selectedFolder?.display_name"></h3>
    <!-- Account -->
    <p class="text-sm text-base-content/50 mb-4"
       x-text="accounts.find(a => a.uuid === selectedFolder?.account_id)?.display_name || accounts.find(a => a.uuid === selectedFolder?.account_id)?.email || ''"></p>
    <!-- Stats -->
    <div class="flex items-center justify-center gap-4 text-sm text-base-content/60">
      <span class="flex items-center gap-1.5">
        <i data-lucide="mail" class="w-4 h-4"></i>
        <span x-text="(selectedFolder?.message_count ?? 0) + ' message' + ((selectedFolder?.message_count ?? 0) !== 1 ? 's' : '')"></span>
      </span>
      <span class="flex items-center gap-1.5" x-show="selectedFolder?.unread_count > 0 && !['sent', 'drafts'].includes(selectedFolder?.folder_type)">
        <i data-lucide="circle-dot" class="w-4 h-4 text-warning"></i>
        <span class="text-warning" x-text="(selectedFolder?.unread_count ?? 0) + ' unread'"></span>
      </span>
    </div>
    <!-- Hint -->
    <p class="text-xs text-base-content/30 mt-6">Select a message to read</p>
    <p class="text-xs text-base-content/30 mt-1">Use <kbd class="kbd kbd-xs">j</kbd> / <kbd class="kbd kbd-xs">k</kbd> to navigate</p>
  </div>
</div>

<!-- Empty state: no folder, but has accounts -->
<div x-show="!selectedMessage && !selectedFolder && accounts.length > 0" class="flex-1 flex items-center justify-center">
  <div class="text-center text-base-content/40">
    <i data-lucide="mail-open" class="w-12 h-12 mx-auto mb-3 opacity-30"></i>
    <p class="text-sm">Select a message to read</p>
    <p class="text-xs mt-1">Use <kbd class="kbd kbd-xs">j</kbd> / <kbd class="kbd kbd-xs">k</kbd> to navigate</p>
  </div>
</div>

<!-- Message view -->
<template x-if="selectedMessage && messageDetail">
  <div class="flex flex-col h-full">
    <!-- Header -->
    <div class="px-4 py-3 border-b border-base-300 bg-base-100">
      <div class="flex items-center gap-2 mb-2">
        <!-- Back button (mobile) -->
        <button class="btn btn-ghost btn-sm btn-circle lg:hidden" @click="selectedMessage = null; messageDetail = null">
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
        </button>

        <h2 class="text-base font-semibold flex-1 min-w-0 truncate" x-text="messageDetail.subject || '(no subject)'"></h2>

        <!-- Actions -->
        <div class="flex items-center gap-0.5 flex-shrink-0">
          <span class="loading loading-spinner loading-xs text-warning mr-1" x-show="actionInProgress" x-cloak></span>
          <button class="btn btn-ghost btn-xs btn-square" @click="toggleStar(messageDetail)"
                  :disabled="actionInProgress"
                  :title="messageDetail.is_starred ? 'Unstar' : 'Star'">
            <i data-lucide="star" class="w-4 h-4" :class="messageDetail.is_starred ? 'text-warning fill-warning' : ''"></i>
          </button>
          <button class="btn btn-ghost btn-xs btn-square" @click="toggleRead(messageDetail)"
                  :disabled="actionInProgress"
                  :title="messageDetail.is_read ? 'Mark unread' : 'Mark read'">
            <i :data-lucide="messageDetail.is_read ? 'mail' : 'mail-open'" class="w-4 h-4"></i>
          </button>
          <button class="btn btn-ghost btn-xs btn-square" @click="replyTo(messageDetail)" title="Reply (R)">
            <i data-lucide="reply" class="w-4 h-4"></i>
          </button>
          <button class="btn btn-ghost btn-xs btn-square" @click="replyAll(messageDetail)" title="Reply all (A)">
            <i data-lucide="reply-all" class="w-4 h-4"></i>
          </button>
          <button class="btn btn-ghost btn-xs btn-square" @click="forwardMessage(messageDetail)" title="Forward (F)">
            <i data-lucide="forward" class="w-4 h-4"></i>
          </button>
          {% if ai_enabled %}
          <button class="btn btn-ghost btn-xs btn-square" @click="summarizeMessage(messageDetail)"
                  :disabled="actionInProgress || aiSummarizing" title="Summarize with AI">
            <span x-show="!aiSummarizing"><i data-lucide="sparkles" class="w-4 h-4"></i></span>
            <span x-show="aiSummarizing" class="loading loading-spinner loading-xs"></span>
          </button>
          {% endif %}
          <button class="btn btn-ghost btn-xs btn-square text-error" @click="deleteMessage(messageDetail)"
                  :disabled="actionInProgress" title="Delete">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </div>
      </div>

      <!-- From/To details -->
      <div class="text-sm space-y-1">
        <div class="flex items-center gap-2">
          <span class="text-base-content/50 w-10 text-right flex-shrink-0">From</span>
          <span class="inline-flex cursor-pointer hover:text-warning transition-colors"
                @mouseenter="window._mailCardShow($el, messageDetail.from_address)"
                @mouseleave="window._mailCardScheduleHide($el)">
            <span class="font-medium" x-text="cleanName(messageDetail.from_address?.name) || messageDetail.from_address?.email"></span>
            <span class="text-base-content/50 ml-1" x-show="messageDetail.from_address?.name"
                  x-text="'<' + messageDetail.from_address?.email + '>'"></span>
          </span>
        </div>
        <div class="flex items-start gap-2">
          <span class="text-base-content/50 w-10 text-right flex-shrink-0">To</span>
          <span class="flex-1 flex flex-wrap gap-x-1 text-base-content/80">
            <template x-for="(addr, i) in (messageDetail.to_addresses || [])" :key="i">
              <span>
                <span class="cursor-pointer hover:text-warning transition-colors"
                      @mouseenter="window._mailCardShow($el, addr)"
                      @mouseleave="window._mailCardScheduleHide($el)"
                      x-text="cleanName(addr.name) || addr.email"></span><span x-show="i < (messageDetail.to_addresses || []).length - 1">,</span>
              </span>
            </template>
          </span>
        </div>
        <template x-if="messageDetail.cc_addresses?.length">
          <div class="flex items-start gap-2">
            <span class="text-base-content/50 w-10 text-right flex-shrink-0">Cc</span>
            <span class="flex-1 flex flex-wrap gap-x-1 text-base-content/80">
              <template x-for="(addr, i) in messageDetail.cc_addresses" :key="i">
                <span>
                  <span class="cursor-pointer hover:text-warning transition-colors"
                        @mouseenter="window._mailCardShow($el, addr)"
                        @mouseleave="window._mailCardScheduleHide($el)"
                        x-text="cleanName(addr.name) || addr.email"></span><span x-show="i < messageDetail.cc_addresses.length - 1">,</span>
                </span>
              </template>
            </span>
          </div>
        </template>
        <div class="flex items-center gap-2">
          <span class="text-base-content/50 w-10 text-right flex-shrink-0">Date</span>
          <span class="text-base-content/80" x-text="formatFullDate(messageDetail.date)"></span>
        </div>
      </div>
    </div>

    <!-- Attachments bar -->
    <div x-show="messageDetail.attachments?.length > 0" x-cloak
         class="px-4 py-2 border-b border-base-300 bg-base-100/50 flex flex-wrap gap-2">
      <template x-for="att in messageDetail.attachments" :key="att.uuid">
        <div class="group/att relative flex items-center">
          <a :href="'/api/v1/mail/attachments/' + att.uuid"
             class="flex items-center gap-1.5 px-2 py-1 rounded-lg border border-base-300 bg-base-200 text-xs hover:bg-base-300 transition-colors"
             download>
            <i data-lucide="paperclip" class="w-3 h-3 flex-shrink-0"></i>
            <span class="truncate max-w-[10rem]" x-text="att.filename"></span>
            <span class="text-base-content/50 flex-shrink-0" x-text="formatSize(att.size)"></span>
          </a>
          <button class="btn btn-ghost btn-xs btn-square opacity-0 group-hover/att:opacity-100 transition-opacity ml-0.5"
                  title="Save to Files"
                  @click.prevent="saveAttachmentToFiles(att.uuid)">
            <i data-lucide="folder-down" class="w-3.5 h-3.5"></i>
          </button>
        </div>
      </template>
    </div>

    <!-- Body -->
    <div class="flex-1 overflow-y-auto p-4">
      <div x-show="loadingDetail" class="flex justify-center py-8">
        <span class="loading loading-spinner loading-md text-warning"></span>
      </div>

      <!-- AI Summary (inside scrollable area) -->
      <div x-show="aiSummary" x-cloak
           class="mb-4 p-3 rounded-lg bg-secondary/5 border border-secondary/20">
        <div class="flex items-center justify-between mb-2">
          <span class="flex items-center gap-1.5 text-xs font-semibold text-secondary">
            <i data-lucide="sparkles" class="w-3.5 h-3.5"></i>
            AI Summary
          </span>
          <button class="btn btn-ghost btn-xs btn-circle" @click="dismissSummary(messageDetail)" title="Delete summary">
            <i data-lucide="x" class="w-3 h-3"></i>
          </button>
        </div>
        <div class="text-sm prose prose-sm max-w-none" x-html="aiSummary"></div>
      </div>
      <template x-if="messageDetail.body_html">
        <div class="mail-body prose prose-sm max-w-none" x-html="messageDetail.body_html"></div>
      </template>
      <template x-if="!messageDetail.body_html && messageDetail.body_text">
        <pre class="mail-body-text whitespace-pre-wrap text-sm font-sans" x-text="messageDetail.body_text"></pre>
      </template>
    </div>
  </div>
</template>
