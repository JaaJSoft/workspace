{% extends 'base_with_navbar.html' %}
{% load avatar_tags %}

{% block title %}{{ profile_user.username }} · Workspace{% endblock %}

{% block body_class %}bg-base-100 min-h-screen{% endblock %}
{% block drawer_wrapper_class %}{% endblock %}
{% block drawer_content_class %}{% endblock %}
{% block main_layout_class %}{% endblock %}
{% block main_class %}container mx-auto p-4 max-w-4xl{% endblock %}

{% block content %}
<div class="py-6 space-y-6" x-data="{ now: Date.now() }">

  <!-- ── Profile hero ───────────────────────────────────── -->
  <div class="card bg-base-100 border border-base-300 shadow-sm overflow-hidden">
    <!-- Banner -->
    <div class="h-32 bg-gradient-to-br from-primary via-primary/80 to-secondary"></div>

    <!-- Content below banner -->
    <div class="px-6 pb-6">
      <!-- Avatar row -->
      <div class="flex items-start justify-between">
        {% if profile_user|has_avatar %}
        <div class="avatar -mt-14">
          <div class="w-24 h-24 rounded-full ring-4 ring-base-100 shadow-lg">
            <img src="/api/v1/users/{{ profile_user.id }}/avatar" alt="{{ profile_user.username }}" class="rounded-full object-cover" />
          </div>
        </div>
        {% else %}
        <div class="avatar placeholder -mt-14">
          <div class="w-24 h-24 text-3xl bg-neutral text-neutral-content rounded-full ring-4 ring-base-100 shadow-lg">
            <span>{{ profile_user.username|slice:":1"|upper }}</span>
          </div>
        </div>
        {% endif %}
        {% if is_own_profile %}
        <a href="{% url 'users_ui:settings' %}" class="btn btn-sm btn-ghost gap-2 text-base-content/60 hover:text-primary mt-3">
          <i data-lucide="settings" class="w-4 h-4"></i>
          Settings
        </a>
        {% endif %}
      </div>

      <!-- Identity -->
      <div class="mt-3">
        <div class="flex flex-wrap items-baseline gap-2">
          <h1 class="text-xl font-bold leading-none">{% if profile_user.first_name or profile_user.last_name %}{{ profile_user.first_name }} {{ profile_user.last_name }}{% else %}{{ profile_user.username }}{% endif %}</h1>
          {% if profile_user.is_superuser %}
            <span class="badge badge-error badge-sm font-medium gap-1">
              <i data-lucide="shield-check" class="w-3 h-3"></i>
              Superuser
            </span>
          {% elif profile_user.is_staff %}
            <span class="badge badge-warning badge-sm font-medium gap-1">
              <i data-lucide="shield" class="w-3 h-3"></i>
              Staff
            </span>
          {% else %}
            <span class="badge badge-info badge-sm font-medium gap-1">
              <i data-lucide="user" class="w-3 h-3"></i>
              Member
            </span>
          {% endif %}
        </div>
        <div class="flex flex-wrap items-center gap-x-4 gap-y-1 mt-1 text-sm text-base-content/60">
          <span class="flex items-center gap-1.5">
            <i data-lucide="at-sign" class="w-3.5 h-3.5"></i>
            {{ profile_user.username }}
          </span>
          {% if profile_user.email %}
          <span class="flex items-center gap-1.5">
            <i data-lucide="mail" class="w-3.5 h-3.5"></i>
            {{ profile_user.email }}
          </span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- ── Stat cards ─────────────────────────────────────── -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
    <!-- Member since -->
    <div class="card bg-base-100 border border-base-300 shadow-sm">
      <div class="card-body p-4 flex-row items-center gap-4">
        <div class="rounded-lg bg-primary/10 p-2.5">
          <i data-lucide="calendar" class="w-5 h-5 text-primary"></i>
        </div>
        <div>
          <div class="text-xs text-base-content/50 font-medium uppercase tracking-wide">Member since</div>
          <div class="font-semibold mt-0.5">{{ profile_user.date_joined|date:'M j, Y' }}</div>
        </div>
      </div>
    </div>

    <!-- Last login -->
    <div class="card bg-base-100 border border-base-300 shadow-sm">
      <div class="card-body p-4 flex-row items-center gap-4">
        <div class="rounded-lg bg-success/10 p-2.5">
          <i data-lucide="log-in" class="w-5 h-5 text-success"></i>
        </div>
        <div>
          <div class="text-xs text-base-content/50 font-medium uppercase tracking-wide">Last login</div>
          <div class="font-semibold mt-0.5">
            {% if profile_user.last_login %}
              <span x-text="timeAgo('{{ profile_user.last_login|date:'c' }}')"></span>
            {% else %}
              Never
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Role -->
    <div class="card bg-base-100 border border-base-300 shadow-sm">
      <div class="card-body p-4 flex-row items-center gap-4">
        <div class="rounded-lg bg-secondary/10 p-2.5">
          <i data-lucide="fingerprint" class="w-5 h-5 text-secondary"></i>
        </div>
        <div>
          <div class="text-xs text-base-content/50 font-medium uppercase tracking-wide">Role</div>
          <div class="font-semibold mt-0.5">
            {% if profile_user.is_superuser %}Superuser{% elif profile_user.is_staff %}Staff{% else %}Member{% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ── Details + Activity ─────────────────────────────── -->
  <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">

    <!-- Details card (3/5) -->
    <div class="lg:col-span-3 card bg-base-100 border border-base-300 shadow-sm">
      <div class="card-body">
        <h2 class="card-title text-base gap-2 mb-3">
          <i data-lucide="contact" class="w-5 h-5"></i>
          Details
        </h2>

        <div class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs text-base-content/50 font-medium uppercase tracking-wide">First name</div>
              <div class="mt-1 font-medium">{{ profile_user.first_name|default:"—" }}</div>
            </div>
            <div>
              <div class="text-xs text-base-content/50 font-medium uppercase tracking-wide">Last name</div>
              <div class="mt-1 font-medium">{{ profile_user.last_name|default:"—" }}</div>
            </div>
          </div>

          <div class="divider my-0"></div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs text-base-content/50 font-medium uppercase tracking-wide">Username</div>
              <div class="mt-1 font-medium">{{ profile_user.username }}</div>
            </div>
            <div>
              <div class="text-xs text-base-content/50 font-medium uppercase tracking-wide">Email</div>
              <div class="mt-1 font-medium">{{ profile_user.email|default:"—" }}</div>
            </div>
          </div>

          <div class="divider my-0"></div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-xs text-base-content/50 font-medium uppercase tracking-wide">Joined</div>
              <div class="mt-1 font-medium">{{ profile_user.date_joined|date:'N j, Y' }}</div>
            </div>
            <div>
              <div class="text-xs text-base-content/50 font-medium uppercase tracking-wide">Last login</div>
              <div class="mt-1 font-medium">{{ profile_user.last_login|date:'N j, Y, P'|default:"Never" }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Activity timeline (2/5) -->
    <div class="lg:col-span-2 card bg-base-100 border border-base-300 shadow-sm">
      <div class="card-body">
        <h2 class="card-title text-base gap-2 mb-3">
          <i data-lucide="activity" class="w-5 h-5"></i>
          Activity
        </h2>

        <!-- Timeline -->
        <div>
          <!-- Event: Last login -->
          {% if profile_user.last_login %}
          <div class="flex gap-4">
            <div class="flex flex-col items-center">
              <div class="w-4 h-4 rounded-full bg-success/20 border-2 border-success flex-shrink-0 mt-0.5"></div>
              <div class="flex-1 w-px bg-base-300 my-1"></div>
            </div>
            <div class="pb-5">
              <div class="font-medium text-sm">Last seen</div>
              <div class="text-xs text-base-content/50 mt-0.5">{{ profile_user.last_login|date:'N j, Y · g:i A' }}</div>
              <div class="text-xs text-base-content/40 mt-0.5" x-text="timeAgo('{{ profile_user.last_login|date:'c' }}')"></div>
            </div>
          </div>
          {% endif %}

          <!-- Event: Account created -->
          <div class="flex gap-4">
            <div class="flex flex-col items-center">
              <div class="w-4 h-4 rounded-full bg-primary/20 border-2 border-primary flex-shrink-0 mt-0.5"></div>
            </div>
            <div>
              <div class="font-medium text-sm">Account created</div>
              <div class="text-xs text-base-content/50 mt-0.5">{{ profile_user.date_joined|date:'N j, Y · g:i A' }}</div>
              <div class="text-xs text-base-content/40 mt-0.5" x-text="timeAgo('{{ profile_user.date_joined|date:'c' }}')"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  function timeAgo(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    if (seconds < 60) return 'just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return minutes + (minutes === 1 ? ' minute ago' : ' minutes ago');
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + (hours === 1 ? ' hour ago' : ' hours ago');
    const days = Math.floor(hours / 24);
    if (days < 30) return days + (days === 1 ? ' day ago' : ' days ago');
    const months = Math.floor(days / 30);
    if (months < 12) return months + (months === 1 ? ' month ago' : ' months ago');
    const years = Math.floor(months / 12);
    return years + (years === 1 ? ' year ago' : ' years ago');
  }
</script>
{% endblock %}
